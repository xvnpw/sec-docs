## Deep Security Analysis of Caddy Server

### 1. Objective, Scope, and Methodology

**Objective:**

The primary objective of this deep security analysis is to identify and evaluate potential security vulnerabilities within the Caddy Server application, based on its architectural design and component descriptions. This analysis aims to provide actionable, Caddy-specific mitigation strategies to enhance the security posture of deployments utilizing Caddy Server.  The focus will be on understanding the security implications of Caddy's key components and their interactions, leading to tailored recommendations for secure configuration and operation.

**Scope:**

This analysis is scoped to the Caddy Server project as described in the provided "Project Design Document: Caddy Server (Improved) Version 1.1".  The analysis will cover the following key components and aspects:

*   **Core Components:** Caddy Core, Configuration Loader & Manager, HTTP/S Server, TLS/HTTPS Module, Reverse Proxy Module, File Server Module, Logging & Metrics Module, Plugin/Module System & API, Process Manager.
*   **Storage & External Services:** Configuration Storage, ACME Certificate Storage, Backend Services (as they interact with Caddy), ACME Provider.
*   **Data Flow:** Analysis of request processing and data handling within Caddy.
*   **Technology Stack:** Consideration of the underlying technologies and their security implications.
*   **Security Considerations outlined in Section 6 of the Design Document:**  Using these categories as a framework for analysis.

This analysis will **not** include:

*   Source code review of the Caddy codebase.
*   Penetration testing or vulnerability scanning of a live Caddy instance.
*   Analysis of specific third-party plugins (unless general plugin security considerations).
*   Operating system level security configurations.
*   Network infrastructure security surrounding Caddy.

**Methodology:**

This deep analysis will employ a structured approach based on the provided design document and cybersecurity best practices:

1.  **Document Review:** Thorough review of the "Project Design Document" to understand Caddy's architecture, components, data flow, and intended security features.
2.  **Component-Based Analysis:**  Each key component identified in the design document will be analyzed individually to identify potential security implications based on its functionality, inputs, outputs, and interactions with other components.
3.  **Threat Modeling Principles:**  Applying threat modeling principles to identify potential threats and vulnerabilities associated with each component and the overall system. This will involve considering threat categories like confidentiality, integrity, and availability.
4.  **Security Consideration Mapping:**  Mapping the identified threats and vulnerabilities to the security considerations outlined in Section 6 of the design document to ensure comprehensive coverage.
5.  **Mitigation Strategy Development:**  For each identified threat, develop specific, actionable, and Caddy-tailored mitigation strategies. These strategies will focus on leveraging Caddy's features and configurations to enhance security.
6.  **Documentation and Reporting:**  Document the analysis process, findings, identified threats, and recommended mitigation strategies in a clear and structured manner.

This methodology will ensure a systematic and focused security analysis of Caddy Server based on the provided design documentation, leading to practical and relevant security recommendations.

### 2. Security Implications of Key Components and Mitigation Strategies

**A. Caddy Core:**

*   **Security Implications:**
    *   **Core Vulnerabilities:** Bugs in the Caddy Core itself could have widespread impact, affecting all deployments.
    *   **Plugin Loading and Management Issues:**  Improper handling of plugin loading or management could lead to vulnerabilities if malicious or flawed plugins are loaded.
    *   **Process Management Flaws:**  Vulnerabilities in process management (graceful reloads, signal handling) could lead to DoS or privilege escalation.
*   **Threats:**
    *   Exploitation of core vulnerabilities for remote code execution or DoS.
    *   Loading of malicious plugins compromising the entire server.
    *   Process manipulation leading to service disruption.
*   **Mitigation Strategies:**
    *   **Keep Caddy Core Updated:** Regularly update Caddy to the latest stable version to patch known vulnerabilities. Utilize automated update mechanisms if feasible.
    *   **Plugin Vetting and Auditing:**  Implement a strict plugin vetting process. Only use plugins from trusted and reputable sources. Consider security audits for critical plugins.
    *   **Resource Limits:** Configure resource limits (CPU, memory) for the Caddy process to mitigate potential DoS attacks targeting core resource consumption.
    *   **Principle of Least Privilege:** Run Caddy processes with the minimum necessary privileges to limit the impact of potential compromises.

**B. Configuration Loader & Manager:**

*   **Security Implications:**
    *   **Configuration Parsing Vulnerabilities:**  Flaws in Caddyfile or JSON parsing could be exploited via crafted configuration files leading to unexpected behavior or code execution.
    *   **Misconfigurations:**  Human errors in configuration can introduce significant vulnerabilities (e.g., open proxies, directory traversal, insecure TLS).
    *   **Unauthorized Configuration Access/Modification:**  If configuration files are not properly protected, attackers could modify them to compromise the server.
    *   **Secrets Exposure in Configuration:**  Storing sensitive information directly in configuration files is a major security risk.
*   **Threats:**
    *   Remote code execution via crafted configuration files.
    *   Exposure of sensitive data or internal services due to misconfigurations.
    *   Service disruption or takeover through unauthorized configuration changes.
    *   Compromise of secrets leading to broader system compromise.
*   **Mitigation Strategies:**
    *   **Configuration Validation:** Utilize Caddy's built-in configuration validation features to catch syntax and semantic errors before applying configurations.
    *   **Secure Configuration Storage:**  Restrict file system permissions on configuration files to only allow authorized users (e.g., the Caddy process user and administrators) to read and write.
    *   **External Secrets Management:**  **Strongly recommend using environment variables or external secret management systems (like HashiCorp Vault, AWS Secrets Manager) to store sensitive information instead of embedding them directly in Caddyfile or JSON configurations.** Caddy supports environment variable expansion in configurations.
    *   **Configuration Version Control:**  Use version control systems (like Git) to track configuration changes, enabling audit trails and rollback capabilities.
    *   **Regular Configuration Reviews:**  Periodically review Caddy configurations to identify and rectify potential misconfigurations or security weaknesses.
    *   **Minimize Caddyfile Usage for Complex Setups:** For complex and security-critical setups, consider using JSON configuration for more programmatic control and potentially easier validation.

**C. HTTP/S Server:**

*   **Security Implications:**
    *   **HTTP Protocol Vulnerabilities:**  Exploitation of inherent HTTP protocol vulnerabilities (e.g., request smuggling, header injection).
    *   **DoS Attacks:**  Susceptible to various HTTP-based DoS attacks (e.g., slowloris, slow read, large request bodies).
    *   **Request Handling Flaws:**  Bugs in request parsing or handling logic could lead to vulnerabilities.
*   **Threats:**
    *   Bypassing security controls or injecting malicious requests via HTTP smuggling.
    *   Service unavailability due to DoS attacks.
    *   Unexpected behavior or crashes due to request handling vulnerabilities.
*   **Mitigation Strategies:**
    *   **Keep Caddy Updated:** Ensure Caddy and its underlying Go HTTP libraries are up-to-date to patch known HTTP vulnerabilities.
    *   **Rate Limiting:** **Implement rate limiting using Caddy's `rate_limit` directive to mitigate DoS attacks.** Configure appropriate limits based on expected traffic patterns.
    *   **Connection Limits:** **Use Caddy's `limits` directive to restrict the number of concurrent connections and requests to prevent resource exhaustion DoS attacks.**
    *   **Request Size Limits:** **Configure `request_body` limits in Caddy to prevent excessively large requests from consuming resources and potentially causing DoS.**
    *   **Timeout Configurations:**  Set appropriate timeouts for connections and request processing to prevent slowloris and similar attacks.
    *   **HTTP/3 Considerations:** While HTTP/3 offers performance benefits, be aware of potential emerging security considerations and ensure proper configuration and monitoring if enabling HTTP/3.

**D. TLS/HTTPS Module (ACME, Cert Management):**

*   **Security Implications:**
    *   **Weak TLS Configurations:**  Using outdated TLS versions or weak cipher suites weakens encryption and exposes to attacks.
    *   **Certificate Validation Issues:**  Failures in certificate validation could lead to MITM attacks.
    *   **Private Key Compromise:**  Exposure of private keys is catastrophic, allowing impersonation and decryption.
    *   **ACME Protocol Vulnerabilities:**  Exploits in ACME implementation could lead to unauthorized certificate issuance or denial of service.
    *   **Certificate Storage Security:**  Insecure storage of certificates and private keys.
*   **Threats:**
    *   MITM attacks due to weak TLS or certificate validation issues.
    *   Data breaches due to compromised private keys.
    *   Unauthorized certificate issuance or revocation leading to service disruption.
    *   Exposure of certificates and keys due to insecure storage.
*   **Mitigation Strategies:**
    *   **Strong TLS Configuration:** **Utilize Caddy's secure TLS defaults, which generally include strong cipher suites and disable weak protocols.**  **Explicitly configure `tls` directive to enforce TLS 1.2 or higher and strong cipher suites if necessary.**
    *   **HSTS Enforcement:** **Enable HSTS (HTTP Strict Transport Security) using Caddy's `header` directive to force browsers to always use HTTPS.**  Consider `max-age` and `includeSubDomains` parameters carefully.
    *   **OCSP Stapling:** **Caddy enables OCSP stapling by default, which is a good security practice. Ensure it remains enabled.**
    *   **Secure Certificate Storage:** **Caddy stores certificates and keys securely by default in platform-specific secure locations.**  For enhanced security, especially in clustered environments, **consider using pluggable certificate storage backends like key vaults (via plugins) for improved key management and access control.**
    *   **Regular Certificate Rotation:** While ACME automates renewal, understand the certificate lifecycle and consider strategies for key rotation if needed beyond automatic renewal.
    *   **ACME Provider Security:**  Choose reputable ACME providers like Let's Encrypt. Be aware of the security practices of your chosen provider.
    *   **Monitor Certificate Expiry:**  Implement monitoring to track certificate expiry and ensure timely renewals to avoid service disruptions and security warnings.

**E. Reverse Proxy Module (Load Balancer, Health Checks):**

*   **Security Implications:**
    *   **SSRF Vulnerabilities:**  Misconfigured proxy rules could allow SSRF attacks.
    *   **HTTP Request Smuggling:**  Vulnerabilities in handling requests between Caddy and backend servers.
    *   **Backend Vulnerability Exposure:**  Caddy might expose backend vulnerabilities if not configured carefully.
    *   **Open Proxy Risk:**  Accidental configuration as an open proxy.
    *   **Load Balancing Algorithm Weaknesses:**  Certain load balancing algorithms might have security implications in specific scenarios.
*   **Threats:**
    *   SSRF attacks allowing access to internal resources or external exploitation.
    *   HTTP smuggling leading to bypassed security controls or malicious request injection.
    *   Exposure of backend vulnerabilities to external attackers.
    *   Abuse of Caddy as an open proxy for malicious activities.
    *   Uneven load distribution potentially leading to DoS on specific backends.
*   **Mitigation Strategies:**
    *   **Strict Proxy Configuration:** **Carefully define proxy rules using Caddyfile or JSON.  Use path-based or host-based routing to restrict proxying to intended backend services only.** Avoid overly broad proxy configurations.
    *   **Input Validation and Sanitization:**  If possible, implement input validation and sanitization at the backend services. Caddy itself has limited input validation capabilities for proxied requests.
    *   **Header Manipulation Control:** **Use Caddy's `header_up` and `header_down` directives to carefully control headers forwarded to backend servers and returned to clients.** Remove or sanitize sensitive headers if necessary.
    *   **Connection Limits to Backends:**  Implement connection limits to backend servers to prevent resource exhaustion on backends due to excessive proxied requests.
    *   **Health Check Security:**  Ensure health checks are configured securely and do not inadvertently expose sensitive information or create vulnerabilities.
    *   **Avoid Open Proxy Configuration:**  **Explicitly configure `reverse_proxy` directives to target specific backend services. Do not configure a wildcard proxy that could act as an open proxy.**
    *   **Load Balancing Algorithm Selection:** Choose load balancing algorithms appropriate for the application and security context. Round-robin and least_conn are generally safe, but understand the implications of other algorithms.

**F. File Server Module (Static Content):**

*   **Security Implications:**
    *   **Directory Traversal:**  Vulnerabilities allowing access to files outside the intended document root.
    *   **Information Disclosure:**  Accidental exposure of sensitive files due to misconfiguration or directory listings.
    *   **DoS via File Requests:**  Attackers could request large files or many files to cause DoS.
*   **Threats:**
    *   Unauthorized access to sensitive files via directory traversal.
    *   Exposure of confidential information through directory listings or misconfigured file serving.
    *   Service disruption due to DoS attacks targeting file serving.
*   **Mitigation Strategies:**
    *   **Restrict Document Root:** **Carefully configure the `root` directive in Caddyfile or JSON to define the document root for file serving. Ensure it points to the intended directory and not a broader file system path.**
    *   **Disable Directory Listings in Production:** **Disable directory listings in production environments using the `browse off` directive in Caddyfile or JSON to prevent accidental information disclosure.** Enable it only for specific development or testing scenarios if needed.
    *   **File Access Controls:**  Ensure appropriate file system permissions are set on the document root and served files to restrict access to authorized users and processes.
    *   **Rate Limiting for Static Files:** **Consider applying rate limiting to static file requests using Caddy's `rate_limit` directive to mitigate DoS attacks targeting static content.**
    *   **File Size Limits:**  If serving very large files is not intended, consider implementing file size limits at the application level or using CDN solutions for large media files.
    *   **Content Security Policy (CSP):** **Implement CSP headers using Caddy's `header` directive to mitigate XSS risks if serving dynamic content alongside static files.**

**G. Logging & Metrics Module:**

*   **Security Implications:**
    *   **Sensitive Information in Logs:**  Accidental logging of sensitive data (passwords, API keys, personal data).
    *   **Insufficient Logging:**  Lack of logging hinders security monitoring and incident response.
    *   **Log Injection Vulnerabilities:**  Improper log sanitization could allow log injection attacks.
    *   **Log Storage Security:**  Insecure storage of logs could lead to unauthorized access or tampering.
*   **Threats:**
    *   Exposure of sensitive data through log files.
    *   Delayed incident detection and response due to insufficient logging.
    *   Log manipulation by attackers to cover tracks or inject false information.
    *   Unauthorized access to logs revealing sensitive operational details.
*   **Mitigation Strategies:**
    *   **Log Redaction:** **Configure Caddy's logging to redact sensitive information (e.g., using custom log formats or plugins that support redaction).** Avoid logging sensitive request headers or body data unless absolutely necessary and properly sanitized.
    *   **Comprehensive Logging:** **Enable logging for relevant events, including access logs, error logs, and security-related events.** Configure appropriate logging levels to capture sufficient detail without excessive verbosity.
    *   **Secure Log Storage:**  Store logs securely. Restrict access to log files to authorized personnel and systems. Consider using centralized logging systems with access controls and audit trails.
    *   **Log Rotation and Retention:**  Implement log rotation and retention policies to manage log file size and comply with security and compliance requirements.
    *   **Log Monitoring and Alerting:**  Integrate Caddy's logs with security monitoring and alerting systems (SIEM) to detect suspicious activities and security incidents in real-time.
    *   **Metrics Security:**  If exposing metrics endpoints (e.g., Prometheus), ensure access is restricted to authorized monitoring systems only. Avoid exposing sensitive metrics data publicly.

**H. Plugin/Module System & API:**

*   **Security Implications:**
    *   **Third-Party Plugin Vulnerabilities:**  Plugins may contain vulnerabilities that compromise Caddy.
    *   **Malicious Plugins:**  Risk of installing intentionally malicious plugins.
    *   **Plugin Isolation Issues:**  Lack of isolation could allow plugin vulnerabilities to affect the core server or other plugins.
    *   **API Security:**  Vulnerabilities in the plugin API could be exploited by malicious plugins.
*   **Threats:**
    *   Compromise of Caddy server due to vulnerabilities in third-party plugins.
    *   Data breaches, service disruption, or server takeover by malicious plugins.
    *   Cascading failures or security issues due to plugin isolation weaknesses.
    *   Exploitation of plugin API vulnerabilities for privilege escalation or other attacks.
*   **Mitigation Strategies:**
    *   **Strict Plugin Vetting:** **Implement a rigorous plugin vetting process before deploying any third-party plugins.** Evaluate plugin source code, security history, and community reputation.
    *   **Plugin Audits:**  Conduct security audits of plugins, especially those handling sensitive data or critical functionalities.
    *   **Principle of Least Privilege for Plugins:**  If possible, explore mechanisms to run plugins with reduced privileges to limit the impact of potential compromises. (Note: Caddy's plugin system might have limitations on isolation).
    *   **Plugin Dependency Management:**  Be aware of plugin dependencies and ensure they are also vetted and kept up-to-date.
    *   **Regular Plugin Updates:**  Keep plugins updated to the latest versions to patch known vulnerabilities.
    *   **Source Code Review (for critical plugins):** For highly critical plugins, consider performing source code reviews to identify potential security flaws before deployment.
    *   **Limit Plugin Usage:**  Minimize the number of plugins used to reduce the attack surface and complexity. Only install plugins that are absolutely necessary.

**I. Process Manager (Graceful Reloads):**

*   **Security Implications:**
    *   **Signal Handling Vulnerabilities:**  Flaws in signal handling could be exploited to cause DoS or unexpected behavior.
    *   **Graceful Reload Issues:**  Vulnerabilities in the graceful reload mechanism could lead to service disruption or temporary security weaknesses during reloads.
    *   **Privilege Escalation during Reloads:**  Improper handling of privileges during reloads could create opportunities for privilege escalation.
*   **Threats:**
    *   Service disruption due to signal handling vulnerabilities.
    *   Temporary vulnerabilities or DoS during graceful reloads.
    *   Privilege escalation attacks exploiting reload processes.
*   **Mitigation Strategies:**
    *   **Keep Caddy Updated:** Ensure Caddy is updated to patch any known vulnerabilities in process management and signal handling.
    *   **Minimize Reload Frequency:**  Reduce the frequency of configuration reloads to minimize potential windows of vulnerability during reload processes.
    *   **Monitor Reload Processes:**  Monitor reload processes for errors or unexpected behavior.
    *   **Secure Signal Handling:**  Ensure that signal handling mechanisms are robust and resistant to manipulation. (This is largely handled by Caddy core, but staying updated is key).
    *   **Principle of Least Privilege:** Running Caddy with minimal privileges reduces the impact of potential privilege escalation vulnerabilities during reloads.

**J. Configuration Storage (Filesystem, Config Providers) & K. ACME Certificate Storage (Filesystem, Key Vaults):**

*   **Security Implications:**
    *   **Unauthorized Access/Modification:**  Lack of access control to configuration and certificate storage.
    *   **Data Breach:**  Exposure of configuration files or private keys if storage is compromised.
    *   **Integrity Issues:**  Tampering with configuration or certificates could lead to service disruption or security breaches.
*   **Threats:**
    *   Unauthorized modification of configuration leading to service takeover.
    *   Compromise of private keys leading to MITM attacks and data breaches.
    *   Service disruption due to corrupted configuration or certificates.
*   **Mitigation Strategies:**
    *   **Secure File System Permissions:** **Restrict file system permissions on configuration files and certificate storage directories to only allow the Caddy process user and authorized administrators to access them.**
    *   **Encryption at Rest (for sensitive storage):**  For highly sensitive environments, consider encrypting configuration and certificate storage at rest using file system encryption or dedicated encryption solutions.
    *   **Pluggable Secure Storage Backends:** **Utilize Caddy's pluggable storage backends to integrate with secure storage solutions like key vaults (e.g., HashiCorp Vault, AWS KMS) for certificate and potentially configuration storage.** This provides enhanced access control, auditing, and key management.
    *   **Access Control Lists (ACLs):**  Implement ACLs on storage backends to further restrict access to configuration and certificates.
    *   **Regular Backups:**  Implement regular backups of configuration and certificate storage to ensure recoverability in case of data loss or corruption.
    *   **Audit Logging for Storage Access:**  Enable audit logging for access to configuration and certificate storage to track who accessed or modified these critical resources.

**L. Backend Services (Optional Application Servers) & M. ACME Provider (e.g., Let's Encrypt):**

*   **Security Implications (Backend Services):**
    *   **Backend Vulnerabilities:**  Vulnerabilities in backend services can be exposed through Caddy if not properly secured.
    *   **Data Breach via Backend:**  Compromise of backend services can lead to data breaches even if Caddy itself is secure.
    *   **DoS on Backends:**  Caddy misconfiguration or attacks targeting Caddy could lead to DoS on backend services.
*   **Security Implications (ACME Provider):**
    *   **ACME Provider Compromise:**  Compromise of the ACME provider could lead to unauthorized certificate issuance or revocation.
    *   **Reliance on External Service:**  Availability and security of Caddy's HTTPS functionality depends on the ACME provider's reliability and security.
*   **Threats (Backend Services):**
    *   Exploitation of backend vulnerabilities via Caddy proxying.
    *   Data breaches originating from compromised backend services.
    *   Service disruption of backends due to attacks through Caddy.
*   **Threats (ACME Provider):**
    *   Unauthorized certificate issuance or revocation by malicious actors compromising the ACME provider.
    *   Service unavailability if the ACME provider experiences outages.
*   **Mitigation Strategies (Backend Services):**
    *   **Backend Security Hardening:**  **Focus on securing backend services independently.** Apply security best practices to backend applications, databases, and APIs.
    *   **Network Segmentation:**  **Isolate backend services in a separate network segment from Caddy and the public internet.** Use firewalls to restrict access to backends only from Caddy.
    *   **Mutual TLS (mTLS) between Caddy and Backends:**  **Consider implementing mTLS between Caddy and backend services for enhanced authentication and encryption of traffic within the internal network.**
    *   **Regular Backend Security Audits and Penetration Testing:**  Conduct regular security assessments of backend services to identify and remediate vulnerabilities.
    *   **Input Validation and Output Encoding in Backends:**  Implement robust input validation and output encoding in backend applications to prevent injection vulnerabilities.
*   **Mitigation Strategies (ACME Provider):**
    *   **Choose Reputable ACME Providers:**  Select well-established and reputable ACME providers like Let's Encrypt.
    *   **ACME Account Security:**  Secure ACME account credentials and API keys if used.
    *   **Monitor Certificate Issuance:**  Monitor certificate issuance logs from the ACME provider for any suspicious or unauthorized activity.
    *   **Fallback Certificate Management:**  Have a fallback plan for certificate management in case of ACME provider outages or issues (e.g., manual certificate management or alternative ACME providers).

### 3. Actionable and Tailored Mitigation Strategies Summary

| Security Area                  | Threat                                                                 | Caddy-Specific Mitigation Strategy                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              