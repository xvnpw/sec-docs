## Deep Security Analysis of Apache Tomcat

### 1. Objective, Scope, and Methodology

**Objective:**

This deep security analysis aims to provide a thorough evaluation of the security posture of Apache Tomcat, focusing on its key components and functionalities as outlined in the provided Security Design Review. The objective is to identify potential security vulnerabilities and weaknesses inherent in Tomcat's architecture, configuration, and deployment, and to recommend specific, actionable mitigation strategies tailored to the project. This analysis will delve into the security implications of each component, considering the project's business and security posture, and ultimately contribute to enhancing the overall security of Tomcat deployments.

**Scope:**

The scope of this analysis encompasses the following key areas of Apache Tomcat, as depicted in the C4 Container diagram and described in the Security Design Review:

*   **Web Server Container:** Catalina Servlet Container, Jasper JSP Engine, Coyote HTTP Connector, Coyote AJP Connector.
*   **Configuration and Management:** Configuration Files, Logging System, Management Interface (Web), Management Interface (CLI).
*   **Deployment Considerations:** Standalone, Clustered, and Containerized Deployments (with a focus on Containerized Deployment with Kubernetes as detailed).
*   **Build Process:**  GitHub Actions based CI/CD pipeline, including SAST, Dependency Check, and Container Image Scanning.
*   **Security Requirements:** Authentication, Authorization, Input Validation, and Cryptography as defined in the Security Design Review.

The analysis will primarily focus on the security aspects of Tomcat itself and its immediate operational environment. Security considerations for web applications deployed on Tomcat, while acknowledged, will be addressed primarily in the context of how Tomcat can facilitate or hinder their security.

**Methodology:**

This deep analysis will employ the following methodology:

1.  **Document Review and Inference:**  A detailed review of the provided Security Design Review document, including business posture, security posture, C4 Context and Container diagrams, deployment options, build process, risk assessment, and questions/assumptions. We will infer the architecture, components, and data flow of Tomcat based on these descriptions and publicly available Apache Tomcat documentation.
2.  **Component-Based Security Analysis:** Each key component identified within the scope will be analyzed for potential security vulnerabilities and weaknesses. This will involve considering:
    *   **Functionality and Purpose:** Understanding the role of each component in the overall Tomcat architecture.
    *   **Attack Surface:** Identifying potential entry points and attack vectors associated with each component.
    *   **Known Vulnerabilities and Common Misconfigurations:**  Leveraging knowledge of common web server and servlet container vulnerabilities, as well as Tomcat-specific security issues and misconfiguration pitfalls.
    *   **Security Controls and Requirements:** Evaluating how existing and recommended security controls address the identified risks for each component, and assessing alignment with the defined security requirements.
3.  **Threat Modeling (Implicit):** While not explicitly creating a formal threat model, the analysis will implicitly consider potential threats relevant to each component and the overall Tomcat system. This will be guided by common web application and infrastructure attack patterns.
4.  **Tailored Recommendations and Mitigation Strategies:** Based on the identified security implications, specific and actionable recommendations and mitigation strategies will be formulated. These recommendations will be directly applicable to Apache Tomcat configurations, deployment practices, and development workflows, avoiding generic security advice.  The recommendations will be prioritized based on potential impact and feasibility of implementation.

### 2. Security Implications of Key Components

Based on the C4 Container diagram and descriptions, the following are the security implications for each key component of Apache Tomcat:

**2.1. Web Server Container Components:**

*   **Catalina Servlet Container:**
    *   **Security Implications:** As the core of Tomcat, Catalina handles request processing, servlet lifecycle, and security constraints. Vulnerabilities here can have widespread impact.
        *   **Servlet/Filter Vulnerabilities:**  Bugs in servlets or filters deployed within Catalina can be exploited for various attacks (XSS, injection, etc.). While not Tomcat's direct vulnerability, Catalina provides the execution environment and needs to enforce security boundaries.
        *   **Session Management Weaknesses:** Insecure session handling (e.g., predictable session IDs, session fixation) can lead to session hijacking and unauthorized access.
        *   **Security Constraint Bypasses:** Misconfigurations or vulnerabilities in security constraints (declarative or programmatic) could allow unauthorized access to protected resources.
        *   **Realm-Based Authentication Issues:** Weakly configured or vulnerable security realms can lead to authentication bypass or credential compromise.
    *   **Specific Recommendations:**
        *   **Regularly update Tomcat:** Ensure Catalina and all Tomcat components are updated to the latest versions to patch known vulnerabilities.
        *   **Enforce strong session management:** Configure secure session cookies (HTTPOnly, Secure flags), use strong session ID generation, and implement session timeout mechanisms.
        *   **Thoroughly review and test security constraints:**  Validate that security constraints are correctly defined and effectively protect intended resources.
        *   **Harden security realm configurations:** Choose robust authentication mechanisms (e.g., certificate-based, LDAP), enforce strong password policies where applicable, and regularly audit realm configurations.

*   **Jasper JSP Engine:**
    *   **Security Implications:** Jasper compiles JSPs into servlets. Vulnerabilities here can arise from JSP processing and compilation.
        *   **JSP Expression Language (EL) Injection:** Improper handling of user input within JSP EL expressions can lead to code injection vulnerabilities.
        *   **Insecure JSP Includes and Tag Libraries:**  Vulnerabilities in included JSP files or custom tag libraries can be exploited if not properly vetted.
        *   **Information Disclosure via JSP Errors:** Verbose error messages from JSP compilation or execution can reveal sensitive information about the application or server.
    *   **Specific Recommendations:**
        *   **Disable JSP compilation in production (if applicable):** If static content is primarily served, consider pre-compiling JSPs during build time and disabling JSP compilation in production to reduce attack surface.
        *   **Sanitize user input in JSP EL:**  Carefully validate and sanitize any user input used within JSP EL expressions to prevent injection attacks.
        *   **Securely manage JSP includes and tag libraries:**  Thoroughly review and trust included JSP files and tag libraries, ensuring they are from reputable sources and free of vulnerabilities.
        *   **Customize JSP error pages:** Configure custom error pages to avoid exposing sensitive information in error messages.

*   **Coyote HTTP Connector:**
    *   **Security Implications:** Coyote HTTP Connector handles HTTP/HTTPS requests. Security here is crucial for protecting web traffic.
        *   **TLS/SSL Misconfiguration:** Weak cipher suites, outdated protocols, or improper certificate management can compromise HTTPS security.
        *   **HTTP Header Vulnerabilities:**  Lack of security-related HTTP headers (e.g., HSTS, X-Frame-Options, Content-Security-Policy) can leave applications vulnerable to various attacks (MITM, clickjacking, XSS).
        *   **Request Smuggling/Spoofing:**  Vulnerabilities in HTTP request parsing can lead to request smuggling or spoofing attacks.
        *   **Denial of Service (DoS) via Large Requests:**  Lack of limits on request size or timeouts can make Tomcat susceptible to DoS attacks by sending excessively large requests.
    *   **Specific Recommendations:**
        *   **Enforce strong TLS/SSL configuration:** Use strong cipher suites, disable weak protocols (SSLv3, TLS 1.0, TLS 1.1), and enforce TLS 1.2 or higher. Regularly update TLS/SSL libraries.
        *   **Implement security-related HTTP headers:** Configure Tomcat to send HSTS, X-Frame-Options, Content-Security-Policy, X-Content-Type-Options, and other relevant security headers.
        *   **Apply request size limits and timeouts:** Configure appropriate limits for request size, header size, and connection timeouts to mitigate DoS risks.
        *   **Disable unnecessary HTTP methods:**  Restrict allowed HTTP methods to only those required by the application (e.g., disable TRACE, TRACK).

*   **Coyote AJP Connector:**
    *   **Security Implications:** Coyote AJP Connector is used for communication with reverse proxies. If misconfigured or exposed, it can be a significant vulnerability.
        *   **AJP Smuggling/Poisoning:** Vulnerabilities in AJP protocol handling can lead to request smuggling or poisoning attacks, potentially bypassing reverse proxy security controls.
        *   **Unauthorized Access via AJP:** If the AJP port is exposed without proper authentication and authorization, attackers can directly access Tomcat and potentially bypass web application security.
        *   **AJP "Ghostcat" Vulnerability (CVE-2020-1938):**  A well-known vulnerability in AJP allowed for file inclusion and remote code execution. While patched, it highlights the risks associated with AJP if not properly secured.
    *   **Specific Recommendations:**
        *   **Disable AJP Connector if not needed:** If Tomcat is not deployed behind a reverse proxy using AJP, disable the AJP connector entirely.
        *   **Secure AJP Connector with `secretRequired` and `secret`:**  Always enable `secretRequired="true"` and configure a strong, unique `secret` attribute for the AJP connector to authenticate connections from the reverse proxy.
        *   **Restrict AJP Connector access to trusted networks:**  Use firewall rules to limit access to the AJP port (default 8009) to only the trusted reverse proxy server(s).
        *   **Regularly update Tomcat:** Ensure the AJP connector is patched against known vulnerabilities like "Ghostcat".

**2.2. Configuration and Management Components:**

*   **Configuration Files (server.xml, web.xml, context.xml, etc.):**
    *   **Security Implications:** Configuration files contain sensitive settings, including passwords, keys, and access control rules.
        *   **Exposure of Sensitive Data:**  Unprotected configuration files can expose sensitive information if file system permissions are weak or if backups are not secured.
        *   **Misconfiguration Vulnerabilities:** Incorrect or insecure configuration settings can introduce vulnerabilities (e.g., weak authentication, insecure defaults).
        *   **XML External Entity (XXE) Injection:**  If XML parsing is not properly configured, configuration files could be vulnerable to XXE injection attacks.
    *   **Specific Recommendations:**
        *   **Restrict access to configuration files:**  Implement strict file system permissions to ensure only authorized users and processes can read and modify configuration files.
        *   **Securely store sensitive data:**  Use encrypted passwords and secrets in configuration files where possible. Consider using Tomcat's Credential Handler or external secret management solutions.
        *   **Regularly review and audit configurations:**  Periodically review Tomcat configuration files to identify and correct any insecure settings or misconfigurations.
        *   **Disable XML External Entity (XXE) processing:** Configure XML parsers to disable processing of external entities to prevent XXE injection vulnerabilities.

*   **Logging System:**
    *   **Security Implications:** Logs contain valuable information for security monitoring and incident response, but also potentially sensitive data.
        *   **Log Injection:**  If user input is directly written to logs without proper sanitization, attackers can inject malicious log entries, potentially leading to log poisoning or log injection attacks.
        *   **Exposure of Sensitive Data in Logs:**  Logs may inadvertently contain sensitive information (e.g., user credentials, session IDs, application data) if logging is not carefully configured.
        *   **Insecure Log Storage and Access:**  Unprotected log files can be accessed by unauthorized users, potentially revealing sensitive information or allowing attackers to tamper with logs to cover their tracks.
    *   **Specific Recommendations:**
        *   **Sanitize log messages:**  Sanitize user input before logging to prevent log injection attacks.
        *   **Minimize logging of sensitive data:**  Avoid logging sensitive information unnecessarily. If sensitive data must be logged, implement redaction or masking techniques.
        *   **Secure log storage and access:**  Restrict access to log files to authorized personnel and processes. Implement log rotation and archiving to manage log volume and storage.
        *   **Centralized logging and monitoring:**  Forward Tomcat logs to a centralized logging and security information and event management (SIEM) system for security monitoring and analysis.

*   **Management Interface (Web - Tomcat Manager):**
    *   **Security Implications:** Tomcat Manager provides web-based management capabilities, but if not properly secured, it can be a major vulnerability.
        *   **Weak Authentication and Authorization:** Default or weak credentials, or misconfigured authentication mechanisms, can allow unauthorized access to the Manager application.
        *   **CSRF Vulnerabilities:**  Lack of CSRF protection in the Manager application can allow attackers to perform actions on behalf of authenticated administrators.
        *   **Vulnerabilities in Manager Application itself:**  Bugs or vulnerabilities in the Tomcat Manager application code can be exploited for various attacks.
        *   **Exposure of Management Interface:**  If the Manager application is accessible from the public internet, it significantly increases the attack surface.
    *   **Specific Recommendations:**
        *   **Disable Tomcat Manager in production if not needed:** If web-based management is not required in production, disable the Manager application entirely.
        *   **Restrict access to Tomcat Manager:**  Limit access to the Manager application to specific IP addresses or networks using `<Valve className="org.apache.catalina.valves.RemoteAddrValve" allow="..."/>` in `context.xml` for the Manager application.
        *   **Enforce strong authentication for Tomcat Manager:**  Use strong authentication mechanisms (e.g., certificate-based authentication) and enforce strong password policies for Manager users.
        *   **Enable HTTPS for Tomcat Manager:**  Ensure the Manager application is only accessible over HTTPS to protect credentials in transit.
        *   **Implement CSRF protection:**  While Tomcat Manager has some CSRF protection, ensure it is enabled and consider additional CSRF mitigation measures if necessary.
        *   **Regularly update Tomcat:** Keep Tomcat Manager updated to patch any vulnerabilities in the application itself.

*   **Management Interface (CLI - JMX, scripts):**
    *   **Security Implications:** CLI management via JMX or scripts can also introduce security risks if not properly secured.
        *   **Weak Authentication and Authorization:**  Default or weak credentials for JMX or scripts can allow unauthorized access.
        *   **Insecure Remote Access:**  Exposing JMX or CLI management interfaces over the network without proper security measures can allow remote attackers to gain control.
        *   **Script Injection Vulnerabilities:**  If scripts used for management are not properly secured, they could be vulnerable to injection attacks.
    *   **Specific Recommendations:**
        *   **Restrict access to CLI management interfaces:**  Limit access to JMX and CLI management interfaces to specific IP addresses or networks.
        *   **Enforce strong authentication for CLI management:**  Use strong authentication mechanisms for JMX and scripts, and enforce strong password policies.
        *   **Secure remote access:**  Use SSH or VPN for secure remote access to CLI management interfaces.
        *   **Secure scripting practices:**  Follow secure coding practices when developing and using management scripts to prevent injection vulnerabilities.
        *   **Disable unnecessary management interfaces:** If certain CLI management interfaces are not required, disable them to reduce the attack surface.

### 3. Architecture, Components, and Data Flow Inference (Based on Codebase and Documentation - Implicit)

Based on the provided design review and general knowledge of Apache Tomcat, we can infer the following simplified architecture and data flow:

1.  **Request Reception:** External clients (End Users, Reverse Proxies, Load Balancers) send requests (HTTP/HTTPS or AJP) to Tomcat.
2.  **Connector Processing:**
    *   **Coyote HTTP Connector:** Receives and processes HTTP/HTTPS requests. Handles TLS/SSL termination for HTTPS. Parses HTTP requests and forwards them to the Catalina Servlet Container.
    *   **Coyote AJP Connector:** Receives and processes AJP requests, typically from a reverse proxy. Forwards requests to the Catalina Servlet Container.
3.  **Servlet Container (Catalina) Processing:**
    *   **Request Handling:** Catalina receives requests from the connectors.
    *   **Servlet/JSP Dispatch:**  Determines the appropriate servlet or JSP to handle the request based on URL mapping and application deployment configuration.
    *   **Servlet Lifecycle Management:** Manages the lifecycle of servlets and filters.
    *   **Security Constraint Enforcement:** Enforces security constraints defined in `web.xml` or programmatically.
    *   **Session Management:** Manages user sessions.
    *   **JSP Compilation (Jasper):** If the request is for a JSP page, Catalina uses the Jasper JSP Engine to compile the JSP into a servlet (if not already compiled).
4.  **Web Application Execution:** The selected servlet or JSP executes, processing the request, interacting with backend systems (Databases, other services), and generating a response.
5.  **Response Generation:** The servlet or JSP generates an HTTP response.
6.  **Connector Response:**
    *   **Coyote HTTP Connector:** Sends the HTTP response back to the client.
    *   **Coyote AJP Connector:** Sends the AJP response back to the reverse proxy.
7.  **Logging:** Throughout the process, the Logging System records events, access logs, and application logs to configured destinations (File System, etc.).
8.  **Configuration Loading:** At startup, Tomcat reads configuration files (server.xml, web.xml, etc.) to initialize connectors, containers, realms, and other components.
9.  **Management Interface Access:** System Administrators can access the Management Interface (Web or CLI) to manage Tomcat server and deployed web applications. These interfaces interact with Catalina and other components to perform management tasks.

**Data Flow Summary:**

*   **Request Data Flow:** External Client -> Connector -> Catalina -> Servlet/JSP -> Response -> Connector -> External Client.
*   **Configuration Data Flow:** Configuration Files -> Tomcat Components (at startup).
*   **Logging Data Flow:** Tomcat Components -> Logging System -> Log Storage (File System, etc.).
*   **Management Data Flow:** Management Interface -> Tomcat Components (for management operations).

### 4. Specific Recommendations Tailored to Tomcat

Based on the analysis, here are specific and tailored security recommendations for Apache Tomcat deployments:

**4.1. General Tomcat Hardening:**

*   **Apply the Principle of Least Privilege:** Run Tomcat as a dedicated user with minimal privileges required for its operation. Avoid running Tomcat as root.
*   **Disable Default Ports and Connectors:** If not needed, disable default HTTP (8080) and AJP (8009) connectors. Only enable necessary connectors and ports.
*   **Remove Default Web Applications:** Remove default web applications like `examples`, `docs`, and `host-manager` from production deployments as they are not typically needed and can introduce vulnerabilities.
*   **Secure File System Permissions:**  Implement strict file system permissions for Tomcat installation directory, configuration files, web application deployments, and log files.
*   **Regular Security Updates and Patching:** Establish a process for regularly monitoring and applying Tomcat security updates and patches as soon as they are released. Subscribe to the Apache Tomcat Security mailing list for notifications.
*   **Security Audits and Penetration Testing:** Conduct regular security audits and penetration testing of Tomcat deployments to identify and address potential weaknesses.

**4.2. Configuration Hardening:**

*   **Strong TLS/SSL Configuration (HTTP Connector):**
    *   Use `SSLHostConfig` to configure TLS settings.
    *   Specify strong `ciphers` attribute to use only secure cipher suites.
    *   Set `sslEnabledProtocols` to include only TLS 1.2 and TLS 1.3 (disable older protocols).
    *   Configure `certificateVerification="required"` and `clientAuth="true"` for mutual TLS if client certificate authentication is needed.
    *   Implement HSTS (HTTP Strict Transport Security) by configuring the `Strict-Transport-Security` header in the HTTP Connector or a reverse proxy.
*   **AJP Connector Security:**
    *   Always set `secretRequired="true"` and configure a strong, unique `secret` attribute for the AJP Connector.
    *   Restrict access to the AJP port (8009) using firewall rules to only allow connections from trusted reverse proxy servers.
*   **Management Interface Security (Tomcat Manager):**
    *   Restrict access to the Manager application using `RemoteAddrValve` to limit access to specific IP addresses or networks.
    *   Enforce strong authentication for Manager users using `Realm` configuration (e.g., `UserDatabaseRealm`, LDAPRealm).
    *   Configure HTTPS for the Manager application.
    *   Consider disabling the Manager application in production if not strictly necessary.
*   **Logging Configuration:**
    *   Configure log rotation and archiving to manage log file size and storage.
    *   Forward logs to a centralized logging system (SIEM) for security monitoring.
    *   Minimize logging of sensitive data and sanitize log messages to prevent log injection.
*   **Disable Unnecessary Features:** Disable any Tomcat features or components that are not required for the application's functionality to reduce the attack surface.

**4.3. Build and Deployment Pipeline Security:**

*   **Automated Security Scanning (SAST and DAST):** Integrate SAST and DAST tools into the CI/CD pipeline to automatically identify vulnerabilities in code and deployed applications.
*   **Dependency Vulnerability Scanning:** Use dependency check tools (like OWASP Dependency-Check) in the build process to identify and manage vulnerable dependencies.
*   **Container Image Security Scanning:** Scan Docker container images for vulnerabilities during the build process and before deployment.
*   **Secure Build Process:** Ensure the build process is secure, using trusted build environments and secure artifact repositories.
*   **Immutable Infrastructure:** Deploy Tomcat using immutable infrastructure principles, where server configurations are defined as code and deployments are reproducible and consistent.
*   **Containerized Deployment Security (Kubernetes):**
    *   Apply Kubernetes RBAC to control access to Kubernetes resources.
    *   Use Network Policies to segment network traffic within the Kubernetes cluster and restrict access to Tomcat pods.
    *   Implement Secrets Management in Kubernetes to securely manage sensitive data like passwords and certificates.
    *   Regularly scan Kubernetes cluster components and node operating systems for vulnerabilities.

**4.4. Secure Coding Practices for Web Applications (Tomcat Context):**

*   **Input Validation:** Implement comprehensive input validation in web applications deployed on Tomcat to prevent injection attacks (SQL injection, XSS, command injection, etc.).
*   **Output Encoding:** Encode output data properly to prevent XSS vulnerabilities.
*   **Authentication and Authorization in Web Applications:** Implement robust authentication and authorization mechanisms within web applications, leveraging Tomcat's security realms or application-level security frameworks.
*   **Secure Session Management in Web Applications:** Follow secure session management practices in web applications to prevent session hijacking and fixation.
*   **Error Handling and Exception Management:** Implement secure error handling and exception management to avoid exposing sensitive information in error messages.

### 5. Actionable Mitigation Strategies Applicable to Identified Threats

Here are actionable mitigation strategies, tailored to Tomcat, for the identified threats:

| Threat                                      | Mitigation Strategy                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                