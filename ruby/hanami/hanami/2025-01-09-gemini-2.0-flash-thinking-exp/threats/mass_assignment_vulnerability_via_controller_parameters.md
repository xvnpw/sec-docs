## Deep Analysis: Mass Assignment Vulnerability via Controller Parameters in Hanami

This document provides a deep analysis of the "Mass Assignment Vulnerability via Controller Parameters" threat within a Hanami application. We will explore the technical details, potential attack vectors, impact scenarios, and detailed mitigation strategies tailored for the Hanami framework.

**1. Threat Deep Dive:**

**1.1. Technical Explanation:**

The vulnerability stems from the way Hanami controllers handle incoming request parameters through the `Hanami::Controller::Params` object. When a controller action directly uses these parameters to update model attributes without proper sanitization or filtering, it opens a window for attackers to manipulate data beyond the intended scope.

**How it works:**

* **Request Handling:** When a user submits a form or makes an API request, the data is sent as key-value pairs in the request body (e.g., via POST or PUT methods).
* **Parameter Access:** The `Hanami::Controller::Params` object in the controller action provides access to these request parameters.
* **Direct Assignment (Vulnerable Code):**  A vulnerable controller action might directly use these parameters to update a model instance:

```ruby
# Potentially vulnerable controller action
module Web::Controllers::Users
  class Update
    include Web::Action

    def call(params)
      user = UserRepository.new.find(params[:id])
      user.update(params[:user]) # Directly using params[:user]
      redirect_to routes.user_path(user.id)
    end
  end
end
```

In this example, if the request includes parameters like `user[is_admin]=true` or `user[password]=new_password`, and the `User` model has these attributes, the attacker can manipulate them even if the update form was not intended to modify these fields.

**1.2. Attack Vectors & Exploitation Scenarios:**

Attackers can exploit this vulnerability through various means:

* **Manipulating Form Data:**  By inspecting the HTML source of forms, attackers can identify the names of model attributes and add hidden or modified fields to the form submission.
* **Crafting Malicious API Requests:** For API endpoints, attackers can directly construct HTTP requests with arbitrary parameters in the request body (JSON, XML, etc.).
* **Browser Developer Tools:** Attackers can intercept and modify requests before they are sent to the server, adding malicious parameters.

**Example Exploitation Scenario:**

Consider a user profile update form that allows users to change their name and email. A malicious user could inspect the request and add a parameter like `user[role]=admin`. If the controller directly assigns `params[:user]` to the `User` model, they could potentially elevate their privileges.

**1.3. Impact Analysis:**

The impact of a successful mass assignment attack can be severe:

* **Data Corruption:**  Attackers can modify critical data fields, leading to inconsistencies and errors within the application.
* **Privilege Escalation:** As demonstrated above, attackers can grant themselves administrative privileges or access to sensitive resources.
* **Account Takeover:**  Attackers could change user passwords or email addresses, effectively taking control of accounts.
* **Financial Loss:** In e-commerce applications, attackers could modify order prices, apply unauthorized discounts, or manipulate payment information.
* **Reputational Damage:** Security breaches can severely damage the reputation and trust associated with the application and the organization.
* **Compliance Violations:** Depending on the industry and regulations, such vulnerabilities can lead to significant fines and legal repercussions.

**2. Hanami Context and Specific Considerations:**

* **`Hanami::Controller::Params`:**  Understanding how `Hanami::Controller::Params` exposes request data is crucial. It provides a hash-like interface to access parameters.
* **Entity/Model Structure:** The structure of your Hanami entities (models) dictates which attributes are potentially vulnerable. Attributes that should be protected from public modification are prime targets.
* **Repository Pattern:** While the repository pattern itself doesn't directly prevent mass assignment, it's the layer where the updated entity is persisted. Secure controllers ensure only valid data reaches the repository.
* **Form Objects (Hanami::Action::Params):** Hanami provides a robust mechanism for handling form data through `Hanami::Action::Params`. This is a key component in mitigating mass assignment. By defining strict parameter schemas, you can control which attributes are allowed.

**3. Detailed Mitigation Strategies for Hanami:**

**3.1. Strong Parameter Filtering and Whitelisting:**

This is the most fundamental mitigation strategy. Instead of directly assigning `params[:user]`, explicitly define which attributes are allowed for modification.

```ruby
# Secure controller action using whitelisting
module Web::Controllers::Users
  class Update
    include Web::Action

    params do
      required(:id).filled(:integer)
      optional(:user).schema do
        optional(:name).filled(:str?)
        optional(:email).filled(:str?, format: :email)
        # Do NOT include sensitive attributes like :is_admin or :password here
      end
    end

    def call(params)
      if params.valid?
        user = UserRepository.new.find(params[:id])
        user.update(params[:user])
        redirect_to routes.user_path(user.id)
      else
        # Handle validation errors
        self.status = 422
        self.body = { errors: params.errors }.to_json
      end
    end
  end
end
```

**Explanation:**

* **`params do ... end`:** This block defines the expected structure and validation rules for the incoming parameters.
* **`optional(:user).schema do ... end`:**  This defines a nested schema for the `user` parameter.
* **Explicitly Allowed Attributes:** Only `name` and `email` are explicitly allowed within the `user` schema. Any other attributes passed in `params[:user]` will be ignored.
* **Validation:**  The `params.valid?` check ensures that the incoming parameters adhere to the defined schema.

**3.2. Using Form Objects (Hanami::Action::Params):**

Hanami's `Hanami::Action::Params` provides a powerful way to define and validate the structure of incoming parameters. This approach is highly recommended for preventing mass assignment.

```ruby
# Secure controller action using Form Objects
module Web::Controllers::Users
  class Update
    include Web::Action

    params Web::Validations::UserUpdate

    def call(params)
      if params.valid?
        user = UserRepository.new.find(params[:id])
        user.update(params[:user])
        redirect_to routes.user_path(user.id)
      else
        # Handle validation errors
        self.status = 422
        self.body = { errors: params.errors }.to_json
      end
    end
  end
end

# Define the Form Object (e.g., in lib/web/validations/user_update.rb)
module Web::Validations
  UserUpdate = Dry::Schema.Params do
    required(:id).filled(:integer)
    optional(:user).hash do
      optional(:name).filled(:str?)
      optional(:email).filled(:str?, format: :email)
    end
  end
end
```

**Explanation:**

* **Dedicated Validation Class:**  The validation logic is encapsulated in a separate class (`Web::Validations::UserUpdate`), promoting code organization and reusability.
* **`Dry::Schema.Params`:** Hanami leverages the `dry-validation` gem for defining parameter schemas.
* **Clear Separation of Concerns:** The controller action focuses on business logic, while the validation class handles parameter validation.

**3.3. Avoid Direct Assignment:**

Never directly assign the entire `params` hash or a nested hash from `params` to your model's `update` method without explicit filtering.

**Vulnerable (Avoid):**

```ruby
user.update(params[:user])
```

**Secure (Use Whitelisting):**

```ruby
user.update(params[:user].slice(:name, :email))
```

The `slice` method allows you to pick only the permitted keys from the `params[:user]` hash.

**3.4. Principle of Least Privilege:**

When updating model attributes, only update the specific attributes that are intended to be modified in that particular action. Avoid updating all attributes at once if not necessary.

**3.5. Code Reviews and Static Analysis:**

Regular code reviews and the use of static analysis tools can help identify potential mass assignment vulnerabilities. Look for instances where `params` or its nested hashes are directly passed to model update methods.

**3.6. Testing:**

Implement comprehensive tests that specifically target mass assignment vulnerabilities. These tests should attempt to update attributes that are not intended to be publicly accessible.

**Example Test:**

```ruby
RSpec.describe Web::Controllers::Users::Update, type: :action do
  let(:user) { UserRepository.new.create(name: 'Original Name', email: 'original@example.com', is_admin: false) }
  let(:params) { { id: user.id, user: { name: 'New Name', is_admin: true } } }

  it 'does not allow updating sensitive attributes' do
    response = subject.call(params)
    expect(response[0]).to eq 302 # Redirect
    updated_user = UserRepository.new.find(user.id)
    expect(updated_user.name).to eq 'New Name'
    expect(updated_user.is_admin).to be false # Ensure is_admin was not updated
  end
end
```

**4. Detection and Prevention Strategies:**

* **Static Analysis Tools:** Tools like Brakeman (for Ruby on Rails, but can be adapted for Hanami) or other SAST tools can identify potential mass assignment issues by analyzing code patterns.
* **Security Audits:** Regular security audits conducted by experienced professionals can help uncover vulnerabilities that might be missed by automated tools.
* **Penetration Testing:** Simulating real-world attacks can help identify exploitable mass assignment vulnerabilities.
* **Developer Training:** Educating developers about the risks of mass assignment and secure coding practices is crucial for prevention.

**5. Conclusion:**

The Mass Assignment Vulnerability via Controller Parameters is a significant threat in web applications, including those built with Hanami. By understanding the technical details of this vulnerability and implementing robust mitigation strategies like strong parameter filtering, using form objects, and adhering to the principle of least privilege, development teams can significantly reduce the risk of exploitation. Continuous vigilance through code reviews, testing, and security audits is essential to maintain a secure Hanami application.
