## Deep Security Analysis of Sidekiq Application

### 1. Objective, Scope, and Methodology

**Objective:**

The primary objective of this deep security analysis is to thoroughly evaluate the security posture of an application utilizing Sidekiq for background job processing. This analysis aims to identify potential security vulnerabilities and weaknesses within the Sidekiq components and their interactions with other system elements, based on the provided security design review. The analysis will focus on ensuring the confidentiality, integrity, and availability of the application and its data, specifically in the context of asynchronous job processing managed by Sidekiq.

**Scope:**

This security analysis encompasses the following components and aspects of the Sidekiq application architecture, as outlined in the security design review:

* **Sidekiq Server Process:**  Security of the core job processing logic, dependency management, and resource handling.
* **Sidekiq Client Library:** Security of job enqueueing mechanisms and communication with Redis.
* **Sidekiq Web UI:** Authentication, authorization, and protection against web-based attacks.
* **Redis Data Store:** Security of data at rest and in transit, access control, and configuration.
* **Deployment Environment (Kubernetes):** Security considerations related to containerization and orchestration.
* **Build Process (CI/CD Pipeline):** Security of the development and deployment lifecycle.
* **Data Flow:** Analysis of data movement between components and potential interception points.
* **Identified Business and Security Risks:**  Addressing the risks outlined in the security design review and expanding on them based on the architecture.

The analysis will specifically focus on security considerations relevant to Sidekiq and its integration within a web application context. General web application security principles will be considered where applicable, but the emphasis will be on Sidekiq-specific vulnerabilities and mitigations.

**Methodology:**

The methodology for this deep security analysis will involve the following steps:

1. **Document Review:**  In-depth review of the provided security design review document, including business posture, security posture, C4 diagrams (Context, Container, Deployment, Build), risk assessment, questions, and assumptions.
2. **Architecture and Data Flow Inference:** Based on the design documents and understanding of Sidekiq's functionality, infer the detailed architecture, component interactions, and data flow within the application. This will involve analyzing how the Web Application enqueues jobs, how Sidekiq processes them using Redis, and how the Web UI provides monitoring capabilities.
3. **Threat Modeling:** Identify potential security threats targeting each component and interaction point within the Sidekiq architecture. This will be based on common attack vectors for web applications, background job processing systems, and Redis data stores, as well as the specific risks outlined in the security design review.
4. **Security Control Analysis:** Evaluate the existing and recommended security controls outlined in the design review against the identified threats. Assess the effectiveness of these controls and identify any gaps.
5. **Vulnerability Analysis:**  Analyze the potential vulnerabilities specific to Sidekiq and its dependencies, considering aspects like insecure deserialization, injection flaws, authentication/authorization weaknesses, and misconfigurations.
6. **Mitigation Strategy Development:**  For each identified threat and vulnerability, develop actionable and tailored mitigation strategies specific to Sidekiq and the described architecture. These strategies will be practical, implementable by the development team, and aligned with security best practices.
7. **Recommendation Prioritization:** Prioritize the mitigation strategies based on the severity of the identified risks and the feasibility of implementation.
8. **Documentation and Reporting:**  Document the findings of the analysis, including identified threats, vulnerabilities, recommended mitigations, and prioritized actions in a clear and structured report. This report will serve as a guide for the development team to enhance the security of the Sidekiq application.

This methodology will ensure a systematic and comprehensive security analysis, focusing on the specific context of Sidekiq and providing actionable recommendations for improvement.

### 2. Security Implications of Key Components

Based on the provided design review and understanding of Sidekiq, the security implications of each key component are detailed below:

**2.1. Sidekiq Server Process:**

* **Security Implications:**
    * **Job Processing Logic Vulnerabilities:**  Vulnerabilities within the Ruby code of the job processing logic itself. This could include injection flaws (SQL injection, command injection, code injection if processing dynamic code), business logic flaws, or vulnerabilities in external libraries used within jobs. If job arguments are not properly validated and sanitized within the job processing code, it can lead to exploitation.
    * **Insecure Deserialization:** Sidekiq serializes job arguments before storing them in Redis and deserializes them when processing. If insecure serialization formats (like Ruby's `Marshal` with untrusted input) are used or if deserialization is not handled carefully, it can lead to remote code execution vulnerabilities.
    * **Dependency Vulnerabilities:** Sidekiq and the jobs themselves rely on Ruby gems. Vulnerabilities in these dependencies can be exploited if not properly managed and updated.
    * **Resource Exhaustion:**  Malicious or poorly designed jobs could consume excessive resources (CPU, memory, network), leading to denial of service for other jobs or the entire Sidekiq server. Lack of resource limits or rate limiting on job processing can exacerbate this.
    * **Privilege Escalation:** If the Sidekiq server process runs with excessive privileges, vulnerabilities in job processing or dependencies could be exploited to gain higher privileges on the underlying system.
    * **Information Disclosure:** Errors or verbose logging within job processing could inadvertently expose sensitive data from job arguments or internal application state.

**2.2. Sidekiq Client Library (within Web Application):**

* **Security Implications:**
    * **Job Enqueueing Injection:** If the Web Application does not properly validate and sanitize user inputs before passing them as job arguments to the Sidekiq client library, it could be possible to inject malicious payloads. This could lead to various attacks depending on how the job processing logic handles these arguments (e.g., command injection if arguments are used in system commands within jobs).
    * **Unauthorized Job Enqueueing:** If there are no authorization checks in the Web Application before enqueuing jobs, unauthorized users or processes might be able to submit jobs, potentially leading to abuse, resource exhaustion, or execution of malicious jobs.
    * **Insecure Communication with Redis (Client-Side):** While less critical than server-side Redis communication, if the communication channel between the client library and Redis is not secured (e.g., unencrypted network traffic), there's a risk of eavesdropping or man-in-the-middle attacks, although this is less likely in a typical cloud deployment where components are within the same network.

**2.3. Sidekiq Web UI:**

* **Security Implications:**
    * **Authentication Bypass:** If the Sidekiq Web UI lacks proper authentication or has weak authentication mechanisms, unauthorized users could gain access to sensitive information about job queues, processing status, and potentially even manipulate jobs (retry, delete, etc.).
    * **Authorization Issues:** Even with authentication, insufficient authorization controls could allow users to access or modify data or perform actions beyond their intended permissions.
    * **Cross-Site Scripting (XSS):** If the Web UI does not properly sanitize user inputs or data displayed from Sidekiq/Redis, it could be vulnerable to XSS attacks. An attacker could inject malicious scripts that execute in the context of other users' browsers when they access the Web UI.
    * **Cross-Site Request Forgery (CSRF):** If the Web UI does not implement CSRF protection, attackers could potentially trick authenticated users into performing unintended actions on the Sidekiq system, such as deleting jobs or modifying configurations.
    * **Information Disclosure:** The Web UI displays sensitive operational data about Sidekiq and job processing. Unauthorized access could lead to information disclosure about application behavior, job types, and potentially sensitive data within job arguments if displayed in logs or job details.
    * **Session Management Issues:** Weak session management in the Web UI could lead to session hijacking or session fixation attacks, allowing attackers to impersonate legitimate users.

**2.4. Redis Data Store:**

* **Security Implications:**
    * **Unauthorized Access:** If Redis is not properly secured with authentication (e.g., `requirepass` or ACLs) and network access controls (firewalls, network policies), unauthorized users or processes could gain access to the Redis instance. This could lead to data breaches, data manipulation, or denial of service.
    * **Data Breaches:** Sensitive job arguments and metadata are stored in Redis. If Redis is compromised due to unauthorized access or vulnerabilities, this sensitive data could be exposed.
    * **Data Tampering:**  Unauthorized access to Redis could allow attackers to modify or delete job data, leading to data integrity issues and disruption of application functionality.
    * **Denial of Service (Redis Level):**  Attacks targeting Redis itself (e.g., slowloris, command injection if Redis is exposed externally and vulnerable) could lead to denial of service for Sidekiq and the entire application.
    * **Lack of Encryption at Rest:** If sensitive job data is stored in Redis without encryption at rest, physical access to the Redis server or storage media could lead to data breaches.
    * **Lack of Encryption in Transit:** If communication between Sidekiq servers and Redis is not encrypted (e.g., using TLS), network eavesdropping could expose job data in transit.
    * **Misconfiguration:** Incorrect Redis configuration, such as weak passwords, default settings, or insecure network bindings, can create significant security vulnerabilities.

**2.5. Deployment Environment (Kubernetes):**

* **Security Implications:**
    * **Container Image Vulnerabilities:** Vulnerabilities in the base images used for Sidekiq and Redis containers or in the application code packaged within the containers.
    * **Kubernetes Misconfiguration:**  Insecure Kubernetes configurations, such as overly permissive RBAC roles, insecure network policies, or exposed Kubernetes API server, can create vulnerabilities.
    * **Pod Security Context Issues:**  Running containers with excessive privileges (e.g., as root user) within Kubernetes pods increases the potential impact of container escape vulnerabilities.
    * **Network Policy Gaps:**  Insufficiently restrictive network policies within Kubernetes could allow unauthorized network traffic between pods or from external networks.
    * **Secrets Management:**  Insecure storage or handling of secrets (e.g., Redis passwords, API keys) within Kubernetes Secrets or configuration management systems.
    * **Node Security:**  Compromised Kubernetes worker nodes could lead to container escape and broader cluster compromise.

**2.6. Build Process (CI/CD Pipeline):**

* **Security Implications:**
    * **Compromised Build Environment:** If the build environment is compromised, attackers could inject malicious code into the build artifacts (gems, Docker images) that are deployed to production.
    * **Dependency Supply Chain Attacks:**  Compromised or malicious dependencies introduced during the build process could introduce vulnerabilities into the application.
    * **Insecure Artifact Repository:**  If the artifact repository is not properly secured, unauthorized users could access or modify build artifacts, potentially leading to deployment of compromised code.
    * **Lack of Security Scanning in CI/CD:**  If security scans (SAST, dependency scanning, container image scanning) are not integrated into the CI/CD pipeline, vulnerabilities may not be detected before deployment.
    * **Insufficient Access Control to CI/CD Pipeline:**  Unauthorized access to the CI/CD pipeline could allow attackers to modify build processes, inject malicious code, or deploy compromised artifacts.

### 3. Architecture, Components, and Data Flow Inference

Based on the provided C4 diagrams and descriptions, the inferred architecture, components, and data flow are as follows:

**Architecture:** The application follows a microservice-like architecture where the Web Application handles user interactions and enqueues background jobs to Sidekiq. Sidekiq, in turn, uses Redis as a message queue and data store to manage and process these jobs asynchronously. A separate Monitoring System observes the health and performance of both Sidekiq and Redis.

**Components:**

1.  **Web Application:**  The primary user-facing application. It interacts with users, handles requests, and when necessary, offloads tasks to Sidekiq by enqueuing jobs. It uses the Sidekiq Client Library to interact with Redis.
2.  **Sidekiq Server Process:** The core background job processing engine. It continuously polls Redis for new jobs, retrieves them, and executes the associated job logic. It uses Redis to manage job queues, track job status, and handle retries.
3.  **Redis:** An in-memory data store serving as the backbone for Sidekiq. It acts as a job queue, storing job data and metadata. Sidekiq Server and Client communicate with Redis to enqueue, dequeue, and manage jobs.
4.  **Sidekiq Client Library:** A Ruby library embedded within the Web Application. It provides an API for the Web Application to enqueue jobs to Sidekiq by pushing them into Redis queues.
5.  **Sidekiq Web UI:** A web-based interface for monitoring and managing Sidekiq. It provides insights into job queues, worker status, job statistics, and allows administrative actions like retrying or deleting jobs. It interacts with both the Sidekiq Server Process and Redis to retrieve and display information.
6.  **Monitoring System:** An external system (e.g., Prometheus, Grafana, Datadog) that collects metrics from Sidekiq and Redis to provide operational visibility and alerting.

**Data Flow:**

1.  **Job Enqueueing:**
    * User interacts with the Web Application.
    * Web Application processes the user request and determines that a background job is needed.
    * Web Application uses the Sidekiq Client Library to create a job with specific arguments.
    * Sidekiq Client Library serializes the job arguments and pushes the job data into a designated queue in Redis.

2.  **Job Processing:**
    * Sidekiq Server Process continuously polls Redis queues for new jobs.
    * When a job is available in a queue, Sidekiq Server retrieves it from Redis.
    * Sidekiq Server deserializes the job arguments.
    * Sidekiq Server executes the job processing logic defined for that job type, using the deserialized arguments. This job logic might involve interactions with databases, external APIs, or other services.
    * Upon completion (success or failure), Sidekiq Server updates the job status in Redis.

3.  **Monitoring and Management:**
    * Sidekiq Server Process exposes metrics about job processing, queue lengths, worker status, etc.
    * Monitoring System collects these metrics from Sidekiq Server and Redis.
    * Admin users can access the Sidekiq Web UI to monitor job queues, inspect job details, and perform administrative actions. The Web UI retrieves data from both Sidekiq Server and Redis.

**Security Critical Data Flow Points:**

* **Job Arguments from Web Application to Redis:** This is a critical point as potentially sensitive data is being serialized and stored. Input validation and secure serialization are crucial here.
* **Job Data Storage in Redis:** Redis becomes the central repository for job data. Securing Redis is paramount to protect the confidentiality and integrity of this data.
* **Job Arguments from Redis to Sidekiq Server:** Deserialization of job arguments in the Sidekiq Server is another critical point where insecure deserialization vulnerabilities can arise.
* **Access to Sidekiq Web UI:**  Unauthenticated or unauthorized access to the Web UI can expose sensitive operational data and potentially allow malicious actions.
* **Communication between Components:** While less detailed in the diagrams, securing communication channels between Web Application and Redis, and Sidekiq Server and Redis (especially if they are on different networks) is important to prevent eavesdropping or tampering.

### 4. Specific Security Recommendations for Sidekiq Application

Based on the identified security implications and architecture, here are specific security recommendations tailored to the Sidekiq application:

**4.1. Authentication and Authorization:**

* **Recommendation 1 (Web UI Authentication):** **Implement strong authentication for the Sidekiq Web UI.**  Enable HTTP Basic Authentication or integrate with the Web Application's existing authentication system (e.g., using Warden, Devise, or OAuth).  **Actionable:** Configure Sidekiq Web UI with authentication middleware. Refer to Sidekiq documentation for authentication options.
* **Recommendation 2 (Job Enqueueing Authorization):** **Implement authorization checks in the Web Application before enqueuing jobs.**  Determine which users or services are authorized to enqueue specific types of jobs based on application logic and roles. **Actionable:** Add authorization logic in the Web Application code that enqueues Sidekiq jobs. This might involve checking user roles or API keys before allowing job enqueueing.
* **Recommendation 3 (Job Data Authorization within Jobs):** **Implement authorization checks within job processing logic when accessing sensitive data.** If jobs process sensitive data, ensure that the job logic enforces authorization based on application-specific roles and permissions before accessing or manipulating this data. **Actionable:**  Incorporate authorization checks within the Ruby code of Sidekiq jobs, especially when dealing with sensitive data retrieved from databases or external services.

**4.2. Input Validation and Secure Serialization:**

* **Recommendation 4 (Job Argument Input Validation - Enqueueing):** **Validate job arguments in the Web Application *before* enqueuing jobs.**  Sanitize and validate all input data that will be passed as job arguments to prevent injection attacks and ensure data integrity. **Actionable:** Add input validation logic in the Web Application code before calling the Sidekiq client library to enqueue jobs. Use input validation libraries and techniques appropriate for the data types being handled.
* **Recommendation 5 (Job Argument Input Validation - Processing):** **Validate job arguments *within* the job processing logic in Sidekiq Server.**  Even if validation is done at enqueueing, perform validation again within the job processing code as a defense-in-depth measure. **Actionable:** Add input validation logic at the beginning of each Sidekiq job's `perform` method to validate the received arguments.
* **Recommendation 6 (Secure Job Serialization):** **Use JSON for job argument serialization whenever possible.** JSON is generally safer than Ruby's `Marshal` for serialization, especially when dealing with potentially untrusted input. If `Marshal` is absolutely necessary for specific use cases, exercise extreme caution and never deserialize untrusted data. **Actionable:** Configure Sidekiq to use JSON serialization. Review existing jobs and ensure they are compatible with JSON serialization. If `Marshal` is used, evaluate if it can be replaced with JSON or a safer alternative.

**4.3. Redis Security Hardening:**

* **Recommendation 7 (Redis Authentication):** **Enable Redis authentication using `requirepass` or, preferably, Redis ACLs.**  Set a strong, randomly generated password for Redis access. **Actionable:** Configure `requirepass` or ACLs in the Redis configuration file (`redis.conf`) and restart Redis. Update Sidekiq configuration to include the Redis password.
* **Recommendation 8 (Redis Network Security):** **Restrict network access to Redis.** Ensure Redis is not exposed to the public internet. Use firewalls and Kubernetes network policies to limit access to Redis only from authorized components (Sidekiq servers, Web Application if direct access is needed for specific reasons, monitoring systems). **Actionable:** Configure firewalls and Kubernetes network policies to restrict access to the Redis port (default 6379) to only necessary internal networks and pods.
* **Recommendation 9 (Redis Encryption in Transit):** **Enable TLS encryption for communication between Sidekiq servers and Redis.** This protects job data in transit from eavesdropping. **Actionable:** Configure Redis and Sidekiq to use TLS for communication. This might involve setting up stunnel or using Redis's built-in TLS support if available and appropriate for the deployment environment.
* **Recommendation 10 (Redis Encryption at Rest - Consider):** **Consider enabling Redis encryption at rest if highly sensitive data is stored in Redis and compliance requirements mandate it.**  Evaluate the performance impact and complexity of enabling encryption at rest.  **Actionable:** Research and implement Redis encryption at rest solutions if deemed necessary based on data sensitivity and compliance requirements. This might involve using disk encryption at the storage level or Redis-specific encryption features if available.

**4.4. Rate Limiting and Resource Management:**

* **Recommendation 11 (Job Rate Limiting and Throttling):** **Implement rate limiting and throttling mechanisms for job processing.** This can prevent abuse, denial-of-service attacks, and resource exhaustion by limiting the number of jobs processed within a given time frame. **Actionable:** Explore Sidekiq Pro's rate limiting features or implement custom rate limiting logic within the application or using a middleware. Configure appropriate rate limits based on application capacity and expected load.
* **Recommendation 12 (Resource Limits for Sidekiq Server Pods):** **Define resource limits (CPU, memory) for Sidekiq Server pods in Kubernetes.** This prevents individual Sidekiq pods from consuming excessive resources and impacting other pods or nodes. **Actionable:** Configure resource requests and limits in the Kubernetes deployment manifests for Sidekiq Server pods.

**4.5. Monitoring and Alerting:**

* **Recommendation 13 (Comprehensive Monitoring and Alerting):** **Implement comprehensive monitoring and alerting for Sidekiq and Redis.** Monitor key metrics such as job queue lengths, processing times, error rates, Redis performance, and resource utilization. Set up alerts for anomalies, errors, and potential security incidents. **Actionable:** Integrate Sidekiq and Redis with a monitoring system (e.g., Prometheus, Grafana, Datadog). Configure dashboards and alerts to monitor key security and operational metrics.

**4.6. Security Audits and Scanning:**

* **Recommendation 14 (Regular Security Audits):** **Conduct regular security audits of the Sidekiq codebase, job processing logic, and dependencies.**  This should include both manual code reviews and automated security testing. **Actionable:** Schedule periodic security audits (e.g., quarterly or annually). Engage security experts to perform penetration testing and vulnerability assessments.
* **Recommendation 15 (Automated Security Scanning in CI/CD):** **Integrate automated security scanning tools (SAST, DAST, dependency scanning, container image scanning) into the CI/CD pipeline.** This ensures that security vulnerabilities are detected early in the development lifecycle. **Actionable:** Integrate SAST tools (e.g., Brakeman for Ruby), dependency scanning tools (e.g., Bundler Audit, Gemnasium), and container image scanning tools into the CI/CD pipeline. Configure these tools to run automatically on each code commit or build.

**4.7. Secure Dependency Management:**

* **Recommendation 16 (Dependency Management and Updates):** **Use Bundler to manage Ruby gem dependencies and regularly update dependencies to the latest secure versions.**  Monitor for known vulnerabilities in dependencies and promptly apply patches or updates. **Actionable:** Regularly run `bundle update` to update dependencies. Use `bundle audit` or similar tools to check for known vulnerabilities in dependencies. Automate dependency updates and vulnerability scanning as part of the CI/CD pipeline.

**4.8. Secure Deployment Practices:**

* **Recommendation 17 (Least Privilege for Containers):** **Run Sidekiq and Redis containers with the least privileges necessary.** Avoid running containers as root user. Use security contexts in Kubernetes to enforce least privilege. **Actionable:** Configure Dockerfiles and Kubernetes pod security contexts to run containers with non-root users and restricted capabilities.
* **Recommendation 18 (Container Image Security):** **Use minimal and hardened base images for Sidekiq and Redis containers.** Regularly scan container images for vulnerabilities and rebuild images when updates are available. **Actionable:** Choose minimal base images (e.g., Alpine Linux based images). Implement container image scanning in the CI/CD pipeline and regularly rebuild images to incorporate security updates.
* **Recommendation 19 (Kubernetes Network Policies):** **Implement Kubernetes network policies to restrict network traffic between pods and namespaces.**  Enforce network segmentation and limit communication to only necessary ports and protocols. **Actionable:** Define and implement Kubernetes network policies to isolate Sidekiq pods, Redis pods, and other application components.

### 5. Actionable and Tailored Mitigation Strategies

The following table summarizes the identified threats and provides actionable and tailored mitigation strategies for the Sidekiq application, categorized by component:

| Component          | Threat                                      | Mitigation Strategy                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  