## Deep Security Analysis of HTTParty Ruby Gem

### 1. Objective, Scope, and Methodology

**Objective:**

This deep security analysis aims to thoroughly evaluate the security posture of the HTTParty Ruby gem, focusing on identifying potential vulnerabilities and security risks that could impact Ruby applications utilizing this library. The analysis will dissect HTTParty's key components, inferred architecture, and data flow to provide specific, actionable security recommendations and mitigation strategies tailored to its usage. The ultimate goal is to enhance the security of applications that rely on HTTParty for interacting with external APIs and web services.

**Scope:**

The scope of this analysis encompasses the following:

*   **HTTParty Gem (https://github.com/jnunemaker/httparty):**  Focus on the gem's codebase (inferred architecture and functionality based on documentation and common HTTP client library patterns), dependencies, and documented features.
*   **Security Design Review Document:**  Utilize the provided security design review as a primary input, considering its business and security posture, existing and recommended security controls, security requirements, and risk assessment.
*   **Ruby Applications Using HTTParty:** Analyze the security implications for Ruby applications that integrate HTTParty to make HTTP requests to external systems.
*   **Data Flow:** Trace the flow of data through HTTParty, from request creation to response processing, identifying potential security touchpoints.

The scope explicitly excludes:

*   **Detailed Code Audit:**  A full source code audit of HTTParty is not within the scope. The analysis will be based on inferred architecture and common HTTP client library vulnerabilities.
*   **Security of External APIs:** The security of the external APIs and web services that HTTParty interacts with is outside the scope, except where HTTParty's behavior directly impacts the interaction security.
*   **General Web Application Security:**  Broad web application security principles are considered, but the focus remains on security aspects directly related to HTTParty.

**Methodology:**

This analysis will employ the following methodology:

1.  **Security Design Review Analysis:**  In-depth review of the provided security design review document to understand the business context, identified risks, existing controls, and security requirements.
2.  **Component and Architecture Inference:** Based on the documentation, common HTTP client library functionalities, and the provided C4 diagrams, infer the key components of HTTParty (Request Building, Connection Handling, Response Parsing, Authentication Handling, etc.) and its overall architecture.
3.  **Threat Modeling:**  Identify potential security threats relevant to each inferred component and data flow stage. This will include considering common web application vulnerabilities (e.g., injection attacks, TLS/SSL vulnerabilities, insecure dependency management) and risks specific to HTTP client libraries.
4.  **Security Control Mapping and Gap Analysis:** Map the existing and recommended security controls from the design review to the identified threats and components. Identify any gaps in security coverage.
5.  **Mitigation Strategy Development:**  For each identified threat and security gap, develop specific and actionable mitigation strategies tailored to HTTParty and its usage in Ruby applications. These strategies will be practical and implementable by developers using HTTParty.
6.  **Recommendation Generation:**  Formulate clear and concise security recommendations based on the analysis, focusing on enhancing the secure usage of HTTParty and addressing identified risks.

### 2. Security Implications of Key Components

Based on the provided documentation and common functionalities of HTTP client libraries, the key components of HTTParty and their security implications are analyzed below:

**a) Request Building:**

*   **Inferred Functionality:** HTTParty provides methods to construct HTTP requests, including setting URLs, headers, query parameters, request bodies, and HTTP methods (GET, POST, etc.).
*   **Security Implications:**
    *   **Header Injection:** If HTTParty does not properly sanitize or validate header values provided by the application, attackers could inject malicious headers. This could lead to vulnerabilities like HTTP Response Splitting or Cache Poisoning if the application's backend is also vulnerable.
    *   **URL Manipulation/Request Smuggling:**  Improper handling of URLs or parameters could allow attackers to manipulate the request in unintended ways, potentially leading to request smuggling vulnerabilities if the backend infrastructure is susceptible.
    *   **Sensitive Data Exposure in URLs/Logs:**  If developers inadvertently include sensitive data (e.g., API keys, session tokens) in URLs or query parameters, this data could be exposed in server logs, browser history, or network traffic. HTTParty itself might not directly cause this, but its ease of use could encourage less secure practices if developers are not cautious.

**b) Connection Handling (HTTPS Support):**

*   **Inferred Functionality:** HTTParty supports making requests over HTTPS, leveraging Ruby's standard libraries or underlying HTTP libraries for TLS/SSL connection establishment and management.
*   **Security Implications:**
    *   **TLS/SSL Configuration Weaknesses:**  If HTTParty or its underlying libraries use outdated or weak TLS/SSL protocols or cipher suites, connections could be vulnerable to downgrade attacks or eavesdropping.
    *   **Certificate Validation Issues:**  Improper certificate validation (e.g., disabling certificate verification for testing and leaving it in production, or vulnerabilities in certificate validation logic) could lead to Man-in-the-Middle (MITM) attacks.
    *   **Protocol Downgrade Attacks:**  Attackers might attempt to downgrade HTTPS connections to HTTP to intercept traffic. HTTParty should encourage or enforce HTTPS usage and resist protocol downgrade attempts.

**c) Response Parsing:**

*   **Inferred Functionality:** HTTParty parses HTTP responses, handling different content types (e.g., JSON, XML, HTML) and providing parsed data to the application.
*   **Security Implications:**
    *   **Denial of Service (DoS) via Malformed Responses:**  If HTTParty's parsing logic is not robust, it could be vulnerable to DoS attacks by sending specially crafted, malformed responses that consume excessive resources during parsing.
    *   **Vulnerabilities in Parsing Libraries:**  If HTTParty relies on external libraries for parsing specific content types (e.g., JSON parsing gems), vulnerabilities in these libraries could indirectly affect HTTParty and applications using it.
    *   **Information Disclosure via Error Handling:**  Verbose error messages during response parsing could inadvertently disclose sensitive information about the application or the external API.

**d) Authentication Handling:**

*   **Inferred Functionality:** HTTParty supports various authentication methods like Basic Auth, Bearer tokens, API keys in headers or query parameters.
*   **Security Implications:**
    *   **Insecure Credential Handling in User Applications:** While HTTParty itself might provide mechanisms for authentication, the responsibility of securely storing and managing credentials lies with the developers using HTTParty. Misuse by developers (e.g., hardcoding credentials, storing them in insecure configurations) is a significant risk.
    *   **Exposure of Credentials in Transit (HTTP):** If developers mistakenly use HTTP instead of HTTPS for requests that include authentication credentials, these credentials could be intercepted in transit.
    *   **Insufficient Documentation on Secure Authentication Practices:**  Lack of clear and comprehensive documentation on secure authentication practices with HTTParty could lead developers to implement authentication insecurely.

**e) Dependency Management:**

*   **Inferred Functionality:** HTTParty relies on other Ruby gems as dependencies, as indicated in the security design review.
*   **Security Implications:**
    *   **Vulnerabilities in Dependencies:**  HTTParty is vulnerable to security issues present in its dependencies. Outdated or vulnerable dependencies can introduce security flaws into HTTParty and applications using it.
    *   **Transitive Dependencies:**  Vulnerabilities in transitive dependencies (dependencies of HTTParty's direct dependencies) can also pose a risk, even if not directly listed in HTTParty's `Gemfile.lock`.

### 3. Architecture, Components, and Data Flow (Based on Inference)

**Architecture:** HTTParty acts as a high-level Ruby wrapper around lower-level HTTP client functionalities. It likely leverages Ruby's standard libraries for core HTTP operations or potentially other HTTP gems for specific features.  It aims to simplify HTTP request creation and response handling for Ruby developers.

**Components (Inferred):**

1.  **Request Builder Module:**  Responsible for constructing HTTP requests based on user-provided parameters (URL, headers, body, method, authentication details).
2.  **Connection Manager Module:** Handles establishing and managing HTTP connections, including HTTPS/TLS handshake, connection pooling, and potentially proxy configurations.
3.  **Request Dispatcher Module:** Sends the constructed HTTP request over the network using the established connection.
4.  **Response Parser Module:** Receives and parses the HTTP response, handling headers, status codes, and response bodies in various formats (JSON, XML, etc.).
5.  **Authentication Handler Module:**  Provides functionalities for implementing different authentication methods, likely by manipulating request headers or parameters.
6.  **Dependency Manager (Implicit):** Relies on RubyGems for managing its dependencies.

**Data Flow:**

1.  **Application Request Initiation:** Ruby application code calls HTTParty methods to initiate an HTTP request (e.g., `HTTParty.get`, `HTTParty.post`).
2.  **Request Construction:** The Request Builder module constructs the HTTP request object based on the provided parameters.
3.  **Connection Establishment:** The Connection Manager module establishes a connection to the target server (if not already established or pooled). For HTTPS, this includes TLS/SSL handshake.
4.  **Request Transmission:** The Request Dispatcher module sends the constructed HTTP request over the established connection.
5.  **Response Reception:** HTTParty receives the HTTP response from the server.
6.  **Response Parsing:** The Response Parser module parses the HTTP response, extracting headers, status code, and body content.
7.  **Data Return to Application:** HTTParty returns the parsed response data (often as a Ruby object or hash) to the calling Ruby application code.
8.  **Application Processing:** The Ruby application processes the received data.

### 4. Specific Security Recommendations for HTTParty Project

Based on the analysis, here are specific security recommendations tailored to the HTTParty project:

**For HTTParty Gem Development:**

1.  **Implement Robust Input Sanitization for Headers and URLs:**
    *   **Recommendation:**  Thoroughly sanitize and validate all user-provided input that is used to construct HTTP headers and URLs. Use parameterized queries or prepared statements where applicable to prevent injection attacks.
    *   **Actionable Mitigation:**  Implement input validation functions within the Request Builder module to check for potentially malicious characters or patterns in headers and URLs before sending requests. Document these sanitization practices for developers.

2.  **Enforce Secure TLS/SSL Configuration:**
    *   **Recommendation:**  Ensure HTTParty uses secure TLS/SSL configurations by default.  Prefer strong cipher suites and TLS versions. Consider providing options for users to customize TLS settings, but with clear warnings about the security implications of weaker configurations.
    *   **Actionable Mitigation:**  Review and update the TLS/SSL configuration within HTTParty's connection handling logic.  Document best practices for TLS/SSL configuration for users who need to customize it. Consider using libraries that simplify secure TLS configuration.

3.  **Strengthen Response Parsing Robustness:**
    *   **Recommendation:**  Implement robust error handling and resource limits in response parsing to prevent DoS attacks via malformed responses.  Consider using well-vetted and actively maintained parsing libraries.
    *   **Actionable Mitigation:**  Implement checks for excessively large responses and timeouts during parsing.  Ensure error handling in parsing logic does not expose sensitive information. Regularly update parsing libraries to patch known vulnerabilities.

4.  **Provide Comprehensive and Secure Authentication Documentation:**
    *   **Recommendation:**  Create detailed documentation and examples demonstrating how to securely implement various authentication methods with HTTParty. Emphasize secure credential storage and handling practices *within the application using HTTParty*.
    *   **Actionable Mitigation:**  Develop dedicated documentation sections and code examples for each supported authentication method (Basic Auth, Bearer tokens, API keys).  Include security warnings about insecure practices (e.g., hardcoding credentials).  Link to external resources on secure credential management.

5.  **Automate Dependency Vulnerability Scanning and Management:**
    *   **Recommendation:**  Integrate automated dependency scanning tools into the HTTParty development CI/CD pipeline to identify and address vulnerabilities in dependencies proactively.
    *   **Actionable Mitigation:**  Incorporate tools like `bundler-audit` or `dependency-check` into the CI/CD pipeline.  Establish a process for promptly reviewing and updating vulnerable dependencies.  Consider using dependency pinning to ensure consistent and secure dependency versions.

6.  **Implement Static Application Security Testing (SAST):**
    *   **Recommendation:**  Integrate SAST tools into the HTTParty development CI/CD pipeline to automatically analyze the codebase for potential security vulnerabilities during development.
    *   **Actionable Mitigation:**  Choose and integrate a suitable SAST tool (e.g., Brakeman for Ruby) into the CI/CD pipeline.  Configure the tool to scan for common web application vulnerabilities and HTTP client library-specific issues.  Establish a process for reviewing and remediating findings from SAST scans.

7.  **Consider Code Signing for Gem Package:**
    *   **Recommendation:**  Implement code signing for the HTTParty gem package published to RubyGems to ensure integrity and authenticity.
    *   **Actionable Mitigation:**  Explore RubyGems' code signing capabilities and integrate code signing into the release process within the CI/CD pipeline.  Document the code signing process for users to verify the integrity of the gem.

**For Developers Using HTTParty in Ruby Applications:**

1.  **Always Use HTTPS for Sensitive Communications:**
    *   **Recommendation:**  Enforce HTTPS for all requests, especially when transmitting sensitive data or authentication credentials.
    *   **Actionable Mitigation:**  Configure HTTParty to default to HTTPS.  Clearly document the importance of HTTPS and provide examples of how to ensure HTTPS usage.

2.  **Securely Manage and Store API Keys and Credentials:**
    *   **Recommendation:**  Never hardcode API keys or credentials directly in the application code. Use environment variables, secure configuration management tools (e.g., HashiCorp Vault), or dedicated secrets management solutions to store and retrieve credentials.
    *   **Actionable Mitigation:**  Provide clear guidance in HTTParty documentation on secure credential management.  Include examples of using environment variables or configuration files to store API keys.

3.  **Validate and Sanitize Data Received from External APIs:**
    *   **Recommendation:**  Treat data received from external APIs as untrusted.  Implement robust input validation and sanitization in the application code *after* receiving responses from HTTParty, before using this data within the application.
    *   **Actionable Mitigation:**  Document the importance of input validation for API responses in HTTParty's documentation.  Provide examples of common validation techniques for different data types (e.g., JSON, XML).

4.  **Implement Proper Error Handling and Logging:**
    *   **Recommendation:**  Implement robust error handling in the application code to gracefully handle HTTP request failures and API errors.  Log relevant information for debugging and security monitoring, but avoid logging sensitive data.
    *   **Actionable Mitigation:**  Provide guidance on error handling best practices in HTTParty documentation.  Emphasize the importance of secure logging practices and avoiding logging sensitive information in logs.

5.  **Regularly Update HTTParty and its Dependencies:**
    *   **Recommendation:**  Keep HTTParty and all its dependencies up-to-date to patch known security vulnerabilities.  Implement automated dependency update processes.
    *   **Actionable Mitigation:**  Advise users to use dependency management tools like Bundler to manage and update gem dependencies.  Recommend setting up automated dependency update checks and processes.

### 5. Actionable and Tailored Mitigation Strategies

The following table summarizes actionable and tailored mitigation strategies for the identified threats, specifically for HTTParty:

| Threat                                  | Mitigation Strategy (HTTParty Gem Development)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     