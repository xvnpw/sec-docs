Okay, here's a deep analysis of the security considerations for Next.js, based on the provided design review.

**1. Objective, Scope, and Methodology**

*   **Objective:** To conduct a thorough security analysis of key components of the Next.js framework, identify potential vulnerabilities, and provide actionable mitigation strategies.  The analysis will focus on how Next.js features and common deployment patterns impact application security, rather than general web security best practices.  We aim to provide specific recommendations tailored to Next.js development.

*   **Scope:**  The analysis will cover the following key areas:
    *   Server-Side Rendering (SSR) and its security implications.
    *   Static Site Generation (SSG) and its security implications.
    *   API Routes and their security considerations.
    *   Client-side security within the Next.js context.
    *   Data fetching methods (`getServerSideProps`, `getStaticProps`, `getInitialProps`).
    *   Deployment environments (specifically Vercel, as detailed in the design document).
    *   Build process security.
    *   Common Next.js-specific misconfigurations.
    *   Interaction with external services (databases, APIs, authentication providers).

*   **Methodology:**
    1.  **Component Breakdown:** Analyze the security implications of each key component listed above, drawing from the provided design document, Next.js official documentation, and known security best practices.
    2.  **Threat Modeling:**  Identify potential threats specific to each component, considering the business risks and accepted risks outlined in the design review.  We'll use a simplified threat modeling approach, focusing on common attack vectors.
    3.  **Mitigation Strategies:**  Propose actionable and Next.js-specific mitigation strategies for each identified threat.  These will be practical recommendations that developers can implement.
    4.  **Architecture Inference:**  Based on the C4 diagrams and descriptions, we'll infer the security posture of the architecture and identify potential weaknesses.

**2. Security Implications of Key Components**

Let's break down the security implications of each key component:

*   **2.1 Server-Side Rendering (SSR)**

    *   **Implications:** SSR executes code on the server for each request, potentially exposing server-side resources to vulnerabilities.  It's crucial to sanitize any user input used during rendering.
    *   **Threats:**
        *   **Cross-Site Scripting (XSS):**  If user input is directly injected into the rendered HTML without proper escaping, attackers can inject malicious scripts.  While React's JSX helps mitigate this, improper use of `dangerouslySetInnerHTML` or server-side string manipulation can bypass these protections.  *Next.js Specific:*  This is particularly relevant in SSR because the server is generating the initial HTML.
        *   **Server-Side Request Forgery (SSRF):**  If the server-side code makes requests to other resources based on user input, an attacker could manipulate the input to access internal systems or unintended external resources.  *Next.js Specific:*  This is a risk within `getServerSideProps` if it fetches data from URLs constructed using user-supplied data.
        *   **Denial of Service (DoS):**  Complex or resource-intensive rendering operations triggered by malicious input could overwhelm the server.  *Next.js Specific:*  Large data sets or computationally expensive operations within `getServerSideProps` could be exploited.
        *   **Data Exposure:**  Errors or exceptions during server-side rendering could leak sensitive information to the client.  *Next.js Specific:*  Careless error handling in `getServerSideProps` could expose API keys or database connection strings.
        *   **Injection Attacks (NoSQL/SQL):** If SSR involves database queries based on user input, injection attacks are possible. *Next.js Specific:* Occurs if `getServerSideProps` directly uses user input in database queries without proper sanitization or parameterized queries.

    *   **Mitigation Strategies:**
        *   **Strict Input Validation and Sanitization:**  Always validate and sanitize *all* user input used in `getServerSideProps`, even if it seems safe. Use libraries like Zod or Yup for schema validation.
        *   **Avoid `dangerouslySetInnerHTML`:**  Minimize its use, and if necessary, sanitize the input with a dedicated HTML sanitization library like `dompurify`.
        *   **Parameterized Queries:**  Use parameterized queries or an ORM to prevent SQL/NoSQL injection.  Never construct queries by concatenating strings with user input.
        *   **Safe URL Construction:**  If fetching data from external resources based on user input, validate the URL structure and use a whitelist of allowed domains.  Avoid directly using user-supplied URLs.
        *   **Resource Limiting:**  Implement timeouts and resource limits for server-side rendering operations to prevent DoS attacks.  Consider using a queue system for expensive operations.
        *   **Robust Error Handling:**  Implement custom error pages and avoid exposing sensitive information in error messages.  Log errors securely on the server.
        *   **Content Security Policy (CSP):**  A strong CSP is crucial to mitigate XSS, even with React's built-in protections.

*   **2.2 Static Site Generation (SSG)**

    *   **Implications:** SSG generates HTML at build time, reducing the attack surface at runtime.  However, data fetched at build time can become stale, and any dynamic content requires client-side rendering or API routes.
    *   **Threats:**
        *   **Stale Data:**  Sensitive information exposed in statically generated pages might become outdated and inaccurate, potentially leading to security or privacy issues.  *Next.js Specific:*  Data fetched in `getStaticProps` is fixed at build time.
        *   **Build-Time Vulnerabilities:**  Vulnerabilities in build tools or dependencies could compromise the generated static assets.  *Next.js Specific:*  Vulnerabilities in Next.js itself or its build process.
        *   **Exposure of Build-Time Secrets:**  If secrets are accidentally included in the build process, they could be exposed in the generated static assets.  *Next.js Specific:*  Incorrectly handling environment variables during the build.

    *   **Mitigation Strategies:**
        *   **Regular Rebuilds:**  Configure automated rebuilds to refresh data and apply security updates.  The frequency depends on the data's volatility.
        *   **Secure Build Environment:**  Use a secure CI/CD pipeline with limited access and regular security audits.
        *   **Environment Variable Management:**  Use environment variables carefully and avoid hardcoding secrets.  Use a dedicated secret management solution for sensitive data.  *Next.js Specific:*  Understand the difference between public (`NEXT_PUBLIC_`) and private environment variables.
        *   **Incremental Static Regeneration (ISR):** Use ISR to update pages on a schedule or on-demand, balancing performance with data freshness.
        *   **Client-Side Data Fetching for Dynamic Content:**  For highly dynamic content, fetch data on the client-side after the initial static page load.

*   **2.3 API Routes**

    *   **Implications:** API routes are serverless functions that handle API requests.  They are a common target for attackers.
    *   **Threats:**
        *   **All OWASP Top 10 Vulnerabilities:**  API routes are susceptible to all common web vulnerabilities, including injection attacks, broken authentication, sensitive data exposure, etc.
        *   **CSRF:**  If API routes modify data, they need CSRF protection.  *Next.js Specific:*  Next.js doesn't provide built-in CSRF protection for API routes; it must be implemented manually.
        *   **Rate Limiting:**  Without rate limiting, attackers can flood API routes with requests, leading to DoS.
        *   **Unvalidated Redirects and Forwards:**  If API routes redirect users based on input, attackers can redirect them to malicious sites.

    *   **Mitigation Strategies:**
        *   **Authentication and Authorization:**  Implement robust authentication and authorization for all API routes that require it.  Use libraries like NextAuth.js or integrate with an external authentication provider.
        *   **Input Validation and Sanitization:**  Validate and sanitize all input to API routes, using a schema validation library.
        *   **CSRF Protection:**  Implement CSRF protection using tokens.  Libraries like `csrf` can help.
        *   **Rate Limiting:**  Implement rate limiting using libraries like `rate-limiter-flexible` or a service like Vercel's built-in rate limiting (if available).
        *   **Output Encoding:**  Ensure that data returned by API routes is properly encoded to prevent XSS.
        *   **Secure Headers:**  Set appropriate security headers in API responses (e.g., `Content-Type`, `X-Content-Type-Options`).
        *   **Avoid Unvalidated Redirects:**  Validate redirect URLs to prevent open redirect vulnerabilities.

*   **2.4 Client-Side Security**

    *   **Implications:**  Even with SSR/SSG, client-side code is still executed in the user's browser and is vulnerable to client-side attacks.
    *   **Threats:**
        *   **DOM XSS:**  If client-side code manipulates the DOM based on user input without proper sanitization, attackers can inject malicious scripts.  *Next.js Specific:*  This can occur in event handlers, custom components, or when using third-party libraries that manipulate the DOM.
        *   **Third-Party Library Vulnerabilities:**  Vulnerabilities in client-side libraries can be exploited.

    *   **Mitigation Strategies:**
        *   **Sanitize User Input:**  Sanitize any user input that is used to update the DOM, even if it's already been sanitized on the server.
        *   **Use React's Security Features:**  Leverage React's built-in XSS protection mechanisms (e.g., JSX escaping).
        *   **Regularly Update Dependencies:**  Keep client-side libraries up to date to address security vulnerabilities.
        *   **Content Security Policy (CSP):**  A strong CSP is essential for mitigating client-side attacks.
        *   **Subresource Integrity (SRI):**  Use SRI to ensure that external scripts haven't been tampered with.

*   **2.5 Data Fetching Methods (`getServerSideProps`, `getStaticProps`, `getInitialProps`)**

    *   **Implications:** These methods control how and when data is fetched, impacting security.
    *   **Threats:**  (See SSR and SSG sections above for specific threats related to each method.)
    *   **Mitigation Strategies:**
        *   **Choose the Right Method:**  Use `getStaticProps` for data that can be fetched at build time, `getServerSideProps` for data that needs to be fetched on each request, and `getInitialProps` sparingly (it can impact performance and has been largely superseded by the other two).
        *   **Apply SSR/SSG Mitigations:**  Apply the relevant mitigation strategies outlined in the SSR and SSG sections, depending on which method is used.

*   **2.6 Deployment Environment (Vercel)**

    *   **Implications:** Vercel provides a secure platform, but misconfigurations can still lead to vulnerabilities.
    *   **Threats:**
        *   **Misconfigured Environment Variables:**  Exposing sensitive environment variables publicly.
        *   **Insecure Serverless Function Configuration:**  Incorrectly configuring IAM roles or function-level security settings.
        *   **Lack of WAF:**  Not enabling Vercel's WAF (if available) to protect against common web attacks.
        *   **DDoS:** While Vercel provides some DDoS protection, large-scale attacks could still impact availability.

    *   **Mitigation Strategies:**
        *   **Review Vercel Documentation:**  Thoroughly understand Vercel's security features and best practices.
        *   **Secure Environment Variables:**  Use Vercel's environment variable management system correctly, distinguishing between public and private variables.
        *   **Least Privilege for Serverless Functions:**  Configure IAM roles with the principle of least privilege, granting only the necessary permissions to serverless functions.
        *   **Enable WAF:**  Enable Vercel's WAF (if available) and configure it appropriately.
        *   **Monitor Logs:**  Regularly monitor Vercel's logs for suspicious activity.
        *   **Consider Additional DDoS Protection:**  For high-traffic applications, consider using a dedicated DDoS protection service.

*   **2.7 Build Process Security**

    *   **Implications:** The build process is a critical part of the software supply chain.
    *   **Threats:**
        *   **Dependency Vulnerabilities:**  Vulnerabilities in build tools or dependencies.
        *   **Compromised CI/CD Pipeline:**  Attackers gaining access to the CI/CD pipeline and injecting malicious code.
        *   **Code Injection during Build:**  Malicious code being injected into the build process.

    *   **Mitigation Strategies:**
        *   **Dependency Scanning:**  Use tools like `npm audit`, `yarn audit`, or Snyk to scan for vulnerable dependencies.
        *   **Secure CI/CD Pipeline:**  Implement strong access controls, audit logs, and other security measures for the CI/CD pipeline.
        *   **Code Signing:**  Consider code signing to ensure the integrity of build artifacts.
        *   **SAST:** Integrate static analysis tools into the build process.
        *   **Regularly Update Build Tools:** Keep build tools and CI/CD systems up to date.

*   **2.8 Common Next.js-Specific Misconfigurations**

    *   **Improper use of `next/link`:** Using `<a href="">` instead of `<Link href="">` for internal links bypasses Next.js's routing and prefetching, potentially leading to performance issues and unexpected behavior. While not a direct security vulnerability, it can lead to inconsistencies.
    *   **Incorrectly handling API keys:** Storing API keys directly in client-side code or exposing them through server-side rendering without proper precautions.
    *   **Not using HTTPS in production:** Deploying a Next.js application without HTTPS.
    *   **Ignoring CORS configuration:** Not properly configuring Cross-Origin Resource Sharing (CORS) for API routes, leading to potential security issues.
    *   **Overly permissive file permissions:** Setting overly permissive file permissions on the server, potentially exposing sensitive files.

    *   **Mitigation Strategies:**
        *   **Follow Next.js Best Practices:**  Adhere to the recommendations in the official Next.js documentation.
        *   **Code Reviews:**  Conduct thorough code reviews to identify potential misconfigurations.
        *   **Automated Security Testing:**  Use automated security testing tools to detect common vulnerabilities.

*   **2.9 Interaction with External Services**

    *   **Implications:**  Next.js applications often interact with external services (databases, APIs, authentication providers).
    *   **Threats:**
        *   **Data Breaches:**  Vulnerabilities in external services could lead to data breaches.
        *   **Compromised Credentials:**  Stolen API keys or database credentials could be used to access sensitive data.
        *   **Man-in-the-Middle (MitM) Attacks:**  If communication with external services is not secure, attackers could intercept and modify data.

    *   **Mitigation Strategies:**
        *   **Use Secure Communication:**  Use HTTPS for all communication with external services.
        *   **Securely Store Credentials:**  Use a dedicated secret management solution to store API keys and database credentials.
        *   **Least Privilege:**  Grant external services only the necessary permissions.
        *   **Monitor External Service Security:**  Stay informed about the security posture of external services and any known vulnerabilities.
        *   **Implement Fallback Mechanisms:**  Design the application to handle failures in external services gracefully.

**3. Architecture Inference and Weaknesses**

Based on the C4 diagrams and descriptions, here are some potential architectural weaknesses:

*   **Centralized API Routes:**  If all API logic is concentrated in a few API routes, these become high-value targets.  Consider breaking down large API routes into smaller, more manageable functions.
*   **Direct Database Access from API Routes:**  If API routes directly access the database, any vulnerability in an API route could expose the entire database.  Consider using an intermediary layer (e.g., a service layer or an ORM) to abstract database access.
*   **Lack of Input Validation at Multiple Layers:**  Relying solely on client-side validation or server-side validation in `getServerSideProps` is insufficient.  Validate input at multiple layers (client-side, API routes, and before interacting with databases or external services).
*   **Insufficient Monitoring and Logging:**  Without adequate monitoring and logging, it's difficult to detect and respond to security incidents.  Implement comprehensive logging and monitoring for all components of the application.
*   **Over-reliance on Vercel's Default Security:** While Vercel provides a good baseline, don't assume it covers all security needs. Implement additional security controls as needed.

**4. Tailored Mitigation Strategies (Summary)**

This table summarizes the key mitigation strategies, tailored to Next.js:

| Threat Category        | Next.js Specific Threat                                                                                                | Mitigation Strategy                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    