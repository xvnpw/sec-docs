## Deep Security Analysis of Koa.js Application

### 1. Objective, Scope, and Methodology

**Objective:**

The objective of this deep security analysis is to thoroughly evaluate the security posture of a web application built using the Koa.js framework. This analysis aims to identify potential vulnerabilities and security risks inherent in the Koa.js architecture, its middleware ecosystem, and common web application security practices within the context of the described system. The analysis will focus on providing actionable and tailored security recommendations and mitigation strategies specific to Koa.js to enhance the application's overall security.

**Scope:**

This security analysis encompasses the following aspects of the Koa.js application, as defined in the Security Design Review:

*   **Koa.js Framework Core:** Analysis of the inherent security characteristics and potential vulnerabilities within the Koa.js core framework itself.
*   **Middleware Stack:** Examination of the security implications of using middleware in Koa.js, including both custom and community-maintained middleware, focusing on potential vulnerabilities and misconfigurations.
*   **Application Code:** Review of security considerations related to the custom application logic built on top of Koa.js, including common web application vulnerabilities like injection flaws, authentication, and authorization issues.
*   **Node.js Runtime Environment:** Assessment of security aspects related to the underlying Node.js runtime environment that executes the Koa.js application.
*   **Deployment Architecture (Containerized with Kubernetes):** Analysis of security considerations specific to the described containerized deployment in a Kubernetes environment, including container security, network policies, and load balancer configurations.
*   **Build Process (CI/CD Pipeline):** Evaluation of the security of the build pipeline, including dependency management, static analysis, and container image building.
*   **Data Flow and Interactions:** Understanding the data flow within the application and its interactions with databases and external services to identify potential points of vulnerability.

**Methodology:**

This deep security analysis will employ a structured approach based on the provided Security Design Review and the characteristics of Koa.js. The methodology includes:

1.  **Document Review:** In-depth review of the Security Design Review document, including business posture, security posture, design diagrams (C4 Context, C4 Container, Deployment, Build), risk assessment, and questions/assumptions.
2.  **Component-Based Analysis:** Breaking down the Koa.js application into its key components (Koa Core, Middleware Stack, Application Code, Node.js Process, Databases, External Services) as depicted in the C4 Container diagram.
3.  **Threat Modeling:** For each component, identifying potential security threats and vulnerabilities, considering common web application security risks (OWASP Top 10), Koa.js-specific characteristics, and the described deployment environment.
4.  **Data Flow Mapping:** Analyzing the data flow within the application to understand how data is processed and transmitted, identifying potential data leakage or manipulation points.
5.  **Risk Assessment (Qualitative):** Evaluating the potential impact and likelihood of identified threats based on the business risks and security posture outlined in the Security Design Review.
6.  **Mitigation Strategy Development:** Formulating actionable and tailored mitigation strategies for each identified threat, specifically focusing on Koa.js best practices, middleware utilization, and secure coding principles.
7.  **Recommendation Tailoring:** Ensuring that all security recommendations are specific to Koa.js and the described application architecture, avoiding generic security advice and focusing on practical implementation within the Koa.js ecosystem.
8.  **Actionability and Prioritization:** Prioritizing mitigation strategies based on risk level and feasibility of implementation, providing clear and actionable steps for the development team.

### 2. Security Implications of Key Components

Based on the C4 Container diagram and the Security Design Review, the key components of the Koa.js application and their security implications are analyzed below:

**a) Node.js Process:**

*   **Security Implications:** The Node.js process is the foundation upon which the Koa.js application runs. Vulnerabilities in the Node.js runtime itself (e.g., in V8 engine, core modules) can directly compromise the application. Running outdated or unpatched Node.js versions exposes the application to known vulnerabilities. Process-level security misconfigurations, such as running the process as root within containers, can lead to privilege escalation if vulnerabilities are exploited. Resource exhaustion at the Node.js process level can lead to Denial of Service (DoS).
*   **Specific Koa.js Context:** Koa.js is entirely dependent on Node.js. Security of the Node.js runtime is paramount for the security of any Koa.js application.

**b) Koa Core:**

*   **Security Implications:** While Koa.js core is designed to be minimal, vulnerabilities within the core framework itself could have widespread impact on applications built using it. Potential vulnerabilities could arise in request parsing, context creation, or core middleware execution logic. Bugs in handling HTTP requests and responses could be exploited.
*   **Specific Koa.js Context:** Koa's minimalist nature reduces the attack surface of the core itself compared to larger frameworks. However, any vulnerability in the core would be critical due to its fundamental role.

**c) Middleware Stack:**

*   **Security Implications:** The middleware stack is central to Koa.js applications. Security vulnerabilities can arise from:
    *   **Vulnerabilities in Middleware Libraries:** Third-party middleware, especially community-maintained ones, may contain vulnerabilities if not actively maintained or securely developed. Dependency vulnerabilities in middleware are a significant risk.
    *   **Insecure Custom Middleware:** Custom middleware developed for specific application needs might introduce vulnerabilities if not implemented with security in mind (e.g., authentication bypass, authorization flaws, input validation gaps).
    *   **Middleware Misconfiguration:** Incorrect ordering or configuration of middleware can negate security controls. For example, placing an authorization middleware before an authentication middleware could lead to bypasses.
    *   **Performance Issues:** Inefficient middleware can lead to performance bottlenecks and potentially contribute to DoS vulnerabilities.
*   **Specific Koa.js Context:** Koa.js's architecture heavily relies on middleware. The security of the application is directly proportional to the security of its middleware stack. The reliance on community middleware introduces supply chain security risks.

**d) Application Code:**

*   **Security Implications:** The custom application code is where most common web application vulnerabilities are introduced. These include:
    *   **Injection Flaws:** SQL injection, NoSQL injection, Command Injection, Cross-Site Scripting (XSS), etc., due to improper input validation and output encoding.
    *   **Broken Authentication and Authorization:** Weak or flawed authentication mechanisms, improper session management, and inadequate authorization controls leading to unauthorized access.
    *   **Insecure Deserialization:** Vulnerabilities arising from deserializing untrusted data, potentially leading to remote code execution.
    *   **Insufficient Logging and Monitoring:** Lack of proper logging and monitoring can hinder incident detection and response.
    *   **Business Logic Flaws:** Vulnerabilities in the application's business logic that can be exploited for malicious purposes.
*   **Specific Koa.js Context:** Developers need to apply secure coding practices within the Koa.js context. Koa's `ctx` object provides access to request and response objects, which must be handled securely to prevent vulnerabilities.

**e) Databases:**

*   **Security Implications:** Databases are critical for data persistence and are prime targets for attackers. Security risks include:
    *   **SQL/NoSQL Injection:** As mentioned above, if application code interacts with databases without proper input sanitization.
    *   **Database Access Control Issues:** Weak or misconfigured database access controls can allow unauthorized access to sensitive data.
    *   **Data Breaches:** If databases are not properly secured, they can be targets for data breaches, leading to exposure of sensitive information.
    *   **Lack of Encryption:** Sensitive data stored at rest or in transit to the database should be encrypted to protect confidentiality.
*   **Specific Koa.js Context:** Koa.js applications often interact with databases. Secure database connection management, parameterized queries or ORMs to prevent injection, and robust access controls are essential.

**f) External Services:**

*   **Security Implications:** Interactions with external services introduce new attack vectors:
    *   **Insecure API Integrations:** Vulnerabilities in external APIs or insecure communication protocols (e.g., using HTTP instead of HTTPS) can expose data or functionalities.
    *   **API Key Management:** Improper storage or exposure of API keys can lead to unauthorized access to external services.
    *   **Data Exposure through External Services:** Data sent to or received from external services might be vulnerable if not handled securely.
    *   **Dependency on External Service Security:** The security of the Koa.js application can be impacted by vulnerabilities in the external services it depends on.
*   **Specific Koa.js Context:** Koa.js applications frequently integrate with external APIs. Secure API key management, input validation of data received from external services, and using HTTPS for all external communication are crucial.

### 3. Architecture, Components, and Data Flow Inference

Based on the provided diagrams and descriptions, the architecture, components, and data flow of the Koa.js application can be inferred as follows:

**Architecture:**

The application follows a layered architecture, typical of web applications, built upon the middleware-centric approach of Koa.js. It consists of:

*   **Presentation Layer:** Handled by Koa.js middleware and application code, responsible for receiving user requests, processing them, and generating responses.
*   **Application Logic Layer:** Implemented in custom application code and middleware, containing the core business logic, routing, controllers, and data processing.
*   **Data Access Layer:** Interacts with databases for data persistence and retrieval.
*   **External Integration Layer:** Handles communication with external services and APIs.

**Components:**

*   **Users:** Initiate HTTP requests to access the application.
*   **Load Balancer:** Distributes incoming traffic across multiple Koa.js application instances (Pods in Kubernetes).
*   **Koa.js App Pods (Containers):** Run instances of the Koa.js application, each containing:
    *   **Node.js Process:** Executes the Koa.js application.
    *   **Koa Core:** Handles request routing and middleware execution.
    *   **Middleware Stack:** Processes requests and responses, implementing security controls and application logic.
    *   **Application Code:** Custom code for specific application functionalities.
*   **Database Pod:** Stores and manages application data.
*   **External Services:** Third-party APIs or services integrated with the application.
*   **CI/CD Pipeline:** Automates the build, test, and deployment process.
*   **Code Repository:** Stores the application source code.
*   **Container Registry:** Stores container images for deployment.

**Data Flow:**

1.  **User Request:** A user sends an HTTP request to the application's domain, which is routed to the Load Balancer.
2.  **Load Balancing:** The Load Balancer distributes the request to one of the available Koa.js App Pods.
3.  **Request Handling in Koa.js:**
    *   The request enters the Node.js process within the App Pod.
    *   Koa Core receives the request and creates a context object (`ctx`).
    *   The request passes through the Middleware Stack in a defined order. Middleware can perform actions like:
        *   Logging requests.
        *   Authentication and authorization checks.
        *   Input validation.
        *   Request modification.
    *   After middleware processing, the request reaches the Application Code (route handlers/controllers).
4.  **Application Logic and Data Interaction:**
    *   Application code processes the request, potentially interacting with:
        *   **Databases:** To retrieve or store data.
        *   **External Services:** To fetch data or perform external operations.
5.  **Response Generation:** Application code generates an HTTP response.
6.  **Response Middleware Processing:** The response passes back through the Middleware Stack (in reverse order for some middleware). Middleware can perform actions like:
        *   Adding security headers.
        *   Logging responses.
        *   Error handling.
7.  **Response to User:** Koa Core sends the HTTP response back to the Load Balancer, which then forwards it to the User's browser or client.

### 4. Specific Recommendations Tailored to Koa.js Mitigation Strategies

Based on the identified security implications and the Koa.js architecture, here are specific and actionable mitigation strategies tailored to this project:

**a) Middleware-Centric Security Implementation:**

*   **Recommendation:** Leverage Koa.js's middleware architecture to implement security controls in a modular and reusable way. Prioritize using well-established and actively maintained security middleware for common tasks.
*   **Specific Koa.js Action:**
    *   **Authentication Middleware:** Implement authentication using middleware like `koa-jwt` for JWT-based authentication or `koa-session` for session-based authentication. Choose middleware that supports secure session management (e.g., using `httpOnly`, `secure` flags for cookies).
    *   **Authorization Middleware:** Implement authorization checks using middleware that can enforce Role-Based Access Control (RBAC) or Attribute-Based Access Control (ABAC). Consider libraries like `koa- Casbin` or custom middleware that integrates with an authorization service.
    *   **Input Validation Middleware:** Implement input validation using middleware like `koa-joi-router` with Joi or `koa-validate`. Define schemas for request parameters, headers, and bodies to enforce data integrity and prevent injection attacks.
    *   **Rate Limiting Middleware:** Protect against DoS attacks by implementing rate limiting middleware like `koa-ratelimit`. Configure appropriate rate limits based on application usage patterns.
    *   **Security Headers Middleware:** Use middleware like `koa-helmet` to automatically set security-related HTTP headers (e.g., `X-Frame-Options`, `X-Content-Type-Options`, `Content-Security-Policy`, `Strict-Transport-Security`).
    *   **CORS Middleware:** If necessary, configure CORS middleware like `koa-cors` securely, allowing only trusted origins to access the application's resources.

**b) Secure Coding Practices in Application Code:**

*   **Recommendation:** Educate developers on secure coding practices specific to Koa.js and Node.js. Emphasize input validation, output encoding, parameterized queries, and secure session management.
*   **Specific Koa.js Action:**
    *   **Input Validation:** Always validate user inputs on the server-side, even if client-side validation is in place. Use validation libraries (like Joi) within route handlers to validate request data before processing.
    *   **Output Encoding:** Encode output data properly based on the context (e.g., HTML encoding for preventing XSS in HTML responses, URL encoding for URLs).
    *   **Parameterized Queries/ORMs:** Use parameterized queries or Object-Relational Mappers (ORMs) to interact with databases to prevent SQL/NoSQL injection vulnerabilities. Avoid constructing SQL queries by concatenating user inputs directly.
    *   **Secure Session Management:** If using session-based authentication, ensure sessions are stored securely (e.g., in a database or secure store), use strong session IDs, and implement proper session invalidation.
    *   **Error Handling:** Implement robust error handling to prevent sensitive information leakage in error responses. Use a dedicated error handling middleware to catch exceptions and return generic error messages to clients while logging detailed errors securely.
    *   **Logging and Monitoring:** Implement comprehensive logging to track security-relevant events (authentication attempts, authorization failures, input validation errors, etc.). Integrate with monitoring tools to detect and respond to security incidents.

**c) Node.js and Dependency Security:**

*   **Recommendation:** Keep Node.js runtime and all dependencies, including Koa.js and middleware libraries, updated to the latest versions to patch known vulnerabilities. Implement dependency vulnerability scanning in the CI/CD pipeline.
*   **Specific Koa.js Action:**
    *   **Node.js Version Management:** Use Node.js version management tools (e.g., `nvm`, `nodenv`) to easily manage and update Node.js versions. Regularly update Node.js to the latest LTS or actively maintained version.
    *   **Dependency Vulnerability Scanning:** Integrate `npm audit` or `yarn audit` into the CI/CD pipeline to automatically scan for dependency vulnerabilities during builds. Fail builds if critical vulnerabilities are detected.
    *   **Dependency Management:** Use `npm` or `yarn` to manage dependencies and keep `package-lock.json` or `yarn.lock` files under version control to ensure consistent dependency versions across environments.
    *   **Regular Dependency Updates:** Establish a process for regularly reviewing and updating dependencies, including Koa.js and middleware, to address security vulnerabilities and benefit from security patches.

**d) Deployment and Infrastructure Security (Kubernetes):**

*   **Recommendation:** Secure the Kubernetes deployment environment by implementing network policies, RBAC, pod security policies, and container security best practices.
*   **Specific Koa.js Action:**
    *   **Network Policies:** Implement Kubernetes Network Policies to restrict network traffic between pods and namespaces, limiting the attack surface in case of container compromise.
    *   **Kubernetes RBAC:** Enforce Role-Based Access Control (RBAC) in Kubernetes to limit access to Kubernetes API and resources, following the principle of least privilege.
    *   **Pod Security Policies/Pod Security Admission:** Implement Pod Security Policies (or the newer Pod Security Admission) to enforce security constraints on pods, such as preventing privileged containers, enforcing read-only root filesystems, and limiting capabilities.
    *   **Container Image Security Scanning:** Integrate container image scanning into the CI/CD pipeline to scan container images for vulnerabilities before deployment. Use tools like Clair, Trivy, or container registry built-in scanners.
    *   **Least Privilege Containers:** Run Koa.js application containers as non-root users to minimize the impact of potential container escapes.
    *   **Resource Limits and Quotas:** Set resource limits and quotas for containers and namespaces in Kubernetes to prevent resource exhaustion and DoS attacks.
    *   **Load Balancer Security:** Configure the Load Balancer with security in mind, including enabling DDoS protection, configuring SSL/TLS properly, and restricting access to management interfaces.

**e) Build Pipeline Security (CI/CD):**

*   **Recommendation:** Secure the CI/CD pipeline to prevent supply chain attacks and ensure the integrity of the build process.
*   **Specific Koa.js Action:**
    *   **Secure Pipeline Configuration:** Secure the CI/CD pipeline configuration and access controls. Limit access to pipeline configurations and secrets to authorized personnel.
    *   **Secret Management:** Use secure secret management solutions (e.g., HashiCorp Vault, Kubernetes Secrets, cloud provider secret management services) to store and manage sensitive credentials (API keys, database passwords) used in the build and deployment process. Avoid hardcoding secrets in code or pipeline configurations.
    *   **SAST Integration:** Integrate Static Application Security Testing (SAST) tools into the CI/CD pipeline to automatically scan application code for potential vulnerabilities during builds.
    *   **Dependency Scanning in Pipeline:** As mentioned before, integrate dependency vulnerability scanning (`npm audit`/`yarn audit`) into the pipeline.
    *   **Build Artifact Integrity:** Ensure the integrity of build artifacts (e.g., container images) by using image signing and verification mechanisms.

### 5. Actionable and Tailored Mitigation Strategies

| Threat Category             | Specific Threat                                  | Actionable Mitigation Strategy (Koa.js Specific)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              