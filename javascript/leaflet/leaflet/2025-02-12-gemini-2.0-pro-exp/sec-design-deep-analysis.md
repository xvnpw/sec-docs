## Deep Security Analysis of Leaflet

### 1. Objective, Scope, and Methodology

**Objective:**

The objective of this deep analysis is to conduct a thorough security assessment of the Leaflet JavaScript library (version 1.9.4, and considering the general architecture for future versions). This analysis will identify potential security vulnerabilities, weaknesses in the design, and areas for improvement. The focus is on the core Leaflet library itself, but we will also consider the implications of its interaction with external services (tile servers, data sources) and the broader ecosystem of plugins.  We aim to provide actionable recommendations to improve Leaflet's security posture and guide developers using Leaflet to build more secure applications.  The key components to be analyzed are:

*   **Core Map Rendering and Interaction:**  `L.Map`, `L.TileLayer`, event handling.
*   **Data Handling:** `L.GeoJSON`, `L.Marker`, `L.Popup`, custom layer handling.
*   **DOM Manipulation:**  How Leaflet interacts with the Document Object Model.
*   **Plugin Architecture:**  How plugins extend Leaflet's functionality and the security implications.
*   **External Resource Handling:**  Loading of tiles, scripts, and other resources.

**Scope:**

*   **In Scope:**
    *   The core Leaflet library code (as available on GitHub).
    *   The documented API and its usage.
    *   The interaction of Leaflet with standard web technologies (HTML, CSS, JavaScript, DOM).
    *   Commonly used Leaflet plugins (though not an exhaustive audit of each).
    *   Security implications of using Leaflet in web applications.
    *   Deployment methods (CDN, direct inclusion, package managers).

*   **Out of Scope:**
    *   Security audits of specific third-party tile servers or data providers.
    *   Security audits of individual web applications built using Leaflet (this is the responsibility of the application developers).
    *   Performance analysis, except where performance issues directly relate to security (e.g., DoS).
    *   Detailed analysis of every possible Leaflet plugin.

**Methodology:**

1.  **Code Review:** Manual inspection of the Leaflet source code, focusing on areas known to be common sources of vulnerabilities (input handling, DOM manipulation, etc.).
2.  **Documentation Review:** Analysis of the official Leaflet documentation, including API references, tutorials, and security recommendations.
3.  **Architecture Analysis:**  Inferring the architecture, components, and data flow from the codebase and documentation (using the provided C4 diagrams as a starting point).
4.  **Threat Modeling:**  Identifying potential threats based on the architecture, data flow, and known vulnerabilities in similar libraries.  We will use the STRIDE model (Spoofing, Tampering, Repudiation, Information Disclosure, Denial of Service, Elevation of Privilege) to categorize threats.
5.  **Dynamic Analysis (Conceptual):** While we won't be performing live dynamic analysis, we will conceptually consider how Leaflet behaves at runtime and how this might expose vulnerabilities.
6.  **Mitigation Strategy Development:**  Proposing specific, actionable mitigation strategies for each identified threat.

### 2. Security Implications of Key Components

Let's break down the security implications of the key components identified in the objective:

**2.1 Core Map Rendering and Interaction (`L.Map`, `L.TileLayer`, Event Handling)**

*   **`L.Map`:** This is the central class that initializes and manages the map.  It handles user interactions (zoom, pan), map options, and layers.
    *   **Threats:**
        *   **Denial of Service (DoS):**  Rapidly changing map options or triggering excessive events could potentially overload the browser or the tile server.  While Leaflet has some built-in throttling, an attacker might find ways to bypass these.
        *   **Tampering:**  Maliciously crafted map options (e.g., invalid zoom levels, coordinates) could lead to unexpected behavior or crashes.
        *   **Information Disclosure:** If map options inadvertently expose sensitive information (e.g., API keys in URLs), this could be leaked.
    *   **Mitigation:**
        *   **DoS:**  Strengthen input validation and rate limiting for map option changes and event handling.  Consider implementing server-side controls (if applicable) to limit excessive requests.
        *   **Tampering:**  Thoroughly validate all map options, ensuring they fall within expected ranges and formats.  Use a strict whitelist of allowed values where possible.
        *   **Information Disclosure:**  Never include sensitive information directly in map options.  Use secure methods for handling API keys and other credentials (e.g., environment variables, secure storage).

*   **`L.TileLayer`:** This class handles the loading and display of map tiles.  It typically interacts with a tile server via HTTP requests.
    *   **Threats:**
        *   **Man-in-the-Middle (MitM) Attack:** If tiles are loaded over HTTP (not HTTPS), an attacker could intercept and modify the tiles, displaying false information or injecting malicious code.
        *   **Cross-Origin Resource Sharing (CORS) Issues:**  If the tile server doesn't have proper CORS headers, the browser might block the requests, leading to a broken map.  Conversely, overly permissive CORS headers could allow unauthorized access to tile data.
        *   **Information Disclosure:**  Tile URLs might inadvertently leak information about the user's location or browsing history.
        *   **Denial of Service (DoS):** An attacker could flood the tile server with requests, making the map unusable.
    *   **Mitigation:**
        *   **MitM:**  **Always use HTTPS for tile servers.**  This is a critical security requirement.
        *   **CORS:**  Ensure that tile servers have appropriate CORS headers configured.  Follow the principle of least privilege, allowing access only from authorized origins.
        *   **Information Disclosure:**  Review tile URL structures to ensure they don't leak sensitive information.  Use URL templates that minimize the amount of data sent in the URL.
        *   **DoS:**  Use a tile server that has built-in DoS protection (e.g., rate limiting, CDN).  Implement client-side throttling to limit the number of tile requests.

*   **Event Handling:** Leaflet uses a custom event system to handle user interactions and other events.
    *   **Threats:**
        *   **Cross-Site Scripting (XSS):**  If event handlers are not properly sanitized, an attacker could inject malicious code that would be executed in the context of the user's browser.  This is particularly relevant if event handlers display user-provided data.
        *   **Denial of Service (DoS):**  Triggering a large number of events rapidly could potentially overload the browser.
    *   **Mitigation:**
        *   **XSS:**  **Always sanitize user-provided data before displaying it in event handlers.**  Use a robust HTML sanitization library.  Avoid using `innerHTML` directly; prefer safer alternatives like `textContent` or DOM manipulation methods.
        *   **DoS:**  Implement rate limiting and throttling for event handling.  Debounce or throttle events that can be triggered frequently (e.g., mousemove).

**2.2 Data Handling (`L.GeoJSON`, `L.Marker`, `L.Popup`, Custom Layer Handling)**

*   **`L.GeoJSON`:** This class handles the parsing and display of GeoJSON data.
    *   **Threats:**
        *   **XSS:**  GeoJSON features can contain properties with arbitrary string values.  If these properties are displayed in popups or other UI elements without proper sanitization, an attacker could inject malicious code.
        *   **Data Validation Issues:**  Maliciously crafted GeoJSON data (e.g., excessively large or complex geometries) could lead to performance issues or crashes.
        *   **Information Disclosure:** GeoJSON data might contain sensitive information that should not be exposed to all users.
    *   **Mitigation:**
        *   **XSS:**  **Always sanitize GeoJSON property values before displaying them.**  Use a robust HTML sanitization library.  Consider using a Content Security Policy (CSP) to further restrict the execution of scripts.
        *   **Data Validation:**  Validate GeoJSON data against the GeoJSON specification.  Limit the size and complexity of GeoJSON features.  Consider using a library specifically designed for GeoJSON validation.
        *   **Information Disclosure:**  Filter GeoJSON data on the server-side to remove sensitive information before sending it to the client.  Implement access controls to restrict access to sensitive data.

*   **`L.Marker`:** This class represents a marker on the map.  Markers can have popups associated with them.
    *   **Threats:**
        *   **XSS:**  Marker popups are a common target for XSS attacks.  If user-provided content is displayed in a popup without sanitization, an attacker could inject malicious code.
    *   **Mitigation:**
        *   **XSS:**  **Always sanitize the content of marker popups.**  Use `L.Util.template` with caution, and ensure that any user-provided data is properly escaped.  Consider using a dedicated HTML sanitization library.  A strong CSP is also highly recommended.

*   **`L.Popup`:** This class represents a popup window on the map.
    *   **Threats:**
        *   **XSS:**  Popups are a primary vector for XSS attacks in Leaflet.  The `setContent` method is particularly vulnerable if used with unsanitized user input.
    *   **Mitigation:**
        *   **XSS:**  **Thoroughly sanitize all content passed to `setContent` or any other method that sets the popup's HTML.**  Use a robust HTML sanitization library (like DOMPurify).  Avoid using `innerHTML` directly.  A strong CSP is essential.  Educate developers using Leaflet about the risks of XSS in popups.

*   **Custom Layer Handling:** Leaflet allows developers to create custom layers.
    *   **Threats:**
        *   **All threats applicable to other components:** Custom layers can introduce any of the vulnerabilities discussed above, depending on how they are implemented.
    *   **Mitigation:**
        *   **Follow best practices:**  When creating custom layers, follow all the security best practices outlined for other Leaflet components.  Thoroughly test custom layers for security vulnerabilities.

**2.3 DOM Manipulation**

*   Leaflet heavily relies on DOM manipulation to render the map and its elements.
    *   **Threats:**
        *   **XSS:**  Incorrect DOM manipulation can lead to XSS vulnerabilities.  For example, using `innerHTML` with unsanitized user input is a classic XSS vector.
        *   **DOM Clobbering:**  An attacker might be able to manipulate the DOM in a way that interferes with Leaflet's functionality or security controls.
    *   **Mitigation:**
        *   **XSS:**  Avoid using `innerHTML` with unsanitized user input.  Use safer alternatives like `textContent`, `createElement`, and `appendChild`.  Use a robust HTML sanitization library.
        *   **DOM Clobbering:**  Be careful when manipulating the DOM, especially when interacting with elements that Leaflet also uses.  Use well-defined IDs and classes to avoid conflicts.

**2.4 Plugin Architecture**

*   Leaflet has a robust plugin architecture that allows developers to extend its functionality.
    *   **Threats:**
        *   **Vulnerabilities in Plugins:**  Plugins are often developed by third-party developers and may not have the same level of security scrutiny as the core Leaflet library.  A vulnerable plugin can compromise the security of the entire application.
        *   **Plugin Conflicts:**  Multiple plugins might conflict with each other, leading to unexpected behavior or vulnerabilities.
    *   **Mitigation:**
        *   **Vulnerabilities in Plugins:**  **Carefully vet any plugins you use.**  Choose plugins from reputable sources.  Review the plugin's code for security vulnerabilities.  Keep plugins updated.  Consider contributing to the security of popular plugins.
        *   **Plugin Conflicts:**  Test your application thoroughly with all the plugins you use.  Report any conflicts to the plugin developers.

**2.5 External Resource Handling**

*   Leaflet loads external resources, such as tiles, scripts, and stylesheets.
    *   **Threats:**
        *   **Man-in-the-Middle (MitM) Attack:**  If resources are loaded over HTTP, an attacker could intercept and modify them.
        *   **Cross-Site Scripting (XSS):**  Loading a malicious script from an external source could lead to XSS.
        *   **Subresource Integrity (SRI) Issues:**  If SRI is not used, an attacker could modify a resource on a CDN without being detected.
    *   **Mitigation:**
        *   **MitM:**  **Always load external resources over HTTPS.**
        *   **XSS:**  Use a Content Security Policy (CSP) to restrict the sources from which scripts can be loaded.
        *   **SRI:**  **Use Subresource Integrity (SRI) when loading Leaflet and other libraries from a CDN.**  This ensures that the browser only executes the expected code, even if the CDN is compromised.

### 3. Architecture, Components, and Data Flow (Inferences)

The provided C4 diagrams give a good overview of Leaflet's architecture.  Based on the codebase and documentation, we can infer the following:

*   **Centralized Event System:** Leaflet uses a centralized event system to manage interactions and updates.  This is a key component for extensibility, but also a potential area for vulnerabilities if not handled carefully.
*   **Layer-Based Architecture:** Leaflet uses a layer-based architecture, where different types of data (tiles, markers, GeoJSON) are represented as separate layers.  This allows for flexibility and customization, but also requires careful management of data flow between layers.
*   **DOM-Centric Rendering:** Leaflet relies heavily on DOM manipulation for rendering the map.  This is a common approach for web mapping libraries, but it also introduces potential risks related to XSS and DOM clobbering.
*   **Asynchronous Operations:** Leaflet uses asynchronous operations for loading tiles and other data.  This is important for performance, but it also adds complexity to the code and can make it more difficult to reason about security.
*   **Plugin Ecosystem:** The plugin architecture is a core part of Leaflet's design.  Plugins can extend almost any aspect of Leaflet's functionality, which makes it very powerful but also introduces a significant security risk.

### 4. Specific Security Considerations (Tailored to Leaflet)

*   **GeoJSON Sanitization:**  Given Leaflet's frequent use with GeoJSON, a dedicated GeoJSON sanitization function or integration with a robust GeoJSON validation library should be considered. This is *more* than just HTML sanitization; it needs to understand the GeoJSON structure.
*   **Popup Content Security:**  Leaflet should provide clear guidance and helper functions for securely handling popup content.  This might include a built-in sanitization option or a recommended sanitization library.
*   **Tile Layer Security:**  Leaflet should strongly emphasize the use of HTTPS for tile layers and provide clear warnings when HTTP is used.  It could even consider a "strict mode" that disables HTTP tile layers entirely.
*   **Plugin Security Guidance:**  Leaflet should provide clear guidance for developers on how to assess the security of plugins.  This could include a checklist of security considerations or a list of recommended plugins.
*   **Event Handler Security:**  Leaflet should provide examples and best practices for securely handling events, particularly those that involve user-provided data.
*   **CSP Integration:**  Leaflet's documentation should provide detailed guidance on how to use CSP with Leaflet, including specific directives for different use cases.
*   **SRI Integration:** Leaflet should provide the SRI hashes for its CDN-hosted files and encourage their use.

### 5. Actionable Mitigation Strategies (Tailored to Leaflet)

| Threat Category (STRIDE) | Specific Threat                                                                                                                               | Mitigation Strategy                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              