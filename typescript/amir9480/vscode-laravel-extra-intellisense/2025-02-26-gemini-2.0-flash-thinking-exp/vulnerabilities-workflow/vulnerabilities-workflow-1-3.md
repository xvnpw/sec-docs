### Vulnerability List:

- Vulnerability Name: Remote Code Execution via `phpCommand` configuration
- Description:
    1. An attacker compromises a developer's local machine or VSCode settings through social engineering or other attack vectors.
    2. The attacker modifies the `LaravelExtraIntellisense.phpCommand` setting within the developer's VSCode configuration. This setting is intended to allow customization of the PHP command used by the extension.
    3. The attacker injects malicious PHP code into the `phpCommand` setting. For example, they might change it to execute arbitrary system commands or exfiltrate sensitive data. A sample malicious command could be: `echo ';<?php system($_GET["cmd"]); ?>' | php -r '{code}'`
    4. The developer opens a Laravel project in VSCode and activates the "Laravel Extra Intellisense" extension.
    5. The extension, upon activation or during its regular background operations for providing autocompletion features, executes PHP code using the configured `phpCommand`.
    6. Due to the attacker's modification, the malicious PHP code injected in step 3 is executed on the developer's machine with the privileges of the VSCode process.
    7. The attacker achieves Remote Code Execution, potentially gaining full control over the developer's machine, stealing source code, credentials, or other sensitive information.
- Impact:
    - Critical: Successful exploitation allows arbitrary code execution on the developer's machine. This can lead to:
        - Full compromise of the developer's workstation.
        - Theft of sensitive source code and intellectual property.
        - Exposure of credentials and API keys stored locally.
        - Installation of malware or backdoors on the developer's system.
        - Lateral movement within the developer's network if the machine is connected to a corporate network.
- Vulnerability Rank: critical
- Currently implemented mitigations:
    - Security Note in README.md: The README.md file includes a "Security Note" that warns users about the extension running their Laravel application automatically and periodically. It advises users to be cautious and temporarily disable the extension if they have sensitive code in service providers or notice unknown errors in logs.
    - Location: [/code/README.md](</code/README.md>)
    - Description: This note serves as a warning to users about the potential security implications of the extension's functionality. However, it relies on the user to understand the risk and take manual precautions, rather than implementing technical mitigations within the extension itself.
- Missing mitigations:
    - Input validation and sanitization: The extension should validate and sanitize the `phpCommand` setting to prevent injection of arbitrary code. It should restrict allowed characters and potentially block execution if suspicious patterns are detected.
    - Command parameterization: Instead of directly embedding the `{code}` into the shell command, the extension should use parameterized queries or নিরাপদ execution methods to separate code from commands.
    - Sandboxing or process isolation: Run the PHP code execution in a sandboxed environment or with restricted privileges to limit the impact of potential exploits.
    - User warnings: Display a prominent warning to the user if the `phpCommand` setting is modified from its default or contains potentially dangerous characters.
- Preconditions:
    - Attacker's ability to modify VSCode settings: The attacker must have a way to modify the VSCode settings of a developer using the extension. This could be through compromising the developer's machine, gaining access to their settings files (e.g., `settings.json`), or through social engineering tactics.
    - Laravel Extra Intellisense extension active: The developer must have the "Laravel Extra Intellisense" extension installed and activated in a VSCode workspace that is a Laravel project.
- Source code analysis:
    - File: [/code/src/helpers.ts](</code/src/helpers.ts>)
    - Function: `runPhp(code: string, description: string|null = null)`
    - Step-by-step analysis:
        1. The `runPhp` function is responsible for executing PHP code.
        2. It retrieves the `phpCommand` setting from VSCode configuration using `vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand')`.
        3. If the `phpCommand` is not configured by the user, it defaults to `"php -r \"{code}\""`.
        4. The function then uses `commandTemplate.replace("{code}", code)` to construct the final command string by directly embedding the `$code` (which is user-controlled PHP code generated by the extension) into the command template.
        5. `cp.exec(command, ...)` executes the constructed command using `child_process.exec`. This function directly executes a string as a shell command, making it vulnerable to command injection if the `command` string is not properly sanitized, which is the case here.
    - Visualization:
    ```
    [VSCode Configuration] --> phpCommand Setting --> runPhp() Function --> Command String Construction (Vulnerable) --> cp.exec() --> [System Command Execution]
    ```
- Security test case:
    1. **Precondition:** Ensure you have VSCode installed with the "Laravel Extra Intellisense" extension activated in a Laravel project.
    2. **Step 1: Modify `phpCommand` setting.**
        - Open VSCode settings (File -> Preferences -> Settings -> Settings or Code -> Settings -> Settings).
        - Go to Workspace Settings or User Settings.
        - Search for "Laravel Extra Intellisense phpCommand".
        - Modify the `LaravelExtraIntellisense.phpCommand` setting to the following malicious command:
          ```json
          "LaravelExtraIntellisense.phpCommand": "echo ';<?php system(\"calc.exe\"); ?>' | php -r '{code}'"
          ```
          (For Linux/macOS, replace `calc.exe` with `xcalc` or `gnome-calculator` or similar calculator application).
    3. **Step 2: Trigger autocompletion.**
        - Open any PHP or Blade file within your Laravel project.
        - In a PHP block or Blade template, start typing a Laravel function that triggers the extension to execute PHP code for autocompletion suggestions. For example, type `route('` or `config('` or `view('`.
    4. **Step 3: Observe RCE.**
        - As soon as you trigger the autocompletion (e.g., after typing `route('`), the malicious command injected in the `phpCommand` setting will be executed.
        - You should observe the calculator application (`calc.exe` or equivalent) launching on your system. This confirms successful Remote Code Execution.