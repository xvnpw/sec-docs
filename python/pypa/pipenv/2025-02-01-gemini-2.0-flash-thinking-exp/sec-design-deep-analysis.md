## Deep Security Analysis of Pipenv - Security Design Review

### 1. Objective, Scope, and Methodology

**Objective:**

The objective of this deep security analysis is to thoroughly evaluate the security posture of Pipenv, a Python dependency management tool, based on the provided Security Design Review. This analysis will focus on identifying potential security vulnerabilities and risks associated with Pipenv's architecture, components, and data flow. The goal is to provide actionable and tailored security recommendations to enhance Pipenv's security and mitigate identified threats, ultimately contributing to a more secure dependency management experience for Python developers.

**Scope:**

This analysis encompasses the following key areas of Pipenv, as outlined in the Security Design Review:

*   **Architecture and Components:**  Analysis of Pipenv's architecture based on the C4 Context and Container diagrams, focusing on components like Pipenv CLI, Virtual Environment Manager, Dependency Resolver, Pipfile Manager, Lockfile Manager, and pip Interface.
*   **Data Flow:** Examination of data flow between Pipenv components, package indices (PyPI, Private Registries), the operating system, and the developer environment.
*   **Security Controls:** Review of existing and recommended security controls, including inherited controls from `pip`, and identification of gaps.
*   **Risk Assessment:** Consideration of business and security risks associated with Pipenv usage, including supply chain attacks, vulnerabilities in Pipenv itself, and data integrity issues.
*   **Security Requirements:** Analysis of security requirements like input validation and cryptography in the context of Pipenv's functionality.
*   **Build and Deployment:**  Review of Pipenv's build and deployment processes to identify potential security considerations in the development lifecycle.

This analysis will primarily focus on Pipenv as a tool and its direct security implications. It will not extend to a comprehensive security audit of the entire Python ecosystem or the security of individual Python projects using Pipenv, unless directly relevant to Pipenv's security posture.

**Methodology:**

This deep analysis will employ the following methodology:

1.  **Document Review:**  In-depth review of the provided Security Design Review document, including business and security posture, C4 diagrams, risk assessment, questions, and assumptions.
2.  **Component-Based Analysis:**  Systematic analysis of each key component of Pipenv (as identified in the C4 Container diagram) to understand its functionality, potential security vulnerabilities, and existing security controls.
3.  **Threat Modeling:**  Identification of potential threats and attack vectors targeting Pipenv and its components, considering the OWASP Top 10 and supply chain security principles.
4.  **Control Gap Analysis:**  Comparison of existing security controls with identified threats and security requirements to identify gaps and areas for improvement.
5.  **Tailored Recommendation Development:**  Formulation of specific, actionable, and tailored mitigation strategies for identified threats and vulnerabilities, focusing on practical implementations within Pipenv's codebase, documentation, or user guidance.
6.  **Prioritization:**  Implicit prioritization of recommendations based on the severity of the identified risks and the feasibility of implementation.

### 2. Security Implications of Key Components

Based on the C4 Container diagram, we will analyze the security implications of each key component of Pipenv:

**a) Pipenv CLI:**

*   **Function:** The primary interface for users to interact with Pipenv. Parses user commands, orchestrates other components, and provides user feedback.
*   **Security Implications:**
    *   **Command Injection:**  If Pipenv CLI does not properly validate user inputs (package names, versions, options), it could be vulnerable to command injection attacks. Maliciously crafted inputs could be executed by the underlying shell, potentially compromising the developer's environment.
    *   **Path Traversal:**  Improper handling of file paths in CLI arguments could lead to path traversal vulnerabilities, allowing users to access or manipulate files outside of the intended project directory.
    *   **Denial of Service (DoS):**  Maliciously crafted commands or excessive requests could potentially lead to resource exhaustion and DoS, although less likely in a CLI tool context.
*   **Mitigation Strategies:**
    *   **Input Validation:** Implement robust input validation for all CLI arguments, including package names, versions, options, and file paths. Use allowlists and sanitization techniques to prevent injection attacks.
    *   **Principle of Least Privilege:** Ensure Pipenv CLI operates with the minimum necessary privileges. Avoid running Pipenv commands as root or with elevated privileges unless absolutely necessary.
    *   **Error Handling and Logging:** Implement secure error handling to avoid revealing sensitive information in error messages. Log relevant security events for auditing and incident response.

**b) Virtual Environment Manager:**

*   **Function:** Creates, activates, and deactivates Python virtual environments, isolating project dependencies.
*   **Security Implications:**
    *   **Symlink Vulnerabilities:** If virtual environment creation process is not carefully implemented, it could be susceptible to symlink vulnerabilities, potentially allowing attackers to escape the virtual environment or manipulate files outside of it.
    *   **Permissions Issues:** Incorrect file permissions on virtual environment directories could lead to unauthorized access or modification of project dependencies.
    *   **Environment Variable Manipulation:**  While virtual environments provide isolation, vulnerabilities in how environment variables are managed could potentially lead to information leakage or unintended behavior.
*   **Mitigation Strategies:**
    *   **Secure Virtual Environment Creation:**  Ensure the virtual environment creation process is robust and avoids symlink vulnerabilities. Use secure methods for creating isolated environments, leveraging `venv` or `virtualenv` securely.
    *   **Restrictive File Permissions:**  Set restrictive file permissions on virtual environment directories to prevent unauthorized access and modification.
    *   **Environment Variable Sanitization:**  Carefully manage and sanitize environment variables within virtual environments to prevent unintended side effects or information leakage.

**c) Dependency Resolver:**

*   **Function:** Resolves project dependencies based on Pipfile and available packages in package indices (PyPI, Private Registries).
*   **Security Implications:**
    *   **Dependency Confusion Attacks:**  Without proper safeguards, Pipenv could be vulnerable to dependency confusion attacks, where attackers introduce malicious packages with the same name as internal or private packages in public repositories.
    *   **Typosquatting:**  Users might accidentally install packages with names similar to legitimate packages (typosquatting), potentially leading to the installation of malicious dependencies.
    *   **Vulnerable Dependency Resolution:**  If the dependency resolver prioritizes outdated or vulnerable package versions, it could introduce known vulnerabilities into the project.
    *   **Man-in-the-Middle (MitM) Attacks:**  If communication with package indices is not strictly over HTTPS, it could be vulnerable to MitM attacks, allowing attackers to intercept and modify package downloads.
*   **Mitigation Strategies:**
    *   **Lockfile Integrity:**  Emphasize the importance of `Pipfile.lock` and ensure its integrity. Implement checks to detect tampering with `Pipfile.lock`.
    *   **Hash Verification:**  Strictly enforce hash verification for downloaded packages, as inherited from `pip`. Ensure Pipenv consistently utilizes and validates package hashes from `Pipfile.lock`.
    *   **Dependency Vulnerability Scanning:**  Integrate dependency vulnerability scanning into Pipenv's workflow or recommend and facilitate integration with external scanning tools.
    *   **Secure Communication:**  Ensure all communication with package indices is strictly over HTTPS.
    *   **Package Source Prioritization:**  Provide mechanisms for users to prioritize trusted package sources (e.g., private registries) and reduce reliance on public indices for sensitive dependencies.
    *   **Clear Error Messages for Resolution Failures:** Provide informative error messages when dependency resolution fails due to security issues (e.g., hash mismatch, vulnerability detection).

**d) Pipfile Manager:**

*   **Function:** Manages the `Pipfile`, which specifies project dependencies. Reads and writes `Pipfile`, adds and removes dependencies.
*   **Security Implications:**
    *   **Pipfile Manipulation:**  If `Pipfile` parsing is not robust, it could be vulnerable to manipulation attacks. Maliciously crafted `Pipfile` content could potentially lead to unexpected behavior or vulnerabilities.
    *   **File System Race Conditions:**  If `Pipfile` management involves complex file operations, it could be susceptible to race conditions, potentially leading to data corruption or security vulnerabilities.
    *   **Information Disclosure:**  Accidental inclusion of sensitive information (e.g., API keys, credentials) in `Pipfile` by users could lead to information disclosure.
*   **Mitigation Strategies:**
    *   **Robust Pipfile Parsing:**  Implement secure and robust parsing of `Pipfile` format, validating its structure and content to prevent manipulation attacks.
    *   **Secure File Operations:**  Use secure file operation practices to avoid race conditions and ensure data integrity when reading and writing `Pipfile`.
    *   **Documentation and User Guidance:**  Clearly document best practices for managing `Pipfile`, emphasizing the importance of avoiding inclusion of sensitive information and using environment variables for secrets.
    *   **Pipfile Schema Validation:**  Consider implementing schema validation for `Pipfile` to enforce a well-defined structure and prevent unexpected or malicious content.

**e) Lockfile Manager:**

*   **Function:** Manages the `Pipfile.lock`, ensuring deterministic builds. Generates, updates, and reads `Pipfile.lock` for dependency installation.
*   **Security Implications:**
    *   **Lockfile Tampering:**  If `Pipfile.lock` is compromised or tampered with, it could undermine the security benefits of deterministic builds and potentially introduce malicious dependencies.
    *   **Hash Collision Vulnerabilities:**  While unlikely with strong hashing algorithms, theoretical hash collision vulnerabilities in the hashing mechanism used for `Pipfile.lock` could potentially allow attackers to substitute malicious packages without detection.
    *   **Insecure Lockfile Generation:**  If the lockfile generation process itself is flawed or vulnerable, it could produce an insecure or incomplete `Pipfile.lock`.
*   **Mitigation Strategies:**
    *   **Integrity Checks for Pipfile.lock:**  Implement integrity checks for `Pipfile.lock` to detect tampering. Consider using cryptographic signatures or checksums to verify the lockfile's integrity.
    *   **Strong Hashing Algorithms:**  Ensure the use of strong and cryptographically secure hashing algorithms for generating package hashes in `Pipfile.lock`.
    *   **Secure Lockfile Generation Process:**  Thoroughly review and secure the lockfile generation process to prevent vulnerabilities that could lead to insecure or incomplete lockfiles.
    *   **User Warnings for Lockfile Discrepancies:**  Provide clear warnings to users if Pipenv detects discrepancies between `Pipfile` and `Pipfile.lock` or if the lockfile appears to be invalid or tampered with.

**f) pip Interface:**

*   **Function:** Interface to the `pip` package installer, used by Pipenv to install and uninstall packages within virtual environments.
*   **Security Implications:**
    *   **Inherited `pip` Vulnerabilities:**  Pipenv directly relies on `pip` and inherits any security vulnerabilities present in `pip` itself.
    *   **Insecure `pip` Configuration:**  If `pip` is misconfigured (e.g., disabling hash checking, allowing insecure package sources), Pipenv's security posture will be weakened.
    *   **`pip` Command Injection (Indirect):**  While less direct, vulnerabilities in how Pipenv constructs and executes `pip` commands could potentially lead to indirect command injection if not carefully handled.
*   **Mitigation Strategies:**
    *   **Stay Updated with `pip` Security Patches:**  Continuously monitor and update the bundled or recommended `pip` version to incorporate security patches and fixes.
    *   **Enforce Secure `pip` Configuration:**  Document and recommend secure `pip` configurations for Pipenv users, emphasizing the importance of hash checking, HTTPS, and trusted package sources.
    *   **Secure `pip` Command Construction:**  Carefully construct and sanitize arguments passed to `pip` commands to prevent indirect command injection vulnerabilities.
    *   **Abstraction and Isolation:**  Consider abstracting the interaction with `pip` to minimize direct reliance and potentially isolate Pipenv from future `pip` vulnerabilities.

### 3. Architecture, Components, and Data Flow (Based on Security Design Review)

The Security Design Review provides clear C4 Context and Container diagrams outlining the architecture, components, and data flow. Key takeaways for security analysis are:

*   **Central Role of Pipenv CLI:** The CLI is the entry point and orchestrator, making its security crucial. Input validation and secure command handling are paramount.
*   **Dependency on External Systems:** Pipenv relies heavily on external systems like PyPI, Private Registries, and the Operating System. Security of these external systems and Pipenv's interaction with them is critical.
*   **Data Flow for Dependency Resolution:** The Dependency Resolver interacts with package indices to retrieve package information. Secure communication (HTTPS) and integrity checks (hashes) are essential in this data flow.
*   **Importance of `Pipfile` and `Pipfile.lock`:** These files are central to Pipenv's functionality and security. Their integrity and secure management are vital for reproducible and secure builds.
*   **Virtual Environment Isolation:** Virtual environments are a key security control for isolating project dependencies. Secure creation and management of these environments are important.
*   **`pip` as a Core Dependency:** Pipenv's reliance on `pip` means it inherits `pip`'s security features and vulnerabilities. Keeping `pip` secure is crucial for Pipenv's overall security.

### 4. Tailored Security Considerations and Specific Recommendations

Given that Pipenv is a dependency management tool for Python projects, the security considerations should be tailored to this context. General security recommendations are less effective than specific advice for Pipenv users and developers.

**Specific Security Considerations for Pipenv Projects:**

*   **Supply Chain Security:** Python projects using Pipenv are inherently vulnerable to supply chain attacks through compromised dependencies. This is a primary concern.
*   **Deterministic Builds:** While `Pipfile.lock` aims to ensure deterministic builds, its integrity is crucial. Tampering with `Pipfile.lock` can negate its security benefits.
*   **Developer Environment Security:** The security of the developer's workstation where Pipenv is used is a significant factor. Compromised developer environments can lead to project compromise.
*   **Misconfiguration:** User misconfiguration of Pipenv or `pip` can weaken security. Clear documentation and secure defaults are important.
*   **Vulnerability Management:**  Proactive vulnerability management for project dependencies is essential. Pipenv should facilitate this process.

**Tailored Recommendations for Pipenv:**

1.  **Enhance Lockfile Integrity Verification:**
    *   **Recommendation:** Implement cryptographic signing or checksumming of `Pipfile.lock` to detect tampering. This could be an optional feature enabled by users for enhanced security.
    *   **Actionable:** Explore integrating a signing mechanism (e.g., using GPG or similar) into Pipenv to sign `Pipfile.lock` upon generation and verify the signature during installation. Alternatively, implement robust checksum verification.

2.  **Integrate Dependency Vulnerability Scanning:**
    *   **Recommendation:**  Develop a built-in command or plugin for Pipenv to perform dependency vulnerability scanning using publicly available vulnerability databases (e.g., CVE databases, OSV).
    *   **Actionable:** Investigate integrating existing Python vulnerability scanning libraries (e.g., `safety`, `insecure-package-scanner`) directly into Pipenv as a subcommand (e.g., `pipenv security-check`).

3.  **Improve User Guidance on Secure Configuration:**
    *   **Recommendation:**  Significantly enhance documentation with detailed security best practices for Pipenv usage. Include sections on:
        *   Verifying package hashes and lockfile integrity.
        *   Using private package registries securely.
        *   Configuring `pip` securely within Pipenv environments.
        *   Best practices for managing secrets and avoiding their inclusion in `Pipfile`.
        *   Regular dependency vulnerability scanning.
    *   **Actionable:** Create a dedicated "Security Best Practices" section in the Pipenv documentation, providing step-by-step guides and examples for secure Pipenv usage.

4.  **Strengthen Input Validation in Pipenv CLI:**
    *   **Recommendation:**  Conduct a thorough review of Pipenv CLI argument parsing and input handling. Implement robust input validation for all user-provided inputs to prevent command injection and path traversal vulnerabilities.
    *   **Actionable:**  Utilize input validation libraries and techniques to sanitize and validate all CLI arguments. Implement unit tests specifically targeting input validation to ensure robustness.

5.  **Automate Dependency Vulnerability Scanning in Pipenv Development CI/CD:**
    *   **Recommendation:**  As recommended in the Security Design Review, implement automated dependency vulnerability scanning as part of Pipenv's own development and release process.
    *   **Actionable:** Integrate a dependency vulnerability scanning tool (e.g., `safety`, `snyk`) into the Pipenv GitHub Actions CI/CD pipeline to scan Pipenv's dependencies for vulnerabilities during each build and release.

6.  **Consider Signature Verification for Pipenv Releases:**
    *   **Recommendation:**  As recommended in the Security Design Review, consider implementing signature verification for Pipenv releases distributed via PyPI. This would help users verify the authenticity and integrity of Pipenv packages.
    *   **Actionable:**  Explore signing Pipenv releases using tools like `gpg` and providing instructions for users to verify signatures before installation.

7.  **Regular Security Audits of Pipenv Codebase:**
    *   **Recommendation:**  As recommended in the Security Design Review, conduct regular security audits of Pipenv's codebase, ideally by external security experts, to identify and address potential vulnerabilities.
    *   **Actionable:**  Schedule periodic security audits (e.g., annually or bi-annually) and allocate resources for remediation of identified vulnerabilities.

### 5. Actionable and Tailored Mitigation Strategies

The mitigation strategies outlined above are already actionable and tailored to Pipenv. To further emphasize their actionability, here's a summary with a focus on concrete steps:

| Threat                                  | Mitigation Strategy                                          | Actionable Steps                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             