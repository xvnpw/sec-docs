## Deep Dive Analysis: Information Disclosure through Default Error Pages in Bottle Applications

This document provides a detailed analysis of the "Information Disclosure through Default Error Pages" threat within Bottle web applications. We will explore the technical aspects of the vulnerability, potential attack vectors, the impact of successful exploitation, and provide actionable mitigation strategies for the development team.

**1. Understanding the Threat:**

The core issue lies in Bottle's default behavior when an unhandled exception or an `HTTPError` is raised during request processing. By default, Bottle generates an HTML page containing detailed information about the error, including:

* **Stack Trace:**  A detailed record of the function calls leading to the error, including file paths, line numbers, and function names. This reveals the application's internal structure and code execution flow.
* **Error Message:** The specific error message generated by Python or the application code, which can provide clues about underlying logic or data.
* **Local Variables:** In some cases, the error page might display the values of local variables at the point of the exception. This can inadvertently expose sensitive data.
* **Bottle Version:** While seemingly minor, knowing the Bottle version can help attackers identify known vulnerabilities associated with that specific version.

**2. Technical Deep Dive:**

* **`bottle.handle_error`:** This is the central function responsible for handling errors in Bottle. When an exception propagates up the call stack without being caught by application code, `bottle.handle_error` takes over. In debug mode, its default implementation generates the detailed error page.
* **`bottle.HTTPError`:** This class is used to raise specific HTTP error responses (e.g., 404 Not Found, 500 Internal Server Error). Even when using `HTTPError`, if not handled explicitly, the default error handler will be invoked, potentially revealing information.
* **Debug Mode (`debug=True`):**  While intended for development, leaving debug mode enabled in production is the primary reason this vulnerability is exploitable. In debug mode, Bottle provides highly detailed error information to aid developers.
* **Production Mode (`debug=False`):**  In production mode, the default error handler is less verbose, typically displaying a generic "Internal Server Error" message. However, even this can be improved upon.

**3. Attack Vectors:**

An attacker can trigger these default error pages through various means:

* **Invalid Input:** Providing malformed or unexpected data in request parameters, headers, or body can lead to exceptions during data processing or validation. Examples include:
    * Sending non-integer values to endpoints expecting integers.
    * Providing excessively long strings that cause buffer overflows (though less common in Python).
    * Injecting special characters that break parsing logic.
* **Accessing Non-Existent Resources:**  Requesting URLs that do not correspond to any defined routes will trigger a 404 Not Found error. While the default 404 page might be less revealing than a 500 error, it still confirms the application is running and potentially reveals the underlying web server.
* **Triggering Server-Side Exceptions:**  Exploiting vulnerabilities in the application logic can lead to unhandled exceptions. Examples include:
    * Division by zero errors.
    * Attempting to access non-existent database records without proper error handling.
    * Issues with external API calls that are not handled gracefully.
* **Exploiting Known Vulnerabilities:**  If the Bottle application uses vulnerable libraries or has code-level vulnerabilities, exploiting them can lead to exceptions and expose the default error pages.
* **Resource Exhaustion:**  Flooding the application with requests or providing extremely large inputs can potentially exhaust resources and trigger errors.
* **Deliberately Crafted Requests:** Attackers can craft specific requests designed to trigger known error conditions within Bottle or its dependencies.

**4. Impact Assessment:**

Successful exploitation of this vulnerability can have significant consequences:

* **Reconnaissance:** The exposed stack traces and file paths provide valuable information about the application's architecture, file structure, and the technologies used. This significantly aids attackers in understanding the application's inner workings and identifying potential weaknesses.
* **Vulnerability Discovery:**  Error messages and stack traces can reveal specific lines of code where errors occur. This can pinpoint potential vulnerabilities like injection flaws, authentication bypasses, or insecure data handling.
* **Exposure of Sensitive Information:**  In some cases, local variables displayed in the error page might contain sensitive data such as:
    * Database credentials.
    * API keys or tokens.
    * Internal configuration parameters.
    * User-specific data.
* **Understanding Application Logic:**  By observing the sequence of function calls in the stack trace, attackers can gain insights into the application's business logic and identify potential attack vectors.
* **Increased Risk of Further Exploitation:**  The information gathered from error pages can be used to craft more targeted and effective attacks.
* **Reputational Damage:**  If sensitive information is exposed due to this vulnerability, it can lead to significant reputational damage and loss of customer trust.

**5. Affected Bottle Components:**

* **`bottle.handle_error`:** The primary culprit in displaying detailed error information by default.
* **`bottle.HTTPError`:** While not directly responsible for displaying the detailed page, the lack of custom handling for `HTTPError` instances leads to the invocation of `bottle.handle_error`.

**6. Detailed Mitigation Strategies:**

The following strategies should be implemented to mitigate the risk of information disclosure through default error pages:

* **Implement Custom Error Handlers using `app.error()`:**
    * **Goal:** Replace the default error handling with custom logic that provides generic error messages to users and logs detailed errors securely.
    * **Implementation:** Use the `@app.error(ErrorCode)` decorator to define specific handlers for different HTTP error codes (e.g., 404, 500).
    * **Example:**

    ```python
    from bottle import Bottle, HTTPError

    app = Bottle()

    @app.route('/secret')
    def secret_page():
        raise Exception("Something went wrong!")

    @app.error(404)
    def error404(error):
        return '<h1>Sorry, the page was not found</h1>'

    @app.error(500)
    def error500(error):
        # Log the detailed error securely (see below)
        app.logger.error(f"Internal Server Error: {error.exception}")
        return '<h1>Oops! Something went wrong on our end.</h1>'

    if __name__ == '__main__':
        app.run(debug=False) # Ensure debug is False in production
    ```
    * **Best Practices:**
        * Provide user-friendly, generic error messages that do not reveal internal details.
        * Ensure custom error handlers are defined for common error codes (400, 401, 403, 404, 500).
        * Log detailed error information for debugging purposes (see "Secure Error Logging").

* **Disable Debug Mode (`debug=False`) in Production Environments:**
    * **Goal:** Prevent Bottle from generating detailed error pages in production.
    * **Implementation:** Ensure the `debug` parameter is set to `False` when running the application in a production environment. This is crucial and the most fundamental step.
    * **Configuration:** This is typically done when calling `app.run()` or through environment variables.
    * **Caution:** Never leave debug mode enabled in production.

* **Ensure Error Logging is Configured to Write to Secure Locations and Not Exposed Publicly:**
    * **Goal:**  Capture detailed error information for debugging and monitoring without exposing it to attackers.
    * **Implementation:**
        * Configure Bottle's built-in logging or use a dedicated logging library (e.g., `logging` module in Python).
        * Write logs to a secure location that is not accessible through the web server (e.g., a directory outside the web root).
        * Implement appropriate access controls on log files to restrict access to authorized personnel only.
        * Consider using log rotation and archiving to manage log file sizes.
        * Avoid logging sensitive information directly in plain text. Consider redacting or masking sensitive data before logging.

* **Implement Robust Input Validation and Sanitization:**
    * **Goal:** Prevent invalid input from reaching the application logic and triggering errors.
    * **Implementation:**
        * Validate all user inputs (request parameters, headers, body) against expected formats and types.
        * Sanitize inputs to remove or escape potentially harmful characters.
        * Use libraries like `cerberus` or `marshmallow` for schema-based validation.

* **Implement Proper Exception Handling within Application Code:**
    * **Goal:**  Catch expected exceptions gracefully and provide meaningful error responses without relying on the default error handler.
    * **Implementation:** Use `try...except` blocks to handle potential exceptions within your application logic.
    * **Example:**

    ```python
    from bottle import Bottle, HTTPError

    app = Bottle()

    @app.route('/users/<user_id:int>')
    def get_user(user_id):
        try:
            user = get_user_from_database(user_id)
            if not user:
                raise HTTPError(404, "User not found")
            return user
        except DatabaseError as e:
            app.logger.error(f"Database error while fetching user: {e}")
            raise HTTPError(500, "Error fetching user data")
    ```

* **Consider Using a Production-Ready WSGI Server:**
    * **Goal:**  Leverage the error handling capabilities of production-grade WSGI servers like Gunicorn or uWSGI.
    * **Benefits:** These servers often provide more robust error handling and logging mechanisms compared to Bottle's built-in development server.

* **Implement Security Headers:**
    * **Goal:**  Reduce information leakage through HTTP headers.
    * **Implementation:**  Configure your web server or Bottle middleware to remove or modify sensitive headers like `Server` (which reveals the underlying server software).

* **Regular Security Audits and Penetration Testing:**
    * **Goal:** Proactively identify and address potential vulnerabilities, including information disclosure through error pages.
    * **Implementation:** Conduct regular security audits and penetration testing to simulate real-world attacks and identify weaknesses in the application's security posture.

**7. Testing and Verification:**

After implementing the mitigation strategies, it's crucial to test and verify their effectiveness:

* **Simulate Error Conditions:** Intentionally trigger various error scenarios (e.g., providing invalid input, accessing non-existent URLs) to ensure that custom error handlers are invoked and generic error messages are displayed.
* **Inspect Error Logs:** Verify that detailed error information is being logged securely in the designated location.
* **Disable Debug Mode and Test:** Ensure that when debug mode is disabled, detailed error pages are not displayed, even when exceptions occur.
* **Use Browser Developer Tools:** Inspect the HTTP response headers to ensure that sensitive information is not being leaked through headers.
* **Perform Penetration Testing:** Engage security professionals to conduct penetration testing to identify any remaining vulnerabilities.

**8. Conclusion:**

Information disclosure through default error pages is a significant security risk in Bottle applications. By understanding the technical details of this vulnerability and implementing the recommended mitigation strategies, development teams can significantly reduce the attack surface and protect sensitive application information. Prioritizing secure error handling and disabling debug mode in production are fundamental steps towards building secure Bottle applications. Continuous monitoring, regular security audits, and a security-conscious development approach are essential for maintaining a strong security posture.
