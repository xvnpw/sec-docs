### 1. Host Header Injection in Email Notifications

- **Vulnerability Name:**  
  Host Header Injection in Email Notifications

- **Description:**  
  An attacker can control the content of the notification email sent to administrators by supplying a malicious Host header when triggering a login attempt on the honeypot. Here is how the vulnerability can be triggered step by step:
  - The honeypot view (at `/admin/login/`) processes any login attempt—even though it is designed to always fail—and then calls a signal handler.
  - In the signal handler (in `/code/admin_honeypot/listeners.py`), the function `notify_admins` constructs an admin detail URL by concatenating the value returned by `request.get_host()` with a URL generated by Django’s `reverse()` function.
  - An external attacker can send a POST request to `/admin/login/` with arbitrary credentials while setting the HTTP Host header to a malicious value (for example, `evil.com`).
  - Because the code does not sanitize the Host header before using it, the generated `admin_detail_url` in the email will include the attacker-controlled host.
  
- **Impact:**  
  - An administrator receiving the email notification could be misled by a phishing-like URL (e.g., `http://evil.com/admin/...`) appearing to reference the internal admin detail page.
  - This may pave the way for social engineering attacks or other malicious activities based on administrator misdirection.

- **Vulnerability Rank:**  
  High

- **Currently Implemented Mitigations:**  
  - The system uses Django’s built-in `request.get_host()`, which under proper production settings (with correctly configured `ALLOWED_HOSTS`) will validate the Host header. However, there is no explicit sanitization in the project’s code.

- **Missing Mitigations:**  
  - There is no dedicated check or sanitization of the HTTP Host header before its use in constructing URLs.
  - The code lacks a fallback mechanism to use a trusted, static hostname for building URLs in notification emails.

- **Preconditions:**  
  - The application is deployed in an environment where the `ALLOWED_HOSTS` setting is misconfigured or where `DEBUG` mode is enabled, allowing arbitrary Host header values.
  - The email notification feature is active, so that a login attempt results in an immediate email sent to administrators.

- **Source Code Analysis:**  
  1. In `/code/admin_honeypot/listeners.py`, the `notify_admins` function is defined.  
  2. The code reverses a URL for the admin change page:
     - ```python
       path = reverse('admin:admin_honeypot_loginattempt_change', args=(instance.pk,))
       ```
  3. It then constructs the URL by directly concatenating the output of `request.get_host()` without any additional validation:
     - ```python
       admin_detail_url = 'http://{0}{1}'.format(request.get_host(), path)
       ```
  4. Because `request.get_host()` reflects the Host header supplied in the HTTP request, an attacker can manipulate this value.

- **Security Test Case:**  
  1. **Environment Setup:**  
     - Deploy the application in an environment where `ALLOWED_HOSTS` is not strictly enforced (e.g., during development with `DEBUG=True`) or deliberately misconfigure `ALLOWED_HOSTS`.
  2. **Attack Step:**  
     - Craft a POST request to `http://<target>/admin/login/` with form data (for instance, `username=admin` and `password=letmein`).
     - Include a custom HTTP Host header with a malicious value (e.g., `Host: evil.com`).
  3. **Observation:**  
     - Trigger the login attempt.
     - Intercept or check the email that is sent to the administrator.  
     - Verify that the `admin_detail_url` contained in the email begins with `http://evil.com/` instead of the expected domain.
  4. **Conclusion:**  
     - If the email reflects the malicious host, the vulnerability is valid.