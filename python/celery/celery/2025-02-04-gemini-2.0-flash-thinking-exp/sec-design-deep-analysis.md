## Deep Security Analysis of Celery Application

### 1. Objective, Scope, and Methodology

**Objective:**

The objective of this deep security analysis is to thoroughly evaluate the security posture of a Celery-based application, as described in the provided security design review. This analysis aims to identify potential security vulnerabilities within the Celery ecosystem and its integration points, and to provide specific, actionable, and tailored mitigation strategies to enhance the overall security of the application. The focus is on ensuring the confidentiality, integrity, and availability of the application and its data, particularly in the context of asynchronous task processing.

**Scope:**

This security analysis encompasses the following components and aspects of the Celery application, as defined in the security design review:

*   **Celery Components:** Celery Client, Celery Worker.
*   **Infrastructure Components:** Message Broker (e.g., RabbitMQ, Redis), Result Backend (e.g., Redis, Database).
*   **Deployment Environment:** Containerized deployment using Docker and Kubernetes.
*   **Build Process:** CI/CD pipeline including build, test, and security scan stages.
*   **Security Controls:** Existing, accepted, and recommended security controls outlined in the review.
*   **Security Requirements:** Authentication, Authorization, Input Validation, and Cryptography requirements.
*   **Data Flow:** Task submission from applications to Celery, task distribution to workers, task execution, and result storage.
*   **Data Sensitivity:** Task payloads, task results, Celery configuration, and monitoring data.

The analysis will specifically focus on security considerations related to the Celery framework and its interactions with other components. It will not extend to a general security audit of the entire application or infrastructure, but rather concentrate on the security implications arising from the use of Celery.

**Methodology:**

This deep security analysis will be conducted using the following methodology:

1.  **Document Review:** In-depth review of the provided security design review document to understand the business context, security posture, architecture, deployment, build process, risk assessment, and identified security controls and requirements.
2.  **Architecture and Data Flow Analysis:** Analyze the C4 diagrams and component descriptions to understand the Celery application architecture, data flow, and interactions between different components. This will help identify potential attack surfaces and data exposure points.
3.  **Threat Modeling:** Based on the architecture and data flow, identify potential security threats relevant to each component of the Celery ecosystem. This will involve considering common attack vectors for distributed systems, message queues, containerized environments, and CI/CD pipelines.
4.  **Security Implication Analysis:** For each identified threat, analyze its potential impact on the business priorities (Reliability, Scalability, Performance, Maintainability) and business risks (Task failures, Performance bottlenecks, Security vulnerabilities, Operational complexity) outlined in the security design review.
5.  **Mitigation Strategy Development:** Develop specific, actionable, and tailored mitigation strategies for each identified threat. These strategies will be aligned with the recommended security controls and security requirements from the design review and will be practical for a Celery-based application.
6.  **Recommendation Prioritization:** Prioritize the mitigation strategies based on the severity of the identified threats, the feasibility of implementation, and alignment with the organization's risk appetite. The prioritization will consider the business risks and security posture defined in the review.
7.  **Documentation and Reporting:** Document the findings of the analysis, including identified threats, security implications, and recommended mitigation strategies in a clear and structured report. This report will serve as a guide for the development and operations teams to enhance the security of the Celery application.

### 2. Security Implications of Key Components

#### 2.1 Celery Client

**Component Description:** The Celery Client is a library integrated into applications to define and submit tasks to Celery. It interacts with the Message Broker and Result Backend.

**Security Implications:**

*   **Task Payload Injection:** If task parameters are not properly validated and sanitized by the application before being passed to the Celery Client, attackers could potentially inject malicious payloads. This could lead to various attacks depending on how the worker processes the payload, including command injection, code injection, or data manipulation.
    *   **Specific Threat:** An application might accept user input and directly pass it as a task parameter without validation. A malicious user could craft a payload that, when processed by the worker, executes unintended commands or accesses sensitive data.
*   **Exposure of Broker/Backend Credentials:** If the Celery Client is misconfigured and credentials for the Message Broker or Result Backend are hardcoded or stored insecurely within the application code or configuration, these credentials could be compromised.
    *   **Specific Threat:** Credentials stored in environment variables that are not properly secured or logged in application logs could be exposed to unauthorized parties.
*   **Unauthorized Task Submission:** If the application does not implement proper authorization checks before submitting tasks via the Celery Client, unauthorized users or systems might be able to submit tasks, potentially overloading the system or executing malicious tasks.
    *   **Specific Threat:** An API endpoint that triggers task submission might not have sufficient authentication and authorization, allowing anyone with access to the API to submit tasks.

**Tailored Mitigation Strategies for Celery Client:**

*   **Input Validation at Application Level:** Implement robust input validation and sanitization for all task parameters within the application *before* submitting tasks to the Celery Client. Use allow-lists and appropriate data type checks.
    *   **Actionable Recommendation:** Develop input validation functions for each task type, ensuring that all parameters conform to expected formats and values before being passed to `celery.send_task()`.
*   **Secure Credential Management:** Utilize secure secret management solutions (like Kubernetes Secrets, HashiCorp Vault, or cloud provider secret managers) to store and retrieve credentials for the Message Broker and Result Backend. Avoid hardcoding credentials in the application code or configuration files.
    *   **Actionable Recommendation:** Configure Celery Client to retrieve broker and backend credentials from environment variables injected by Kubernetes Secrets. Ensure these secrets are managed with appropriate access controls within Kubernetes.
*   **Application-Level Authorization for Task Submission:** Implement authorization checks within the application logic to ensure that only authorized users or systems can submit specific types of tasks.
    *   **Actionable Recommendation:** Integrate an authorization layer into the application that checks user roles or permissions before allowing task submission through the Celery Client. This could involve checking JWT tokens or session-based authentication.

#### 2.2 Celery Worker

**Component Description:** Celery Workers are processes that execute Celery tasks. They consume tasks from the Message Broker and store results in the Result Backend.

**Security Implications:**

*   **Task Deserialization Vulnerabilities:** Celery workers deserialize task payloads received from the message broker. Vulnerabilities in the deserialization process or libraries used could be exploited to execute arbitrary code on the worker.
    *   **Specific Threat:** If Celery is configured to use insecure serializers (like `pickle` in Python, which is known to be vulnerable to deserialization attacks), a malicious task payload could be crafted to execute arbitrary code when deserialized by the worker.
*   **Insecure Task Execution Environment:** If workers run with excessive privileges or lack proper isolation, vulnerabilities in task code or dependencies could compromise the worker host system or other tasks running on the same worker.
    *   **Specific Threat:** A task with a vulnerable dependency could be exploited to gain root access on the worker container if the container is not properly configured with least privilege.
*   **Data Exfiltration via Task Payloads/Results:** If task payloads or results contain sensitive data and are not properly encrypted or handled, attackers who compromise the Message Broker or Result Backend could gain access to this sensitive information.
    *   **Specific Threat:** Task payloads containing PII are stored in the Message Broker queues and Result Backend without encryption, making them vulnerable to exposure if these systems are compromised.
*   **Dependency Vulnerabilities in Worker Environment:** Celery workers rely on various dependencies. Vulnerabilities in these dependencies could be exploited to compromise the worker processes.
    *   **Specific Threat:** An outdated version of a Python library used by Celery or task code might contain a known vulnerability that attackers can exploit.

**Tailored Mitigation Strategies for Celery Worker:**

*   **Use Secure Serializers:** Configure Celery to use secure serializers for task payloads, such as `json` or `msgpack`. Avoid using `pickle` or other insecure serializers, especially when handling data from untrusted sources.
    *   **Actionable Recommendation:** Explicitly set `CELERY_TASK_SERIALIZER` and `CELERY_ACCEPT_CONTENT` in Celery configuration to use `json` or `msgpack`.
*   **Least Privilege Worker Containers:** Run Celery workers in containers with the principle of least privilege. Use non-root users inside containers, drop unnecessary capabilities, and implement resource limits.
    *   **Actionable Recommendation:** Configure the Celery Worker Dockerfile to use a non-root user (e.g., create a dedicated `celery` user and group). Define Kubernetes SecurityContext to drop capabilities and enforce resource quotas for worker containers.
*   **Encryption for Sensitive Data:** Encrypt sensitive data in task payloads and results, both in transit and at rest. Use appropriate encryption libraries within task code to encrypt/decrypt sensitive data.
    *   **Actionable Recommendation:** Implement encryption/decryption logic within tasks that handle sensitive data. For data at rest in the Result Backend, consider using database-level encryption if supported or encrypting data before storing it. For data in transit, ensure TLS/SSL is enabled for communication with the Message Broker and Result Backend.
*   **Regular Dependency Scanning and Updates:** Implement automated dependency scanning for worker container images and task code dependencies. Regularly update dependencies to patch known vulnerabilities.
    *   **Actionable Recommendation:** Integrate dependency scanning tools (like Trivy, Snyk, or OWASP Dependency-Check) into the CI/CD pipeline to scan worker container images and application dependencies. Automate dependency updates and patching processes.
*   **Worker Process Isolation:** Consider using process isolation techniques (like using separate user accounts or namespaces) to further isolate worker processes and limit the impact of a compromised worker.
    *   **Actionable Recommendation:** Explore containerization best practices for process isolation within Kubernetes. Investigate using Kubernetes namespaces or dedicated worker nodes for different types of tasks to limit the blast radius of potential compromises.

#### 2.3 Message Broker (e.g., RabbitMQ, Redis)

**Component Description:** The Message Broker is responsible for queuing and delivering task messages between Celery Clients and Workers.

**Security Implications:**

*   **Unauthorized Access to Broker:** If the Message Broker is not properly secured with authentication and authorization, unauthorized clients or workers could connect and potentially consume or inject messages, leading to data breaches, service disruption, or task manipulation.
    *   **Specific Threat:** Default credentials for the Message Broker are not changed, allowing anyone with network access to connect and manage queues.
*   **Message Interception and Tampering:** If communication between Celery components and the Message Broker is not encrypted, attackers could intercept task messages in transit and potentially tamper with them or eavesdrop on sensitive data within the messages.
    *   **Specific Threat:** Task messages containing sensitive information are transmitted over the network in plaintext between the Celery Client, Broker, and Worker.
*   **Denial of Service (DoS) Attacks:** An attacker could flood the Message Broker with a large number of messages, leading to queue exhaustion and preventing legitimate tasks from being processed.
    *   **Specific Threat:** An unauthenticated user can publish a large volume of messages to the broker, overwhelming its resources and preventing normal task processing.
*   **Queue Manipulation:** If access control is not properly configured on the Message Broker, unauthorized users could manipulate queues, such as deleting queues, changing queue settings, or re-routing messages, disrupting task processing.
    *   **Specific Threat:** An attacker gains access to the Message Broker management interface and deletes critical task queues, causing task processing to fail.

**Tailored Mitigation Strategies for Message Broker:**

*   **Strong Authentication and Authorization:** Enforce strong authentication for all connections to the Message Broker. Use username/password authentication, TLS client certificates, or other robust authentication mechanisms. Implement fine-grained authorization to control access to queues and broker management functions.
    *   **Actionable Recommendation:** Configure RabbitMQ or Redis to require strong passwords and enable user-based access control. For RabbitMQ, use virtual hosts and user permissions to restrict access to specific queues. For Redis, use ACLs to control command access and key access.
*   **Encryption in Transit (TLS/SSL):** Enable TLS/SSL encryption for all communication channels between Celery Clients, Workers, and the Message Broker. This will protect task messages from interception and tampering during transit.
    *   **Actionable Recommendation:** Configure RabbitMQ or Redis to enforce TLS/SSL for all client connections. Ensure Celery Client and Worker configurations are updated to use TLS/SSL when connecting to the broker.
*   **Rate Limiting and Resource Quotas:** Implement rate limiting and resource quotas on the Message Broker to prevent DoS attacks and resource exhaustion. Limit the number of connections, message sizes, and queue lengths.
    *   **Actionable Recommendation:** Configure RabbitMQ or Redis to implement connection limits, message size limits, and queue length limits. For RabbitMQ, use policies to set queue limits. For Redis, use `maxmemory` and connection limits.
*   **Regular Security Audits and Updates:** Regularly audit the Message Broker configuration and access controls. Keep the Message Broker software up-to-date with the latest security patches to address known vulnerabilities.
    *   **Actionable Recommendation:** Schedule regular security audits of the Message Broker configuration and access logs. Implement an automated process for patching and updating the Message Broker software and container images.
*   **Network Segmentation:** Isolate the Message Broker within a secure network segment and restrict network access to only authorized components (Celery Clients, Workers, Monitoring System). Use network policies in Kubernetes to enforce network segmentation.
    *   **Actionable Recommendation:** Deploy the Message Broker in a dedicated Kubernetes namespace and use Network Policies to restrict network access to only Celery Worker and Client pods within the cluster.

#### 2.4 Result Backend (e.g., Redis, Database)

**Component Description:** The Result Backend stores task results and states, allowing clients to retrieve task outcomes.

**Security Implications:**

*   **Unauthorized Access to Results:** If the Result Backend is not properly secured with authentication and authorization, unauthorized users or systems could access task results, potentially exposing sensitive data contained within the results.
    *   **Specific Threat:** Task results containing sensitive user data are stored in Redis without authentication, allowing anyone with network access to retrieve them.
*   **Data Breach of Task Results:** If the Result Backend is compromised, attackers could gain access to all stored task results, potentially leading to a significant data breach if results contain sensitive information.
    *   **Specific Threat:** An attacker exploits a vulnerability in Redis or gains unauthorized access to the Redis server and dumps all stored task results, including sensitive data.
*   **Data Integrity Issues:** If the Result Backend is not properly secured, attackers could potentially modify or delete task results, leading to data integrity issues and incorrect application behavior.
    *   **Specific Threat:** An attacker with unauthorized access to the Result Backend modifies task results to manipulate application logic or hide evidence of malicious activity.
*   **Lack of Encryption at Rest:** If task results contain sensitive data and are stored in the Result Backend without encryption at rest, they are vulnerable to exposure if the storage media is compromised or accessed by unauthorized personnel.
    *   **Specific Threat:** Sensitive task results are stored in a database without encryption at rest. If the database storage is compromised (e.g., stolen backup), the sensitive data is exposed.

**Tailored Mitigation Strategies for Result Backend:**

*   **Strong Authentication and Authorization:** Enforce strong authentication for all connections to the Result Backend. Use password-based authentication, TLS client certificates, or other robust mechanisms. Implement access control lists (ACLs) to restrict access to task results based on roles or permissions.
    *   **Actionable Recommendation:** Configure Redis or the database to require strong passwords and enable user-based access control. For Redis, use ACLs to control command access and key access. For databases, use database user roles and permissions to restrict access to result tables.
*   **Encryption at Rest:** Encrypt sensitive data at rest in the Result Backend. Utilize database-level encryption features if available or implement application-level encryption before storing results.
    *   **Actionable Recommendation:** If using Redis as the Result Backend, consider using Redis Enterprise with encryption at rest enabled. If using a database, enable Transparent Data Encryption (TDE) or similar features provided by the database. Alternatively, encrypt sensitive data within the application before storing it in the Result Backend.
*   **Encryption in Transit (TLS/SSL):** Enable TLS/SSL encryption for communication between Celery Workers, Clients, and the Result Backend to protect task results during transit.
    *   **Actionable Recommendation:** Configure Redis or the database to enforce TLS/SSL for all client connections. Ensure Celery Worker and Client configurations are updated to use TLS/SSL when connecting to the Result Backend.
*   **Regular Backups and Secure Storage:** Implement regular backups of the Result Backend data and store backups in a secure location with appropriate access controls and encryption.
    *   **Actionable Recommendation:** Implement automated backups of the Result Backend database or Redis instance. Store backups in a secure cloud storage service with encryption and access control policies.
*   **Network Segmentation:** Isolate the Result Backend within a secure network segment and restrict network access to only authorized components (Celery Workers, Clients, Monitoring System). Use network policies in Kubernetes to enforce network segmentation.
    *   **Actionable Recommendation:** Deploy the Result Backend in a dedicated Kubernetes namespace and use Network Policies to restrict network access to only Celery Worker and Client pods within the cluster.

#### 2.5 Deployment (Kubernetes Cluster)

**Component Description:** Containerized deployment using Docker and Kubernetes in a cloud environment.

**Security Implications:**

*   **Container Image Vulnerabilities:** Vulnerabilities in base images or dependencies within Celery Worker, Message Broker, and Result Backend container images could be exploited to compromise the containers and underlying nodes.
    *   **Specific Threat:** A vulnerable library in the base OS image of the Celery Worker container allows an attacker to gain shell access to the container.
*   **Kubernetes Misconfiguration:** Misconfigurations in Kubernetes cluster settings, RBAC policies, network policies, or secrets management could create security vulnerabilities, allowing unauthorized access or privilege escalation.
    *   **Specific Threat:** Overly permissive RBAC roles in Kubernetes allow a compromised Celery Worker container to access sensitive Kubernetes APIs or resources.
*   **Exposed Kubernetes API Server:** If the Kubernetes API server is exposed to the public internet without proper authentication and authorization, attackers could potentially gain control of the entire cluster.
    *   **Specific Threat:** The Kubernetes API server is accessible from the internet without proper authentication, allowing an attacker to potentially gain cluster administrator privileges.
*   **Insecure Secrets Management:** If Kubernetes Secrets are not properly managed and protected, sensitive data like database passwords or API keys could be exposed to unauthorized containers or users.
    *   **Specific Threat:** Kubernetes Secrets are stored in etcd unencrypted and are accessible to any container within the same namespace, leading to potential credential exposure.

**Tailored Mitigation Strategies for Deployment (Kubernetes Cluster):**

*   **Container Image Scanning and Hardening:** Implement automated container image scanning in the CI/CD pipeline to identify vulnerabilities in container images. Regularly update base images and dependencies. Harden container images by removing unnecessary packages and configurations.
    *   **Actionable Recommendation:** Integrate container image scanning tools (like Trivy, Clair, or Anchore) into the CI/CD pipeline. Use minimal base images (like distroless images) for containers. Implement a process for regularly updating and rebuilding container images to address vulnerabilities.
*   **Kubernetes Security Hardening:** Implement Kubernetes security best practices, including:
    *   **RBAC Hardening:** Follow the principle of least privilege when configuring RBAC roles and permissions. Regularly review and audit RBAC policies.
        *   **Actionable Recommendation:** Implement granular RBAC roles for Celery Workers, Clients, and other components, granting only necessary permissions. Use tools like `kubectl auth can-i` to verify RBAC policies.
    *   **Network Policies:** Implement Network Policies to restrict network traffic between Kubernetes pods and namespaces. Enforce network segmentation and isolation.
        *   **Actionable Recommendation:** Define Network Policies to isolate Celery Worker, Message Broker, and Result Backend namespaces. Restrict inter-namespace traffic and limit external access to services.
    *   **Secrets Management:** Use secure secrets management solutions like Kubernetes Secrets with encryption at rest (using KMS providers like AWS KMS, GCP KMS, Azure Key Vault) or external secret stores like HashiCorp Vault.
        *   **Actionable Recommendation:** Enable encryption at rest for Kubernetes Secrets using a KMS provider. Consider using external secret management solutions like HashiCorp Vault for more advanced secret management features.
    *   **Pod Security Policies/Pod Security Admission:** Enforce Pod Security Policies or Pod Security Admission to restrict container capabilities, privileged containers, and other security-sensitive settings.
        *   **Actionable Recommendation:** Implement Pod Security Admission (or Pod Security Policies if still applicable in your Kubernetes version) to enforce baseline or restricted security profiles for Celery Worker and other pods.
*   **Secure Kubernetes API Server Access:** Secure the Kubernetes API server by:
    *   **Authentication and Authorization:** Enforce strong authentication and authorization for access to the API server. Use RBAC to control access based on roles.
        *   **Actionable Recommendation:** Ensure strong authentication mechanisms are enabled for the Kubernetes API server (e.g., OIDC, SAML). Configure RBAC to restrict access to the API server based on user roles and service accounts.
    *   **Network Restrictions:** Restrict network access to the API server to only authorized networks or IP ranges. Avoid exposing the API server directly to the public internet.
        *   **Actionable Recommendation:** Use firewall rules or cloud provider security groups to restrict network access to the Kubernetes API server. Consider using a bastion host or VPN for administrative access.
*   **Regular Kubernetes Security Audits and Updates:** Regularly audit Kubernetes cluster configurations and security settings. Keep the Kubernetes cluster and node operating systems up-to-date with the latest security patches.
    *   **Actionable Recommendation:** Schedule regular security audits of the Kubernetes cluster configuration and security policies. Implement an automated process for patching and updating the Kubernetes cluster control plane and worker nodes.

#### 2.6 Build (CI/CD Pipeline)

**Component Description:** CI/CD pipeline including build, test, and security scan stages.

**Security Implications:**

*   **Compromised Build Pipeline:** If the CI/CD pipeline is compromised, attackers could inject malicious code into build artifacts (e.g., Docker images), leading to supply chain attacks.
    *   **Specific Threat:** An attacker gains access to the CI/CD system and modifies the build process to inject malware into the Celery Worker container image.
*   **Exposure of Secrets in CI/CD:** Secrets used in the CI/CD pipeline (e.g., API keys, credentials) might be accidentally exposed in build logs or configuration files if not properly managed.
    *   **Specific Threat:** Database credentials used in integration tests are logged in the CI/CD build logs, making them accessible to anyone with access to the logs.
*   **Vulnerable Dependencies Introduced in Build:** The build process might introduce vulnerable dependencies if dependency management is not properly controlled or if dependency scanning is not implemented.
    *   **Specific Threat:** A vulnerable version of a Python library is introduced as a dependency during the build process, creating a vulnerability in the deployed Celery Workers.
*   **Lack of Artifact Verification:** If build artifacts (e.g., Docker images) are not properly verified and signed, it becomes difficult to ensure their integrity and provenance, making it easier for attackers to substitute malicious artifacts.
    *   **Specific Threat:** A malicious actor replaces the legitimate Celery Worker Docker image in the registry with a compromised image, which is then deployed to the Kubernetes cluster.

**Tailored Mitigation Strategies for Build (CI/CD Pipeline):**

*   **Secure CI/CD Pipeline:** Secure the CI/CD pipeline infrastructure and access controls. Implement multi-factor authentication, role-based access control, and audit logging for the CI/CD system.
    *   **Actionable Recommendation:** Enforce MFA for all CI/CD system accounts. Implement granular RBAC for pipeline access and management. Enable audit logging for all CI/CD pipeline activities.
*   **Secure Secret Management in CI/CD:** Utilize secure secret management solutions within the CI/CD pipeline to handle secrets. Avoid storing secrets in code repositories or pipeline configurations. Use masked variables and secret injection mechanisms provided by the CI/CD platform.
    *   **Actionable Recommendation:** Use CI/CD platform's secret management features (e.g., GitHub Actions Secrets, GitLab CI/CD Variables) to securely store and inject credentials. Avoid printing secrets in build logs.
*   **Dependency Scanning in CI/CD:** Integrate dependency scanning tools (SAST/SCA) into the CI/CD pipeline to identify vulnerable dependencies in code and container images during the build process. Fail builds if critical vulnerabilities are detected.
    *   **Actionable Recommendation:** Integrate SAST tools (like Bandit for Python) and SCA tools (like Snyk, OWASP Dependency-Check) into the CI/CD pipeline. Configure these tools to scan code and container images in the build stage and fail the build if vulnerabilities above a certain severity are found.
*   **Artifact Signing and Verification:** Implement artifact signing and verification to ensure the integrity and provenance of build artifacts. Sign Docker images using tools like Docker Content Trust or cosign. Verify signatures before deploying artifacts.
    *   **Actionable Recommendation:** Enable Docker Content Trust or use cosign to sign Docker images in the CI/CD pipeline's publish stage. Implement a verification step in the deployment process to verify the signatures of deployed Docker images.
*   **Immutable Build Environment:** Use immutable build environments for CI/CD pipeline stages to ensure consistency and prevent tampering. Utilize containerized build agents and infrastructure as code to define and manage the build environment.
    *   **Actionable Recommendation:** Use containerized build agents for CI/CD pipeline stages. Define the build environment using Infrastructure as Code (IaC) and version control it. Ensure build environments are immutable and reproducible.

### 3. Specific and Actionable Mitigation Strategies Summary

| Threat Category                  | Specific Threat Example                                                                | Tailored Mitigation Strategy                                                                                                                                                                                                                                                           | Actionable Recommendation Example                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             