## Vulnerability Report: django-webpack-loader

### Vulnerability 1: Cross-Site Scripting (XSS) via Webpack Stats `publicPath`

* Vulnerability Name: Cross-Site Scripting (XSS) via Webpack Stats `publicPath`
* Description:
    1. An attacker can influence the `webpack-stats.json` file, either by directly modifying it if they have write access to the server's filesystem (less likely in typical deployments) or, more realistically, by compromising the Webpack build process to inject malicious content into the `publicPath` field of the generated `webpack-stats.json`.
    2. When a Django template uses the `render_bundle` or `get_files` template tags, the `django-webpack-loader` library reads the `webpack-stats.json` file.
    3. The library extracts the `publicPath` value for each asset from the `webpack-stats.json`.
    4. If the `publicPath` contains malicious JavaScript code, this code is directly embedded into the HTML output generated by the template tags without proper sanitization or escaping.
    5. When a user visits the webpage, the malicious JavaScript code from the `publicPath` is executed in their browser, leading to Cross-Site Scripting.

* Impact:
    - An attacker can execute arbitrary JavaScript code in the context of a user's browser.
    - This can lead to various malicious activities, including:
        - Stealing user session cookies and hijacking user accounts.
        - Defacing the website.
        - Redirecting users to malicious websites.
        - Performing actions on behalf of the user without their consent.
        - Accessing sensitive information accessible to the user.
* Vulnerability Rank: high
* Currently Implemented Mitigations:
    - None. The library directly uses the `publicPath` value from the `webpack-stats.json` without any sanitization.
* Missing Mitigations:
    - The `django-webpack-loader` should sanitize or escape the `publicPath` value retrieved from the `webpack-stats.json` before embedding it into HTML output.
    - Alternatively, the library should avoid directly using `publicPath` for URL construction if it's meant to be used in HTML templates. It should rely on Django's `staticfiles_storage.url` for generating safe static URLs.
* Preconditions:
    - The attacker needs to be able to influence the content of `webpack-stats.json`, specifically the `publicPath` values. This could be achieved by compromising the Webpack build process or gaining write access to the server's filesystem where `webpack-stats.json` is stored.
    - The Django application must be using `render_bundle` or `get_files` template tags to render webpack bundles in templates.

* Source Code Analysis:
    - File: `webpack_loader/utils.py`
    - Function: `get_chunk_url`
    ```python
    def get_chunk_url(chunk_file):
        public_path = chunk_file.get("publicPath")
        if public_path and public_path != "auto":
            return public_path # Directly returns publicPath without sanitization

        # ... staticfiles_storage.url
    ```
    - File: `webpack_loader/utils.py`
    - Function: `get_as_url_to_tag_dict`
    ```python
    def get_as_url_to_tag_dict(bundle_name, extension=None, config='DEFAULT', suffix='', attrs='', is_preload=False):
        # ...
        for chunk in bundle:
            if chunk['name'].endswith(('.js', '.js.gz')):
                result[chunk['url']] = (
                    '<script src="{0}"{2}{1}></script>' # chunk['url'] is used directly in HTML formatting
                ).format(
                    ''.join([chunk['url'], suffix]),
                    attrs,
                    loader.get_integrity_attr(chunk),
                )
            elif chunk['name'].endswith(('.css', '.css.gz')):
                result[chunk['url']] = (
                    '<link href="{0}" rel={2}{3}{1}/>' # chunk['url'] is used directly in HTML formatting
                ).format(
                    ''.join([chunk['url'], suffix]),
                    attrs,
                    '"stylesheet"' if not is_preload else '"preload" as="style"',
                    loader.get_integrity_attr(chunk),
                )
        return result
    ```
    - Visualization:
    ```mermaid
    graph LR
        A[webpack-stats.json] --> B(WebpackLoader.get_assets)
        B --> C(utils.get_chunk_url)
        C --> D{Return publicPath from stats?}
        D -- Yes --> E[Return publicPath directly]
        D -- No --> F[Return staticfiles_storage.url]
        E --> G(utils.get_as_url_to_tag_dict)
        F --> G
        G --> H(Template Tags: render_bundle, get_files)
        H --> I[HTML Output with potentially malicious publicPath]
    ```

* Security Test Case:
    1. Modify the `webpack.config.js` to set `publicPath` to a malicious JavaScript payload. For example:
    ```javascript
    // webpack.config.js
    const path = require("path");
    const webpack = require("webpack");
    const BundleTracker = require("webpack-bundle-tracker");

    module.exports = {
      context: __dirname,
      entry: "./assets/js/index",
      output: {
        path: path.resolve(__dirname, "assets/webpack_bundles/"),
        publicPath: "<script>alert('XSS-Vulnerability')</script>", // Malicious publicPath
        filename: "[name]-[contenthash].js",
      },
      plugins: [
        new BundleTracker({ path: __dirname, filename: "webpack-stats.json" }),
      ],
    };
    ```
    2. Run Webpack to generate the `webpack-stats.json` file with the malicious `publicPath`: `npx webpack --mode=development`
    3. Start the Django development server: `python manage.py runserver`
    4. Access a webpage in the Django application that uses `{% render_bundle 'main' %}` or `{% get_files 'main' %}` in its template.
    5. Observe that an alert box with "XSS-Vulnerability" is displayed in the browser, indicating that the JavaScript code from `publicPath` was executed.