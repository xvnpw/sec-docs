- **Vulnerability Name:** Untrusted Webpack Stats Data Injection (XSS)

- **Description:**  
  The core functionality of the package is to read a JSON “stats file” (typically generated by webpack‐bundle‑tracker) and render asset HTML tags (for example, via the `{% render_bundle %}` template tag). However, values from this JSON—such as the asset “integrity”, “publicPath”, or even the chunk “name”—are used directly when building the HTML. In particular:  
  1. The method `get_integrity_attr` (in `webpack_loader/loaders.py`) formats the integrity attribute directly using data read from the stats file without any sanitization.  
  2. The helper methods (in `webpack_loader/utils.py`) build HTML tag strings (for both `<script>` and `<link>` tags) by concatenating these unsanitized values.  
  3. The final rendered output is marked as safe using `mark_safe` in the template tag without additional escaping.  
  If an attacker can manipulate the stats file—either because the application is configured (via a custom LOADER_CLASS) to load the stats from an external (and possibly untrusted) URL, or because a filesystem misconfiguration permits an attacker to alter the local stats file—the attacker may insert a payload (for example, by setting the integrity field to a string like  
  ```
  sha256" onerror="alert(document.cookie)
  ```  
  ) so that the generated asset tag becomes, for example,  
  ```html
  <script src="/static/webpack_bundles/main.js" integrity="sha256" onerror="alert(document.cookie)" ></script>
  ```  
  which would execute JavaScript in the victim’s browser.

- **Impact:**  
  An attacker who succeeds in injecting malicious payloads into the asset tag attributes can execute arbitrary JavaScript in the context of trusted pages. This may lead to session hijacking, defacement, theft of sensitive information, or further browser compromise. Essentially, the vulnerability enables cross‑site scripting (XSS) that bypasses the usual sanitization provided by Django by relying on unsanitized output from the webpack stats JSON.

- **Vulnerability Rank:** High

- **Currently Implemented Mitigations:**  
  - **Trusted Local Generation:** In the default configuration, the stats file is expected to be generated by a controlled build process (using webpack‐bundle‐tracker) and stored locally with restricted permissions.  
  - **JSON Parsing:** The loader reads the file with `json.load()`, which forces the data to conform to JSON syntax.  

- **Missing Mitigations:**  
  - **Lack of Sanitization/Escaping:** No explicit sanitization or validation is applied to attribute values (such as integrity, publicPath, or chunk names) before they are interpolated into HTML tags.  
  - **Schema Validation:** There is no strict schema validation to ensure that the values from the stats file do not contain characters (e.g. quotation marks or event-handler fragments) that could break out of attribute boundaries.  
  - **Defensive Coding for Custom Loaders:** In cases where a custom loader pulls stats data from an external URL (a scenario explicitly demonstrated in the documentation), no additional security checks are enforced.

- **Preconditions:**  
  - The application must be configured to load the webpack stats from an untrusted or externally controlled source (for example, by specifying a custom LOADER_CLASS that fetches the JSON from a remote URL) or an attacker must have write access to the stats file (via poor filesystem permissions).  
  - The rendered templates (which include the asset tags generated by `render_bundle`) are served to end users.

- **Source Code Analysis:**  
  - In **`webpack_loader/loaders.py`**:  
    - The function `get_integrity_attr` reads the integrity value from each chunk:  
      ```python
      def get_integrity_attr(self, chunk):
          if not self.config.get("INTEGRITY"):
              return " "
          integrity = chunk.get("integrity")
          if not integrity:
              raise WebpackLoaderBadStatsError("...")
          return ' integrity="{}" '.format(integrity.partition(" ")[0])
      ```  
      No escaping or validation is applied to the fetched `integrity` value.  
  - In **`webpack_loader/utils.py`**:  
    - The functions `get_as_url_to_tag_dict` and `get_as_tags` concatenate asset URLs, suffixes, and attributes (including unsanitized integrity attributes) into complete HTML `<script>` or `<link>` tags.  
  - In **`webpack_loader/templatetags/webpack_loader.py`**:  
    - The `{% render_bundle %}` tag calls these utility functions and returns the combined string using `mark_safe`. This bypasses Django’s autoescaping, so any malicious payload present in the stats data is inserted verbatim into the HTML.

- **Security Test Case:**  
  1. **Setup:** Create a test Django instance that uses a custom loader which simulates an external stats file. For example, define a custom loader (similar to the provided ExternalWebpackLoader example) that returns a manipulated stats dictionary. In the manipulated JSON, set an asset’s `integrity` field to a malicious payload such as:  
     ```json
     {
       "status": "done",
       "chunks": { "main": ["main.js"] },
       "assets": {
         "main.js": {
           "name": "main.js",
           "integrity": "sha256\" onerror=\"alert(1)"
         }
       }
     }
     ```
  2. **Configuration:** Configure `WEBPACK_LOADER` in the Django settings to use this custom loader via the `LOADER_CLASS` parameter.  
  3. **Template Rendering:** In a Django template, include the tag `{% render_bundle 'main' %}`.  
  4. **Test Execution:** Use the Django test client or a management command to render this template, then inspect the rendered HTML output.  
  5. **Verification:** Confirm that the output HTML contains a `<script>` tag with an integrity attribute similar to:  
     ```html
     <script src="/static/webpack_bundles/main.js" integrity="sha256" onerror="alert(1)" ></script>
     ```  
     When viewed in a controlled browser test environment, the injected `onerror` attribute should trigger and run JavaScript (for example, an alert), thereby confirming the XSS vulnerability.