# Attack Surface Analysis for aspnet/entityframeworkcore

## Attack Surface: [SQL Injection](./attack_surfaces/sql_injection.md)

**Description:** Exploiting vulnerabilities in SQL query construction to inject malicious SQL code. This allows attackers to bypass application logic and directly interact with the database in unintended ways.
**EF Core Contribution:** EF Core, when used improperly, directly enables SQL injection through:
    * Use of `ExecuteSqlRaw`/`SqlQueryRaw` with unsanitized user input, bypassing EF Core's parameterization.
    * Potential vulnerabilities in database provider implementations when handling specific query constructs generated by EF Core.
**Example:**  Using `context.Database.ExecuteSqlRaw($"SELECT * FROM Users WHERE Username = '{userInput}'")` where `userInput` is directly taken from user input without sanitization. An attacker can inject `'; DROP TABLE Users; --` as `userInput` leading to the execution of `SELECT * FROM Users WHERE Username = ''; DROP TABLE Users; --`.
**Impact:** Complete database compromise, data breach, data modification, data deletion, denial of service, and potential command execution on the database server.
**Risk Severity:** **Critical**
**Mitigation Strategies:**
    * **Mandatory Parameterized Queries:**  Enforce the use of parameterized queries for all dynamic SQL operations using `ExecuteSqlRaw` and `SqlQueryRaw`.
    * **Prioritize LINQ:** Utilize LINQ for data access as EF Core parameterizes LINQ queries by default, significantly reducing SQL injection risks.
    * **Input Validation and Sanitization (Defense in Depth):** While parameterization is primary defense, implement input validation and sanitization as a secondary layer of protection.
    * **Regularly Update EF Core and Providers:** Keep EF Core and database provider packages updated to patch known vulnerabilities.

## Attack Surface: [Mass Assignment](./attack_surfaces/mass_assignment.md)

**Description:**  Exploiting the automatic binding of user input to entity properties to modify properties that should not be directly mutable, leading to unauthorized data changes.
**EF Core Contribution:** EF Core's change tracking and model binding features can inadvertently enable mass assignment if developers directly bind user input to EF Core entities without proper safeguards.
**Example:** An HTTP POST request directly binds to a `Product` entity. An attacker modifies the request to include a `IsDiscounted` property set to `true`, even though this property should only be modified through specific business logic, leading to unauthorized discounts.
**Impact:** Privilege escalation (e.g., modifying user roles), unauthorized data modification, bypassing business logic, data integrity compromise, and potential financial loss.
**Risk Severity:** **High**
**Mitigation Strategies:**
    * **Data Transfer Objects (DTOs) or ViewModels:**  Introduce DTOs or ViewModels as intermediaries between user input and EF Core entities. Map only explicitly allowed properties from DTOs to entities.
    * **Property Whitelisting (Allow Lists):**  Explicitly define and enforce which entity properties can be updated from external sources.
    * **`[Bind]` Attribute with Include/Exclude:** Utilize the `[Bind]` attribute in ASP.NET Core MVC/Razor Pages with `Include` or `Exclude` to control which properties are bound during model binding to entities.
    * **Manual Property Mapping:**  Implement manual mapping of user input to entity properties in code, providing granular control and validation during the mapping process.

## Attack Surface: [Migration Vulnerabilities (Malicious Migrations)](./attack_surfaces/migration_vulnerabilities__malicious_migrations_.md)

**Description:**  Introducing malicious or compromised database schema changes through EF Core Migrations, leading to backdoors, data corruption, or unauthorized access.
**EF Core Contribution:** EF Core Migrations are the mechanism for managing database schema changes. If the migration process is not secured, malicious migrations can be injected and applied via EF Core's migration commands.
**Example:** A compromised developer introduces a migration that adds a new user with administrative privileges directly into the database, bypassing application user management and creating a backdoor. This migration is then applied using `dotnet ef database update`.
**Impact:** Backdoors in the application, unauthorized access to data, data corruption, data loss, and potential complete system compromise.
**Risk Severity:** **High**
**Mitigation Strategies:**
    * **Strict Code Review for Migrations:** Implement mandatory and rigorous code review for all generated migrations before applying them to any environment, especially production.
    * **Secure Development Environment:**  Restrict access to development environments and the migration generation process to authorized personnel only.
    * **Controlled Migration Application Process:** Establish a secure and audited process for applying migrations to production databases, potentially involving separate approval steps and automated scripts with limited access.
    * **Version Control and Integrity Checks for Migrations:** Track migrations in version control and implement integrity checks to ensure migrations have not been tampered with before application.

## Attack Surface: [Interceptor/Event Handler Misuse (Malicious Logic Injection)](./attack_surfaces/interceptorevent_handler_misuse__malicious_logic_injection_.md)

**Description:**  Exploiting EF Core's interceptor and event handler mechanisms to inject malicious logic that can manipulate data, bypass security checks, or leak sensitive information during database operations.
**EF Core Contribution:** EF Core's interceptor and event system allows developers to hook into database operations and modify behavior. If these extension points are not secured or are misused, they can be exploited to inject malicious code within the EF Core pipeline.
**Example:** A malicious interceptor is introduced that modifies the `SaveChangesInterceptor.SavingChangesAsync` method to bypass authorization checks before saving data, allowing unauthorized modifications to persist in the database.
**Impact:** Data manipulation, bypassing security controls, unauthorized access, data leakage, and potential system compromise depending on the malicious logic injected.
**Risk Severity:** **High**
**Mitigation Strategies:**
    * **Thorough Code Review of Interceptors and Event Handlers:** Implement mandatory and rigorous code review for all interceptors and event handlers to ensure they are secure and perform only intended actions.
    * **Principle of Least Privilege for Interceptor/Handler Code:** Restrict access to the code that defines and registers interceptors and event handlers to authorized developers only.
    * **Secure Logging and Error Handling within Interceptors/Handlers:**  Ensure that any logging or error handling within interceptors and handlers is implemented securely to prevent information leakage or further vulnerabilities.
    * **Regular Security Audits of Interceptors/Handlers:** Include interceptors and event handlers as part of regular security audits to identify potential vulnerabilities or misuse.

