## Deep Security Analysis of EF Core

### 1. Objective, Scope, and Methodology

**Objective:**

This deep security analysis aims to provide a thorough evaluation of the security posture of Entity Framework Core (EF Core), focusing on its architecture, components, and development lifecycle. The primary objective is to identify potential security vulnerabilities and weaknesses within EF Core and its ecosystem, and to recommend specific, actionable mitigation strategies to enhance its overall security. This analysis will delve into the security implications of EF Core's design, build process, deployment considerations, and interactions with both applications and database systems.

**Scope:**

The scope of this analysis is limited to the information provided in the "SECURITY DESIGN REVIEW" document, the linked GitHub repository documentation (https://github.com/dotnet/efcore), and general knowledge of ORM security principles.  Specifically, the analysis will cover:

*   **EF Core Library:**  Focus on the core runtime, query generation, data handling, and interaction with database providers.
*   **EF Core Ecosystem:**  Consider the interactions between EF Core, .NET applications, database systems, database providers, client libraries, and the build/deployment pipeline.
*   **Identified Security Controls:** Analyze the effectiveness and completeness of existing, accepted, and recommended security controls outlined in the review.
*   **Security Requirements:** Evaluate how EF Core addresses the defined security requirements (Authentication, Authorization, Input Validation, Cryptography).
*   **C4 Model Diagrams:** Utilize the Context, Container, Deployment, and Build diagrams to structure the analysis and identify component-specific security concerns.

This analysis will *not* include:

*   Detailed source code audit of EF Core.
*   Penetration testing or dynamic analysis of EF Core.
*   Security analysis of specific applications built using EF Core (only EF Core itself).
*   In-depth analysis of the security of underlying database systems or client libraries beyond their interaction with EF Core.

**Methodology:**

This analysis will employ a risk-based approach, following these steps:

1.  **Document Review:**  Thoroughly review the provided "SECURITY DESIGN REVIEW" document, paying close attention to business posture, security posture, security requirements, C4 diagrams, risk assessment, questions, and assumptions.
2.  **Architecture and Data Flow Inference:** Based on the C4 diagrams and descriptions, infer the architecture of EF Core, its key components, and data flow paths. Understand how EF Core processes queries, interacts with databases, and is built and deployed.
3.  **Threat Modeling:** Identify potential threats and vulnerabilities associated with each key component and data flow within the EF Core ecosystem. Consider common ORM security risks, injection vulnerabilities, data integrity issues, and supply chain risks.
4.  **Security Control Analysis:** Evaluate the effectiveness of existing security controls in mitigating identified threats. Assess the completeness of security controls and identify gaps.
5.  **Risk Assessment and Prioritization:**  Analyze the likelihood and impact of identified threats based on the provided risk assessment and business priorities. Prioritize risks based on their potential impact on data access security and .NET application development.
6.  **Mitigation Strategy Development:**  Develop specific, actionable, and EF Core-tailored mitigation strategies for the identified threats and security gaps. Focus on practical recommendations that can be implemented by the EF Core development team or community.
7.  **Documentation and Reporting:**  Document the analysis process, findings, identified threats, and recommended mitigation strategies in a structured report.

### 2. Security Implications of Key Components

Based on the C4 diagrams and descriptions, we can break down the security implications of each key component:

**2.1. Context Diagram Components:**

*   **.NET Developer:**
    *   **Security Implication:** Developers are responsible for using EF Core securely.  **Vulnerabilities can arise from insecure coding practices**, such as writing insecure LINQ queries that could be translated into inefficient or vulnerable SQL, mishandling connection strings, or failing to implement proper application-level authorization.
    *   **Specific Risk:** SQL Injection through poorly constructed dynamic LINQ queries or string interpolation in queries.
    *   **Data Breach Risk:** Exposure of sensitive database credentials if connection strings are hardcoded or improperly managed.

*   **EF Core Library:**
    *   **Security Implication:** As the core ORM, EF Core's security is paramount. **Vulnerabilities within EF Core itself could have widespread impact** on all applications using it.  This includes vulnerabilities in query parsing, translation, execution, data materialization, and change tracking.
    *   **Specific Risk:** SQL Injection vulnerabilities if query parameterization is not correctly implemented in all database providers or if there are bypasses.
    *   **Data Integrity Risk:** Bugs in change tracking or update logic could lead to data corruption or inconsistencies.
    *   **Denial of Service Risk:** Inefficient query generation or resource leaks within EF Core could lead to performance bottlenecks and potential denial of service.

*   **Database Systems (SQL Server, PostgreSQL, MySQL, SQLite, Cosmos DB, Other Databases):**
    *   **Security Implication:** While EF Core aims to abstract database interactions, **the security of the underlying database system is crucial**. EF Core relies on the database for authentication, authorization, and data storage security.
    *   **Specific Risk:**  If database security is misconfigured (weak passwords, open ports, lack of encryption), applications using EF Core will be vulnerable even if EF Core itself is secure.
    *   **Dependency Risk:** Security vulnerabilities in database client libraries or the database server itself can indirectly impact applications using EF Core.

**2.2. Container Diagram Components:**

*   **Application Code:**
    *   **Security Implication:**  Application code using EF Core is the primary point of interaction with the library. **Application-level vulnerabilities can directly impact data security**, even when using a secure ORM.
    *   **Specific Risk:**  Business logic flaws, insecure authentication/authorization implementation within the application, input validation failures *before* data reaches EF Core, and improper handling of exceptions from EF Core.

*   **EF Core Runtime:**
    *   **Security Implication:**  This is the core of EF Core, responsible for query processing and database interaction. **Vulnerabilities here are critical**.
    *   **Specific Risk:**  SQL Injection vulnerabilities in query generation logic, especially when dealing with dynamic queries or raw SQL execution.
    *   **Data Leakage Risk:**  Improper handling of sensitive data in memory or during logging.
    *   **Deserialization Vulnerabilities:**  If EF Core uses deserialization for any configuration or data handling, vulnerabilities could arise if not handled securely.

*   **Database Provider:**
    *   **Security Implication:**  Providers bridge EF Core to specific databases. **Provider-specific vulnerabilities could arise from incorrect translation or handling of database features**.
    *   **Specific Risk:**  Provider-introduced SQL Injection vulnerabilities if database-specific query syntax is not handled correctly.
    *   **Compatibility Issues:**  Security flaws might emerge from interactions between EF Core and specific database provider versions.

*   **Database Client Library:**
    *   **Security Implication:**  Client libraries handle low-level communication with the database. **Vulnerabilities in client libraries can compromise connection security and data integrity**.
    *   **Specific Risk:**  Man-in-the-middle attacks if TLS/SSL is not enforced or properly configured in the client library.
    *   **Buffer Overflow or Memory Corruption:**  Vulnerabilities in the client library's network handling or data parsing.

*   **Database Server:**
    *   **Security Implication:**  The database server is the final repository of data. **Database server security is fundamental**.
    *   **Specific Risk:**  Unauthorized access due to weak authentication, SQL Injection vulnerabilities *within* the database server itself (though EF Core aims to prevent this from the application side), and data breaches if data at rest or in transit is not encrypted.

**2.3. Deployment Diagram Components (Azure Cloud Example):**

*   **Web App Instance:**
    *   **Security Implication:**  The web app instance hosts the application and EF Core runtime. **Web application security best practices are essential**.
    *   **Specific Risk:**  Web application vulnerabilities (OWASP Top 10), insecure configurations of the App Service, and exposure of sensitive data through logs or error pages.

*   **SQL Database Instance:**
    *   **Security Implication:**  Cloud database security is critical. **Misconfigurations in Azure SQL Database can lead to data breaches**.
    *   **Specific Risk:**  Publicly accessible database if firewall rules are not correctly configured, weak database authentication, and lack of encryption for data at rest and in transit.

*   **Azure Load Balancer & Azure Firewall:**
    *   **Security Implication:**  These components provide network security. **Misconfigurations can expose the application and database to network-based attacks**.
    *   **Specific Risk:**  DDoS attacks if load balancer is not properly configured, unauthorized access if firewall rules are too permissive, and network segmentation failures.

**2.4. Build Diagram Components:**

*   **Developer:**
    *   **Security Implication:**  Developers introduce code changes. **Secure coding practices and awareness are crucial**.
    *   **Specific Risk:**  Introduction of vulnerabilities through coding errors, insecure dependencies, or lack of security testing during development.

*   **GitHub Repository:**
    *   **Security Implication:**  The repository hosts the source code. **Repository security is vital for code integrity and preventing unauthorized modifications**.
    *   **Specific Risk:**  Compromised developer accounts leading to malicious code injection, unauthorized access to sensitive information in the repository (e.g., connection strings in configuration files if accidentally committed).

*   **GitHub Actions Workflow:**
    *   **Security Implication:**  Automated workflows build and deploy EF Core. **Workflow security is essential to prevent supply chain attacks**.
    *   **Specific Risk:**  Compromised GitHub Actions secrets leading to unauthorized code changes or malicious package releases, insecure workflow configurations allowing for injection attacks.

*   **Security Scans (SAST, Dependency):**
    *   **Security Implication:**  Security scans identify vulnerabilities. **Effectiveness of these scans is crucial for early vulnerability detection**.
    *   **Specific Risk:**  False negatives from SAST/DAST tools missing real vulnerabilities, outdated dependency vulnerability databases, and lack of remediation processes for identified vulnerabilities.

*   **NuGet Gallery / Artifact Storage:**
    *   **Security Implication:**  NuGet Gallery distributes EF Core packages. **Package integrity and authenticity are paramount to prevent supply chain attacks**.
    *   **Specific Risk:**  Compromised NuGet Gallery account leading to malicious package uploads, lack of package signing allowing for package tampering, and vulnerabilities in the NuGet Gallery infrastructure itself.

### 3. Architecture, Components, and Data Flow Inference

Based on the diagrams and descriptions, we can infer the following architecture, components, and data flow:

**Architecture:** EF Core follows a layered architecture:

1.  **Application Layer (.NET Application):**  Developers write application code using EF Core to interact with data.
2.  **EF Core Runtime Layer:**  The core ORM library that translates LINQ queries, manages entities, and interacts with database providers.
3.  **Database Provider Layer:**  Provider-specific libraries that translate EF Core commands into database-specific commands and interact with database client libraries.
4.  **Database Client Library Layer:**  Database vendor-provided libraries for low-level communication with the database server.
5.  **Database Server Layer:**  The actual database system storing and managing data.

**Components:** Key components include:

*   **DbContext:**  The primary entry point for developers to interact with EF Core, managing database connections and entity sets.
*   **LINQ Provider:**  Translates LINQ queries into database-specific query commands.
*   **Query Compiler:**  Optimizes and compiles LINQ queries.
*   **Change Tracker:**  Tracks changes to entities for persistence.
*   **Database Provider (e.g., SqlServer, Npgsql):**  Handles database-specific interactions.
*   **Database Client Library (e.g., SqlClient, Npgsql client):**  Provides low-level database connectivity.

**Data Flow (Query Execution):**

1.  **.NET Application** constructs a LINQ query using `DbContext`.
2.  **EF Core Runtime (LINQ Provider)** receives the LINQ query.
3.  **EF Core Runtime (Query Compiler)** compiles and optimizes the query.
4.  **EF Core Runtime** translates the LINQ query into a database-specific query (e.g., SQL).
5.  **Database Provider** receives the database-specific query.
6.  **Database Provider** uses the **Database Client Library** to send the query to the **Database Server**.
7.  **Database Server** executes the query and returns results.
8.  **Database Client Library** receives the results.
9.  **Database Provider** processes the results.
10. **EF Core Runtime** materializes the results into .NET objects (entities).
11. **.NET Application** receives the entity objects.

**Data Flow (Build Process):**

1.  **Developer** makes code changes and commits to **GitHub Repository**.
2.  **GitHub Actions Workflow** is triggered.
3.  **Workflow** performs **Build & Test** steps.
4.  **Workflow** runs **Security Scans (SAST, Dependency)**.
5.  **Workflow** **Packages & Publishes Artifacts** to **NuGet Gallery / Artifact Storage**.

### 4. Specific Security Recommendations for EF Core

Based on the analysis and tailored to EF Core, here are specific security recommendations:

1.  **Formal Security Vulnerability Disclosure and Response Process (Recommended & Question 2):**
    *   **Recommendation:**  Establish a clear and publicly documented security vulnerability disclosure policy. This should include:
        *   A dedicated security contact (e.g., security@efcore.dotnet).
        *   Instructions for reporting vulnerabilities securely (e.g., using GitHub Security Advisories or PGP encryption).
        *   Expected response times and communication process.
        *   A public acknowledgement and disclosure process for confirmed vulnerabilities.
    *   **Rationale:**  Encourages responsible disclosure of vulnerabilities by the community and provides a structured way to handle and remediate security issues.

2.  **Regular Security Audits and Penetration Testing (Recommended & Question 3):**
    *   **Recommendation:**  Conduct regular security audits and penetration testing, especially before major releases. Focus on:
        *   Code review by security experts.
        *   Static and dynamic analysis of EF Core runtime and database providers.
        *   Penetration testing to simulate real-world attacks against applications using EF Core.
    *   **Rationale:**  Proactively identifies vulnerabilities that might be missed by automated tools and internal testing, providing an independent security assessment.

3.  **Enhance SAST and DAST Integration in CI/CD (Recommended & Question 1):**
    *   **Recommendation:**  Invest in and enhance the integration of SAST and DAST tools in the GitHub Actions workflow.
        *   **Specify SAST/DAST tools:**  Document which tools are used (e.g., Roslyn Analyzers for SAST, OWASP ZAP for DAST) and their configuration.
        *   **Expand SAST coverage:**  Ensure SAST tools cover a wide range of vulnerability types relevant to ORMs (SQL injection, code injection, etc.).
        *   **Implement DAST for EF Core:**  Develop DAST tests that specifically target EF Core's query generation and data handling logic, potentially by creating test applications that use EF Core in various scenarios.
        *   **Automate vulnerability reporting and tracking:**  Integrate scan results into a vulnerability management system for tracking and remediation.
    *   **Rationale:**  Automated security scans provide continuous vulnerability detection throughout the development lifecycle, reducing the risk of introducing vulnerabilities into releases.

4.  **Strengthen Dependency Vulnerability Scanning and Automated Updates (Recommended & Question 4):**
    *   **Recommendation:**  Improve dependency management and vulnerability scanning:
        *   **Specify dependency scanning tools:** Document the tools used for dependency scanning (e.g., Dependabot, OWASP Dependency-Check).
        *   **Automate dependency updates:** Implement automated dependency update processes (e.g., using Dependabot) to promptly address known vulnerabilities in dependencies.
        *   **Regularly review and update dependencies:**  Periodically review and update dependencies, even if no vulnerabilities are reported, to benefit from security improvements and bug fixes in newer versions.
        *   **Consider supply chain security:**  Evaluate the security posture of upstream dependencies and their maintainers.
    *   **Rationale:**  Reduces the risk of inheriting vulnerabilities from third-party libraries and ensures that EF Core is built on a secure foundation.

5.  **Develop and Publish Security Guidelines and Best Practices for Developers (Recommended & Question 5):**
    *   **Recommendation:**  Create comprehensive security guidelines and best practices documentation specifically for developers using EF Core. This should include:
        *   **Secure Query Construction:**  Guidance on writing secure LINQ queries, emphasizing parameterized queries and avoiding string interpolation for dynamic queries.
        *   **Input Validation:**  Best practices for input validation *before* data reaches EF Core, highlighting the importance of application-level validation.
        *   **Connection String Security:**  Recommendations for secure storage and management of connection strings (e.g., using environment variables, Azure Key Vault, avoiding hardcoding).
        *   **Authorization in EF Core Applications:**  Guidance on implementing authorization logic in applications using EF Core, integrating with database-level permissions and application-specific roles.
        *   **Error Handling and Logging:**  Best practices for secure error handling and logging, avoiding the exposure of sensitive information in logs or error messages.
        *   **Database Security Best Practices:**  Reminders about the importance of securing the underlying database system itself.
    *   **Rationale:**  Empowers developers to build secure applications using EF Core by providing clear and actionable security guidance.

6.  **Enhance Input Validation within EF Core Runtime:**
    *   **Recommendation:**  Explore opportunities to enhance input validation within the EF Core runtime itself, where feasible and without negatively impacting performance.
        *   **Data Type Validation:**  Ensure EF Core enforces data type validation based on entity model definitions to prevent unexpected data types from being processed.
        *   **Consider adding optional sanitization features:**  Investigate adding optional sanitization features for common injection vectors, while ensuring developers understand the limitations and still need to perform application-level validation.
    *   **Rationale:**  Provides an additional layer of defense against input-based vulnerabilities, even if application-level validation is missed.

7.  **Strengthen Testing for Injection Vulnerabilities:**
    *   **Recommendation:**  Expand automated testing to specifically target injection vulnerabilities (SQL Injection, NoSQL Injection, etc.).
        *   **Develop specific test cases:**  Create test cases that simulate various injection attack scenarios, including edge cases and different database providers.
        *   **Utilize fuzzing techniques:**  Consider using fuzzing techniques to automatically generate test inputs and identify potential injection vulnerabilities in query parsing and generation.
        *   **Include negative test cases:**  Ensure tests include negative cases to verify that EF Core correctly handles invalid or malicious inputs.
    *   **Rationale:**  Proactively identifies and prevents injection vulnerabilities, which are a critical security risk for ORMs.

### 5. Actionable Mitigation Strategies Applicable to Identified Threats

| **Identified Threat**                                  | **Actionable Mitigation Strategy**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| :---------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------                                                                                             --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            