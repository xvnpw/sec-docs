# Mitigation Strategies Analysis for nginx/nginx

## Mitigation Strategy: [Disable Server Signature](./mitigation_strategies/disable_server_signature.md)

*   **Description:**
    1.  **Locate `nginx.conf`:** Find the main Nginx configuration file, typically located at `/etc/nginx/nginx.conf` or `/usr/local/nginx/conf/nginx.conf`.
    2.  **Edit `nginx.conf`:** Open the `nginx.conf` file with a text editor (e.g., `nano`, `vim`).
    3.  **Add `server_tokens off;`:** Inside the `http` block, add the directive `server_tokens off;`. If the `http` block doesn't exist, create it.
        ```nginx
        http {
            server_tokens off;
            ...
        }
        ```
    4.  **Save and Exit:** Save the changes to the `nginx.conf` file and exit the text editor.
    5.  **Test Configuration:** Test the Nginx configuration for syntax errors using `nginx -t`.
    6.  **Reload Nginx:** Reload the Nginx configuration to apply the changes without downtime using `nginx -s reload`.
    7.  **Verify:** Use a browser's developer tools or a command-line tool like `curl -I <your_website_url>` to inspect the `Server` header in the HTTP response. It should no longer reveal the Nginx version.
*   **Threats Mitigated:**
    *   Information Disclosure (Nginx Version) - Severity: Low (While not directly exploitable, knowing the Nginx version can help attackers target version-specific vulnerabilities.)
*   **Impact:**
    *   Information Disclosure (Nginx Version) - Low Reduction (Reduces information available to potential attackers, slightly increasing the effort required for targeted attacks.)
*   **Currently Implemented:** Yes, implemented in the base Nginx configuration template used for all server deployments. Configuration managed via Ansible.
*   **Missing Implementation:** N/A - Implemented globally across all Nginx instances.

## Mitigation Strategy: [Disable Directory Listing](./mitigation_strategies/disable_directory_listing.md)

*   **Description:**
    1.  **Identify vulnerable locations:** Determine the `location` blocks in your Nginx configuration (site configuration files in `/etc/nginx/sites-available/` or within `nginx.conf`) that serve static content and where directory listing should be disabled.
    2.  **Add `autoindex off;`:** Within each relevant `location` block, add the directive `autoindex off;`.
        ```nginx
        location /static/ {
            root /var/www/your_app/static/;
            autoindex off; # Disable directory listing
        }
        ```
    3.  **Save and Exit:** Save the changes to the configuration file and exit the text editor.
    4.  **Test Configuration:** Test the Nginx configuration for syntax errors using `nginx -t`.
    5.  **Reload Nginx:** Reload the Nginx configuration to apply the changes using `nginx -s reload`.
    6.  **Verify:** Attempt to access a directory without an index file (e.g., `/static/images/` if there's no `index.html` in `/var/www/your_app/static/images/`). You should receive a 403 Forbidden error instead of a directory listing.
*   **Threats Mitigated:**
    *   Information Disclosure (Directory Contents) - Severity: Medium (Exposing directory contents can reveal sensitive file names, application structure, and potentially configuration files or backups.)
*   **Impact:**
    *   Information Disclosure (Directory Contents) - Medium Reduction (Prevents attackers from easily browsing server directories and discovering potentially sensitive information.)
*   **Currently Implemented:** Partially implemented. `autoindex off;` is generally set in default server blocks, but needs to be explicitly checked and enforced in all `location` blocks serving static content across all applications.
*   **Missing Implementation:** Needs to be reviewed and explicitly set in all `location` blocks serving static content in application-specific Nginx configurations.  A configuration audit script should be created to verify this setting across all configurations.

## Mitigation Strategy: [Secure SSL/TLS Configuration (Nginx Directives)](./mitigation_strategies/secure_ssltls_configuration__nginx_directives_.md)

*   **Description:**
    1.  **Generate Strong TLS Configuration:** Use a tool like Mozilla SSL Configuration Generator (mozilla.github.io/server-side-tls/ssl-config-generator/) to generate a secure Nginx SSL/TLS configuration based on your desired compatibility level (Modern, Intermediate, Old).
    2.  **Locate SSL Configuration:** Identify the server blocks in your Nginx configuration (site configuration files) that handle HTTPS traffic (listen 443 ssl;).
    3.  **Replace Default SSL Settings:** Within each HTTPS server block, replace the default `ssl_protocols`, `ssl_ciphers`, and other SSL-related directives with the configuration generated by the Mozilla SSL Configuration Generator. Ensure you include directives like `ssl_prefer_server_ciphers on;`, `ssl_session_cache`, and `ssl_session_timeout`.
    4.  **Enable HSTS (via Nginx header):** Add the `add_header Strict-Transport-Security` directive within each HTTPS server block to enable HSTS. Consider starting with `max-age=31536000; includeSubDomains; preload` for production, but start with a shorter `max-age` for testing.
        ```nginx
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        ```
    5.  **Disable Insecure Protocols:** Ensure that insecure SSL/TLS protocols like SSLv3 and TLSv1.0 are explicitly disabled in the `ssl_protocols` directive (e.g., `ssl_protocols TLSv1.2 TLSv1.3;`).
    6.  **Test Configuration:** Test the Nginx configuration for syntax errors using `nginx -t`.
    7.  **Reload Nginx:** Reload the Nginx configuration to apply the changes using `nginx -s reload`.
    8.  **Verify:** Use online SSL testing tools (e.g., SSL Labs SSL Test - ssllabs.com/ssltest/) to verify your SSL/TLS configuration and ensure you achieve a good security rating (A or A+).
*   **Threats Mitigated:**
    *   Man-in-the-Middle Attacks - Severity: High (Weak SSL/TLS configuration can allow attackers to intercept and decrypt HTTPS traffic.)
    *   Downgrade Attacks - Severity: Medium (Using outdated protocols can make systems vulnerable to downgrade attacks forcing weaker encryption.)
    *   Information Disclosure (via weak ciphers) - Severity: Medium (Weak ciphers can be more easily cracked, potentially leading to information disclosure.)
*   **Impact:**
    *   Man-in-the-Middle Attacks - High Reduction (Strong SSL/TLS configuration significantly reduces the risk of MITM attacks.)
    *   Downgrade Attacks - Medium Reduction (Disabling weak protocols mitigates downgrade attack risks.)
    *   Information Disclosure (via weak ciphers) - Medium Reduction (Using strong ciphers makes it significantly harder to decrypt traffic.)
*   **Currently Implemented:** Partially implemented. Strong ciphers and protocols are generally configured, but HSTS is not consistently enabled across all applications and `preload` is not universally used. Configuration is managed via Ansible, but application teams sometimes override defaults.
*   **Missing Implementation:** HSTS needs to be enforced and consistently enabled across all HTTPS applications.  `preload` should be considered and implemented where appropriate.  Centralized management of SSL configuration needs to be strengthened to prevent deviations by application teams.

## Mitigation Strategy: [Limit Request Body Size](./mitigation_strategies/limit_request_body_size.md)

*   **Description:**
    1.  **Identify appropriate limit:** Determine a reasonable maximum request body size for your application based on its functionality and expected data uploads. Consider the largest expected file uploads or form submissions.
    2.  **Set `client_max_body_size`:** In your `nginx.conf`, server blocks, or location blocks, set the `client_max_body_size` directive to the determined limit. Specify the size using units like `k` (kilobytes), `m` (megabytes), or `g` (gigabytes).
        ```nginx
        server {
            ...
            client_max_body_size 10m; # Limit to 10MB for this server
            ...
        }
        ```
        or
        ```nginx
        location /upload {
            client_max_body_size 50m; # Limit to 50MB for /upload location
            ...
        }
        ```
    3.  **Save and Exit:** Save the changes to the configuration file and exit the text editor.
    4.  **Test Configuration:** Test the Nginx configuration for syntax errors using `nginx -t`.
    5.  **Reload Nginx:** Reload the Nginx configuration to apply the changes using `nginx -s reload`.
    6.  **Verify:** Attempt to send requests with body sizes exceeding the configured limit. Nginx should return a 413 Request Entity Too Large error.
*   **Threats Mitigated:**
    *   Denial of Service (DoS) via large request bodies - Severity: Medium (Attackers can send excessively large requests to exhaust server resources or cause buffer overflows in upstream applications.)
    *   Buffer Overflow Vulnerabilities (in upstream applications) - Severity: Medium (Large request bodies could potentially trigger buffer overflows in poorly written upstream applications.)
*   **Impact:**
    *   Denial of Service (DoS) via large request bodies - Medium Reduction (Limits the impact of attacks relying on sending extremely large requests.)
    *   Buffer Overflow Vulnerabilities (in upstream applications) - Medium Reduction (Reduces the likelihood of triggering buffer overflows in upstream applications due to excessively large input.)
*   **Currently Implemented:** Partially implemented. Default `client_max_body_size` is set to a reasonable value in global Nginx configuration, but application teams can override it, and it's not consistently reviewed for each application's specific needs.
*   **Missing Implementation:**  `client_max_body_size` needs to be reviewed and appropriately configured for each application and specific locations (like upload endpoints).  A configuration checklist should include verifying this setting for each application deployment.

## Mitigation Strategy: [Connection Limits (`limit_conn` module)](./mitigation_strategies/connection_limits___limit_conn__module_.md)

*   **Description:**
    1.  **Ensure `ngx_http_limit_conn_module` is enabled:** Verify that the `ngx_http_limit_conn_module` is compiled into your Nginx installation (usually enabled by default in standard distributions).
    2.  **Define a limit zone:** In the `http` block of your `nginx.conf`, define a `limit_conn_zone`. This zone will track connection counts based on a key (e.g., `$binary_remote_addr` for IP address).
        ```nginx
        http {
            limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
            ...
        }
        ```
    3.  **Apply limits in server or location blocks:** In the server or location blocks you want to protect, use the `limit_conn` directive to apply the connection limit using the defined zone and specifying the maximum number of connections.
        ```nginx
        server {
            ...
            location / {
                limit_conn conn_limit_per_ip 10; # Limit to 10 connections per IP
                ...
            }
            ...
        }
        ```
    4.  **Optional: Customize error response:** You can customize the error response for exceeding the limit using the `limit_conn_status` directive (default is 503 Service Unavailable).
    5.  **Test Configuration:** Test the Nginx configuration for syntax errors using `nginx -t`.
    6.  **Reload Nginx:** Reload the Nginx configuration to apply the changes using `nginx -s reload`.
    7.  **Verify:** Test by opening more connections than the limit from a single IP address. You should start receiving 503 errors after exceeding the limit.
*   **Threats Mitigated:**
    *   Slowloris Attacks - Severity: High (Connection exhaustion attacks that aim to keep connections open for a long time, exhausting server resources.)
    *   Connection Flooding DoS - Severity: Medium (Basic DoS attacks that attempt to overwhelm the server with a large number of connections.)
*   **Impact:**
    *   Slowloris Attacks - High Reduction (Effectively mitigates slowloris attacks by limiting concurrent connections.)
    *   Connection Flooding DoS - Medium Reduction (Reduces the impact of connection flooding attacks, but may not fully mitigate large-scale distributed attacks.)
*   **Currently Implemented:** Partially implemented. `limit_conn_zone` is defined globally, but `limit_conn` is not consistently applied across all applications and endpoints.  Some critical services have connection limits, but not all.
*   **Missing Implementation:**  `limit_conn` should be strategically applied to protect critical endpoints and services across all applications.  A risk assessment should determine which endpoints are most vulnerable and require connection limits.

## Mitigation Strategy: [Request Rate Limiting (`limit_req` module)](./mitigation_strategies/request_rate_limiting___limit_req__module_.md)

*   **Description:**
    1.  **Ensure `ngx_http_limit_req_module` is enabled:** Verify that the `ngx_http_limit_req_module` is compiled into your Nginx installation (usually enabled by default).
    2.  **Define a rate limit zone:** In the `http` block of your `nginx.conf`, define a `limit_req_zone`. This zone will track request rates based on a key (e.g., `$binary_remote_addr` for IP address) and a rate limit (e.g., `1r/s` for 1 request per second).
        ```nginx
        http {
            limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=1r/s;
            ...
        }
        ```
    3.  **Apply rate limits in server or location blocks:** In the server or location blocks you want to protect, use the `limit_req` directive to apply the rate limit using the defined zone.
        ```nginx
        server {
            ...
            location /login {
                limit_req zone=req_limit_per_ip burst=3 nodelay; # Limit to 1r/s, allow burst of 3
                ...
            }
            ...
        }
        ```
        *   `burst`: Allows a small burst of requests exceeding the rate limit.
        *   `nodelay`: Processes burst requests without delay if within the burst limit.
    4.  **Optional: Customize error response:** You can customize the error response for exceeding the limit using the `limit_req_status` directive (default is 503 Service Unavailable).
    5.  **Test Configuration:** Test the Nginx configuration for syntax errors using `nginx -t`.
    6.  **Reload Nginx:** Reload the Nginx configuration to apply the changes using `nginx -s reload`.
    7.  **Verify:** Test by sending requests faster than the defined rate limit from a single IP address. You should start receiving 503 errors after exceeding the rate.
*   **Threats Mitigated:**
    *   Brute-Force Attacks - Severity: High (Rate limiting login pages and similar endpoints can significantly hinder brute-force password attacks.)
    *   Request Flooding DoS - Severity: Medium (Protects against attacks that flood the server with excessive requests, even if not connection-based.)
    *   API Abuse - Severity: Medium (Limits excessive API calls from a single user or IP, preventing resource exhaustion or abuse.)
*   **Impact:**
    *   Brute-Force Attacks - High Reduction (Significantly reduces the effectiveness of brute-force attacks.)
    *   Request Flooding DoS - Medium Reduction (Mitigates request flooding attacks, but may not fully mitigate large-scale distributed attacks.)
    *   API Abuse - Medium Reduction (Limits API abuse and protects against resource exhaustion.)
*   **Currently Implemented:** Partially implemented. Rate limiting is applied to some critical endpoints like login pages and API gateways, but not consistently across all applications or sensitive endpoints. Configuration is often done on a per-application basis, leading to inconsistencies.
*   **Missing Implementation:**  Rate limiting should be systematically applied to all sensitive endpoints across all applications, including login forms, API endpoints, and resource-intensive operations.  A centralized policy and configuration management for rate limiting is needed to ensure consistency and comprehensive coverage. A security review should identify all endpoints requiring rate limiting.

