## Deep Security Analysis of NGINX

### 1. Objective, Scope, and Methodology

**Objective:**

The objective of this deep analysis is to perform a thorough security assessment of the key components of NGINX, focusing on identifying potential vulnerabilities, weaknesses, and attack vectors.  This analysis aims to provide actionable recommendations to enhance the security posture of NGINX deployments, specifically considering its use as a web server, reverse proxy, load balancer, and cache.  The analysis will cover:

*   **Master Process:**  How it manages worker processes and configuration.
*   **Worker Processes:**  How they handle requests and interact with the system.
*   **Configuration Files:**  The security implications of various directives.
*   **Modules:**  The security impact of commonly used modules.
*   **Caching Mechanism:**  Potential vulnerabilities related to caching.
*   **Networking:**  How NGINX handles network connections and protocols.
*   **Interactions with Upstream Servers:** Security of communication with backend applications.

**Scope:**

This analysis focuses on the open-source NGINX software (https://github.com/nginx/nginx).  It considers the core functionality and commonly used modules.  While NGINX Plus (the commercial offering) is mentioned in the design review, this deep dive concentrates on the open-source version.  The analysis assumes a deployment in a containerized environment (Kubernetes), as outlined in the provided design.  It also considers the build process and deployment aspects.

**Methodology:**

1.  **Codebase and Documentation Review:**  Analyze the NGINX source code (available on GitHub) and official documentation to understand the internal workings and security-relevant features.
2.  **Architecture Inference:**  Based on the codebase and documentation, infer the architecture, components, and data flow within NGINX.  The provided C4 diagrams are used as a starting point.
3.  **Threat Modeling:**  Identify potential threats and attack vectors based on the identified components and their interactions.  This will leverage the STRIDE model (Spoofing, Tampering, Repudiation, Information Disclosure, Denial of Service, Elevation of Privilege).
4.  **Vulnerability Analysis:**  Analyze known vulnerabilities and common misconfigurations associated with NGINX.
5.  **Mitigation Strategy Recommendation:**  Provide specific, actionable mitigation strategies for each identified threat and vulnerability, tailored to the NGINX context and the assumed Kubernetes deployment.

### 2. Security Implications of Key Components

#### 2.1 Master Process

*   **Functionality:**  The master process is responsible for reading and validating the configuration, creating and managing worker processes, binding to sockets, and handling signals (e.g., reload, graceful shutdown).  It runs with higher privileges (typically as root) initially to perform these tasks, but then drops privileges.
*   **Security Implications:**
    *   **Privilege Escalation:**  If the master process is compromised, an attacker could gain root access to the system.  This is a critical concern.
    *   **Configuration File Parsing Vulnerabilities:**  Bugs in the configuration file parser could be exploited to cause a denial of service or potentially execute arbitrary code.
    *   **Signal Handling Issues:**  Improper signal handling could lead to unexpected behavior or vulnerabilities.
*   **Threats:**
    *   **T (Tampering):**  Modification of the configuration file by an unauthorized user.
    *   **E (Elevation of Privilege):**  Exploiting a vulnerability in the master process to gain root access.
    *   **D (Denial of Service):**  Sending crafted signals to the master process to cause it to crash or malfunction.
    *   **I (Information Disclosure):** Reading sensitive data from memory if the master process is compromised.
*   **Mitigation Strategies:**
    *   **Run with Least Privilege:** Ensure the master process drops privileges as soon as possible after startup.  Use a dedicated, unprivileged user for worker processes.
    *   **Strict Configuration File Permissions:**  Restrict access to the configuration file to only authorized users and groups (e.g., `chmod 600` and `chown root:root`).
    *   **Regularly Audit Configuration:**  Review the configuration file for errors and unnecessary directives.
    *   **Input Validation:**  Thoroughly validate all configuration directives to prevent parsing vulnerabilities.  This is primarily a responsibility of the NGINX developers, but configuration validation tools can help.
    *   **Sandboxing:** Utilize system-level sandboxing mechanisms (e.g., seccomp, AppArmor, SELinux) to restrict the master process's capabilities, even if it's compromised.  This is *crucial* for containerized deployments.  Kubernetes security contexts should be used to enforce these restrictions.
    *   **Fuzz Testing:** Regularly fuzz test the configuration parser to identify potential vulnerabilities.

#### 2.2 Worker Processes

*   **Functionality:**  Worker processes handle the actual processing of client requests.  They accept connections, read requests, process them according to the configuration, interact with upstream servers (if configured as a reverse proxy), and return responses.  They run with limited privileges.
*   **Security Implications:**
    *   **Buffer Overflows:**  Vulnerabilities in request handling could lead to buffer overflows, potentially allowing arbitrary code execution.
    *   **HTTP Request Smuggling:**  Exploiting discrepancies in how NGINX and upstream servers interpret HTTP requests.
    *   **Denial of Service:**  Resource exhaustion attacks targeting worker processes.
    *   **Information Disclosure:**  Leaking sensitive information through error messages or improper handling of headers.
*   **Threats:**
    *   **E (Elevation of Privilege):**  Exploiting a vulnerability in a worker process to gain the privileges of that worker (though limited, this could still be used for lateral movement).
    *   **D (Denial of Service):**  Sending a large number of requests or malformed requests to exhaust worker process resources.
    *   **I (Information Disclosure):**  Crafting requests that trigger error messages revealing sensitive information.
    *   **T (Tampering):**  Modifying requests in transit (if not using TLS).
    *   **S (Spoofing):**  Spoofing client IP addresses (mitigated by proper network configuration and `real_ip_header` directive).
*   **Mitigation Strategies:**
    *   **Run with Least Privilege:**  Ensure worker processes run under a dedicated, unprivileged user account.  This is a *fundamental* security practice.
    *   **Sandboxing:**  Use seccomp, AppArmor, or SELinux to restrict the system calls that worker processes can make.  This is *critical* in a containerized environment.  Use Kubernetes `securityContext` to define these restrictions.
    *   **Rate Limiting:**  Use the `limit_req` and `limit_conn` modules to mitigate DoS attacks.  Configure these limits appropriately for your expected traffic patterns.
    *   **Request Validation:**  Use NGINX directives to validate request headers, methods, and URIs.  Reject malformed requests.
    *   **Input Sanitization:**  If passing data to upstream servers, ensure proper sanitization and encoding to prevent injection attacks.
    *   **Error Handling:**  Configure custom error pages to avoid revealing sensitive information.  Use the `error_page` directive.
    *   **Regular Expression Optimization:**  Poorly written regular expressions in configuration files can lead to ReDoS (Regular Expression Denial of Service).  Use tools to analyze and optimize regular expressions.
    *   **HTTP/2 and HTTP/3:** Utilize these newer protocols, which have built-in security improvements over HTTP/1.1.
    *   **WAF:** Employ a Web Application Firewall (ModSecurity or NGINX App Protect) to protect against common web attacks.

#### 2.3 Configuration Files

*   **Functionality:**  NGINX's behavior is controlled by configuration files (typically `nginx.conf` and included files).  These files contain directives that specify how NGINX should handle requests, configure modules, and interact with the system.
*   **Security Implications:**
    *   **Misconfiguration:**  Incorrect or insecure configuration directives can create vulnerabilities.  This is a *major* source of security issues with NGINX.
    *   **Sensitive Data Exposure:**  Storing secrets (e.g., API keys, passwords) directly in configuration files is a significant risk.
    *   **Insecure Defaults:**  Relying on default configurations without reviewing them can lead to vulnerabilities.
*   **Threats:**
    *   **T (Tampering):**  Unauthorized modification of the configuration file.
    *   **I (Information Disclosure):**  Exposure of sensitive information stored in the configuration file.
    *   **D (Denial of Service):**  Misconfiguration leading to resource exhaustion or service instability.
*   **Mitigation Strategies:**
    *   **Principle of Least Privilege:**  Configure NGINX to use only the necessary directives and modules.  Disable unused features.
    *   **Secure Configuration Management:**  Use a version control system (e.g., Git) to track changes to configuration files.  Implement a robust change management process.
    *   **Avoid Hardcoding Secrets:**  Do *not* store secrets directly in configuration files.  Use environment variables, a secrets management system (e.g., HashiCorp Vault, Kubernetes Secrets), or a dedicated configuration management tool.  For Kubernetes, *always* use Secrets objects.
    *   **Regularly Review Configuration:**  Periodically audit the configuration file for security best practices and potential vulnerabilities.  Use automated tools to assist with this.
    *   **Use Include Files:**  Organize configuration files into smaller, manageable units using the `include` directive.  This improves readability and reduces the risk of errors.
    *   **Validate Configuration:**  Use the `nginx -t` command to test the configuration file for syntax errors before reloading NGINX.  Automate this check in your deployment pipeline.
    *   **Specific Directive Hardening:**
        *   `server_tokens off;`:  Disable the display of the NGINX version number in error pages and headers.
        *   `limit_req` and `limit_conn`: Configure rate limiting to mitigate DoS attacks.
        *   `ssl_protocols TLSv1.2 TLSv1.3;`:  Enable only strong TLS protocols.
        *   `ssl_ciphers` (configure with a strong cipher suite).
        *   `add_header Strict-Transport-Security ...;`:  Enable HSTS.
        *   `add_header Content-Security-Policy ...;`:  Implement CSP.
        *   `add_header X-Frame-Options ...;`:  Prevent clickjacking.
        *   `add_header X-Content-Type-Options nosniff;`:  Prevent MIME-sniffing vulnerabilities.
        *   `add_header X-XSS-Protection ...;`:  Enable the browser's XSS filter (though CSP is a more robust solution).
        *   Carefully configure `proxy_pass` directives to avoid open redirects and SSRF vulnerabilities.

#### 2.4 Modules

*   **Functionality:**  NGINX's functionality can be extended through modules.  Modules can be statically compiled into NGINX or dynamically loaded.
*   **Security Implications:**
    *   **Vulnerabilities in Modules:**  Modules can introduce their own vulnerabilities.
    *   **Increased Attack Surface:**  Each enabled module increases the potential attack surface.
    *   **Third-Party Modules:**  Using modules from untrusted sources is a significant risk.
*   **Threats:**
    *   **E (Elevation of Privilege):**  Exploiting a vulnerability in a module to gain higher privileges.
    *   **D (Denial of Service):**  Attacks targeting vulnerabilities in specific modules.
    *   **T (Tampering):**  Modification of module code or configuration.
*   **Mitigation Strategies:**
    *   **Minimize Modules:**  Enable only the modules that are absolutely necessary.  Disable unused modules.
    *   **Use Trusted Sources:**  Obtain modules from official NGINX repositories or trusted third-party sources.
    *   **Verify Module Integrity:**  Verify the integrity of downloaded modules using checksums or digital signatures.
    *   **Regularly Update Modules:**  Keep modules up-to-date to patch vulnerabilities.
    *   **Security Audits of Modules:**  If using custom or third-party modules, conduct security audits to identify potential vulnerabilities.
    *   **ModSecurity (WAF):**  Consider using ModSecurity (or NGINX App Protect) as a WAF.  This provides a significant layer of protection against web application attacks.  However, ModSecurity itself requires careful configuration and rule management.

#### 2.5 Caching Mechanism

*   **Functionality:**  NGINX can cache responses from upstream servers to improve performance.  The cache is stored on disk.
*   **Security Implications:**
    *   **Cache Poisoning:**  An attacker could manipulate the cache to serve malicious content to other users.
    *   **Cache Snooping:**  Unauthorized access to the cache could expose sensitive data.
    *   **Denial of Service:**  Filling the cache with large or numerous files could exhaust disk space.
*   **Threats:**
    *   **T (Tampering):**  Modifying cached content.
    *   **I (Information Disclosure):**  Unauthorized access to cached data.
    *   **D (Denial of Service):**  Cache exhaustion attacks.
*   **Mitigation Strategies:**
    *   **Secure Cache Storage:**  Use appropriate file system permissions to restrict access to the cache directory.
    *   **Cache Key Configuration:**  Carefully configure the cache key to prevent cache poisoning attacks.  Use the `proxy_cache_key` directive.  Consider including headers like `Vary` in the cache key.
    *   **Cache Validation:**  Use the `proxy_cache_valid` directive to specify how long cached responses should be considered valid.
    *   **Cache Bypass:**  Configure NGINX to bypass the cache for sensitive requests (e.g., authenticated user data).  Use the `proxy_cache_bypass` directive.
    *   **Limit Cache Size:**  Use the `proxy_cache_path` directive to limit the maximum size of the cache.
    *   **Regularly Purge Cache:**  Implement a mechanism to regularly purge the cache to remove stale or potentially malicious content.
    *   **HTTP Cache-Control Headers:**  Respect `Cache-Control` and `Expires` headers from upstream servers.

#### 2.6 Networking

*   **Functionality:**  NGINX listens for incoming connections on specified ports and handles network communication using various protocols (e.g., TCP, UDP, HTTP, HTTPS).
*   **Security Implications:**
    *   **Network Attacks:**  NGINX is exposed to various network-level attacks, such as SYN floods, DDoS attacks, and port scanning.
    *   **Man-in-the-Middle Attacks:**  If not using TLS, communication between NGINX and clients or upstream servers can be intercepted and modified.
*   **Threats:**
    *   **D (Denial of Service):**  Network-level DoS attacks.
    *   **T (Tampering):**  Modification of network traffic (if not using TLS).
    *   **I (Information Disclosure):**  Eavesdropping on network traffic (if not using TLS).
*   **Mitigation Strategies:**
    *   **Firewall:**  Use a firewall to restrict access to NGINX to only authorized IP addresses and ports.  This is *essential*.
    *   **TLS/SSL:**  Use TLS/SSL to encrypt communication between NGINX and clients and between NGINX and upstream servers.  Use strong ciphers and protocols.  This is *non-negotiable* for any sensitive data.
    *   **Network Segmentation:**  Isolate NGINX from other systems on the network using network segmentation.  In Kubernetes, use Network Policies.
    *   **Intrusion Detection/Prevention System (IDS/IPS):**  Use an IDS/IPS to detect and prevent network attacks.
    *   **SYN Flood Protection:**  Configure the operating system's TCP stack to mitigate SYN flood attacks.
    *   **Connection Limiting:** Use NGINX's `limit_conn` module to limit the number of concurrent connections from a single IP address.

#### 2.7 Interactions with Upstream Servers

*   **Functionality:**  When configured as a reverse proxy, NGINX forwards requests to upstream servers (e.g., application servers).
*   **Security Implications:**
    *   **SSRF (Server-Side Request Forgery):**  An attacker could exploit NGINX to make requests to internal systems that are not directly accessible from the internet.
    *   **Open Redirects:**  Misconfigured `proxy_pass` directives can lead to open redirect vulnerabilities.
    *   **Insecure Communication:**  If not using TLS, communication between NGINX and upstream servers can be intercepted.
*   **Threats:**
    *   **T (Tampering):**  Modification of requests sent to upstream servers.
    *   **I (Information Disclosure):**  Accessing internal systems through SSRF.
    *   **R (Repudiation):** Difficult to trace actions if communication is not properly logged.
*   **Mitigation Strategies:**
    *   **TLS/SSL:**  Use TLS/SSL to encrypt communication between NGINX and upstream servers.  This is *critical*.
    *   **Input Validation:**  Validate all data received from upstream servers before returning it to clients.
    *   **Careful `proxy_pass` Configuration:**  Avoid using user-supplied input directly in the `proxy_pass` directive.  Use variables and regular expressions carefully to prevent SSRF and open redirect vulnerabilities.
    *   **Network Segmentation:**  Isolate upstream servers from the public internet.  Use a private network or VPN.  In Kubernetes, use Network Policies.
    *   **Health Checks:**  Configure health checks to ensure that NGINX only forwards requests to healthy upstream servers.
    *   **Authentication and Authorization:** If the upstream server requires authentication, configure NGINX to pass the appropriate credentials.

### 3. Actionable Mitigation Strategies (Summary and Kubernetes Specifics)

The following table summarizes the key mitigation strategies, with specific recommendations for Kubernetes deployments:

| Threat Category        | Mitigation Strategy                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     