## Deep Security Analysis of Mongoose Networking Library

### 1. Objective, Scope, and Methodology

**Objective:**

The objective of this deep security analysis is to thoroughly examine the Mongoose networking library's key components, identify potential security vulnerabilities, assess their impact, and propose actionable mitigation strategies.  The analysis will focus on the library's architecture, data flow, and security controls, considering its intended use in embedded systems and resource-constrained environments.  The key components to be analyzed are:

*   **API:**  The public interface exposed to developers.
*   **HTTP Server/Client:**  The HTTP protocol implementation.
*   **MQTT Client:** The MQTT protocol implementation.
*   **WebSocket Server/Client:** The WebSocket protocol implementation.
*   **Core Networking:**  The core socket management and event handling.
*   **TLS/SSL:** The TLS/SSL implementation.
*   **OS Abstraction Layer:** The interface with the underlying operating system.

**Scope:**

This analysis covers the Mongoose library itself, as described in the provided security design review and inferred from its GitHub repository (https://github.com/cesanta/mongoose).  It does *not* cover the security of external systems (e.g., MQTT brokers, web servers) that Mongoose might interact with, nor does it cover application-specific security vulnerabilities in code that *uses* Mongoose.  It focuses on the statically linked deployment model, as chosen in the design review.

**Methodology:**

1.  **Architecture and Data Flow Inference:**  Based on the provided C4 diagrams, documentation, and (hypothetically) examining the codebase, we infer the architecture, data flow, and interactions between components.
2.  **Component-Specific Threat Modeling:** For each key component, we identify potential threats based on common attack patterns, known vulnerabilities in similar software, and the specific context of Mongoose.
3.  **Security Control Analysis:** We evaluate the effectiveness of existing security controls and identify gaps.
4.  **Mitigation Strategy Recommendation:**  For each identified threat, we propose specific, actionable mitigation strategies tailored to Mongoose and its intended use.  These strategies will prioritize practical implementation within the constraints of embedded systems.
5.  **Risk Assessment:** We categorize the severity and likelihood of each threat, considering the mitigating factors.

### 2. Security Implications of Key Components

This section breaks down the security implications of each key component, identifies potential threats, and proposes mitigation strategies.

#### 2.1 API

*   **Security Implications:** The API is the primary entry point for developers, and its design significantly impacts the overall security of applications using Mongoose.  Poorly designed APIs can lead to misuse and vulnerabilities.
*   **Potential Threats:**
    *   **T1: Insecure Default Configurations:**  If the API defaults to insecure settings (e.g., weak TLS configurations, disabled authentication), developers might unknowingly deploy vulnerable applications.
    *   **T2: Lack of Input Validation:**  Insufficient validation of user-provided data passed to API functions can lead to various injection attacks.
    *   **T3: Insufficient Error Handling:**  Poor error handling can leak sensitive information or lead to denial-of-service.
    *   **T4: Lack of Rate Limiting/Throttling:**  The API might be vulnerable to denial-of-service attacks if it doesn't limit the rate of requests.
    *   **T5: Unclear Documentation:** Ambiguous or incomplete documentation can lead to developers misusing the API and introducing vulnerabilities.
*   **Mitigation Strategies:**
    *   **M1 (T1):**  Default to the most secure configurations possible.  Require explicit configuration for less secure options.  Provide clear warnings in the documentation about the security implications of different settings.
    *   **M2 (T2):**  Implement rigorous input validation for all API functions.  Use a whitelist approach whenever possible.  Provide helper functions for common validation tasks (e.g., validating URLs, email addresses).  Sanitize all input before passing it to lower-level components.
    *   **M3 (T3):**  Implement robust error handling that does *not* reveal sensitive information to the client.  Return generic error codes and log detailed error information internally.  Ensure that errors do not leave the system in an unstable or insecure state.
    *   **M4 (T4):**  Implement rate limiting and throttling mechanisms to prevent abuse and denial-of-service attacks.  Allow developers to configure these limits based on their application's needs.
    *   **M5 (T5):**  Provide comprehensive and clear documentation that includes security best practices, examples of secure usage, and explanations of potential risks.

#### 2.2 HTTP Server/Client

*   **Security Implications:**  The HTTP implementation is a complex component with a large attack surface.  Vulnerabilities in HTTP handling can lead to various attacks, including cross-site scripting (XSS), request smuggling, and header injection.
*   **Potential Threats:**
    *   **T6: Cross-Site Scripting (XSS):**  If the server doesn't properly sanitize user-provided data before including it in HTTP responses, attackers can inject malicious scripts.
    *   **T7: HTTP Request Smuggling:**  Ambiguities in parsing HTTP requests can lead to request smuggling attacks, where attackers can bypass security controls or access unauthorized resources.
    *   **T8: Header Injection:**  If the server doesn't properly validate HTTP headers, attackers can inject malicious headers, potentially leading to various attacks, including session hijacking and cache poisoning.
    *   **T9: Denial-of-Service (DoS):**  The server might be vulnerable to DoS attacks targeting specific HTTP features (e.g., slowloris, resource exhaustion).
    *   **T10: Information Disclosure:**  Improperly configured error messages or server headers can reveal sensitive information about the server's configuration or internal workings.
    *   **T11: Unvalidated Redirects and Forwards:**  If redirects and forwards are not validated, attackers can redirect users to malicious sites.
*   **Mitigation Strategies:**
    *   **M6 (T6):**  Strictly validate and sanitize all user-provided data before including it in HTTP responses.  Use output encoding appropriate for the context (e.g., HTML encoding, JavaScript encoding).  Consider implementing a Content Security Policy (CSP) to mitigate the impact of XSS vulnerabilities.
    *   **M7 (T7):**  Adhere strictly to the HTTP specification (RFCs) when parsing requests.  Use a robust and well-tested HTTP parser.  Reject ambiguous requests.  Consider using a web application firewall (WAF) to detect and block request smuggling attempts (although this is often outside the scope of the library itself, it's a relevant consideration for deployment).
    *   **M8 (T8):**  Validate all HTTP headers against a whitelist of allowed headers and their expected formats.  Reject requests with invalid or unexpected headers.
    *   **M9 (T9):**  Implement resource limits and timeouts to prevent DoS attacks.  Consider using techniques like connection limiting, request queuing, and graceful degradation.  Specifically address slowloris attacks by setting appropriate timeouts for reading request headers and bodies.
    *   **M10 (T10):**  Configure the server to return generic error messages that do not reveal sensitive information.  Disable or customize server headers that reveal unnecessary details about the server's software or configuration (e.g., the `Server` header).
    *   **M11 (T11):** Validate all URLs used in redirects and forwards. Ensure they are within the expected domain or a list of allowed domains.

#### 2.3 MQTT Client

*   **Security Implications:**  The MQTT client's security depends on secure authentication with the broker, proper topic authorization, and secure communication (TLS).
*   **Potential Threats:**
    *   **T12: Weak Authentication:**  Using weak or default credentials to connect to the MQTT broker can allow attackers to gain access to the MQTT network.
    *   **T13: Insufficient Authorization:**  If the MQTT broker doesn't enforce proper topic-level authorization, clients might be able to publish or subscribe to topics they shouldn't have access to.
    *   **T14: Man-in-the-Middle (MitM) Attacks:**  Without TLS encryption, attackers can intercept and modify MQTT messages.
    *   **T15: Denial-of-Service (DoS):**  Attackers can flood the MQTT broker with messages, potentially disrupting communication for legitimate clients.
    *   **T16: Malformed MQTT Packets:**  Specially crafted MQTT packets could exploit vulnerabilities in the client's parsing logic.
*   **Mitigation Strategies:**
    *   **M12 (T12):**  Support strong authentication mechanisms, such as username/password authentication with secure password storage (e.g., hashing) and client certificate authentication.  Encourage users to use strong, unique credentials.  Provide mechanisms for securely storing and managing credentials.
    *   **M13 (T13):**  This is primarily the responsibility of the MQTT broker, but the Mongoose client should provide mechanisms for specifying the topics to which the client intends to publish and subscribe.  This information can be used by the broker to enforce authorization policies.
    *   **M14 (T14):**  Require TLS encryption for all MQTT connections by default.  Provide options for configuring TLS settings, including certificate verification and cipher suite selection.
    *   **M15 (T15):**  This is primarily the responsibility of the MQTT broker.  However, the Mongoose client should implement reasonable timeouts and error handling to prevent it from being overwhelmed by a flood of messages.
    *   **M16 (T16):**  Thoroughly validate all incoming MQTT packets according to the MQTT specification.  Use fuzz testing to identify potential vulnerabilities in the packet parsing logic.

#### 2.4 WebSocket Server/Client

*   **Security Implications:**  WebSockets maintain persistent connections, making them a potential target for attacks.  Secure handshakes and proper data handling are crucial.
*   **Potential Threats:**
    *   **T17: Cross-Site WebSocket Hijacking (CSWSH):**  Attackers can hijack WebSocket connections if the server doesn't properly validate the origin of the connection request.
    *   **T18: Man-in-the-Middle (MitM) Attacks:**  Without TLS encryption, attackers can intercept and modify WebSocket messages.
    *   **T19: Denial-of-Service (DoS):**  Attackers can exhaust server resources by opening a large number of WebSocket connections or sending large messages.
    *   **T20: Data Injection:**  If the server doesn't properly validate data received over WebSocket connections, attackers can inject malicious data.
*   **Mitigation Strategies:**
    *   **M17 (T17):**  Strictly validate the `Origin` header during the WebSocket handshake to ensure that the connection request is coming from a trusted origin.  Consider using other cross-origin resource sharing (CORS) mechanisms.
    *   **M18 (T18):**  Require TLS encryption for all WebSocket connections by default.  Provide options for configuring TLS settings.
    *   **M19 (T19):**  Implement resource limits and timeouts to prevent DoS attacks.  Limit the number of concurrent WebSocket connections per client and the maximum message size.
    *   **M20 (T19):**  Strictly validate all data received over WebSocket connections according to the expected format and content.  Use a whitelist approach whenever possible.

#### 2.5 Core Networking

*   **Security Implications:**  This component handles low-level network operations, making it a critical security chokepoint.  Vulnerabilities here can have widespread consequences.
*   **Potential Threats:**
    *   **T21: Buffer Overflows:**  Incorrect handling of network buffers can lead to buffer overflows, potentially allowing attackers to execute arbitrary code.
    *   **T22: Integer Overflows:**  Arithmetic errors in handling network data sizes or lengths can lead to integer overflows, potentially leading to buffer overflows or other vulnerabilities.
    *   **T23: Resource Exhaustion:**  Poor resource management (e.g., not closing sockets properly) can lead to resource exhaustion, causing denial-of-service.
    *   **T24: Timing Attacks:**  Variations in the time it takes to perform certain network operations could leak sensitive information.
*   **Mitigation Strategies:**
    *   **M21 (T21):**  Use safe string and buffer handling functions (e.g., `strlcpy`, `strlcat`, bounded `memcpy`).  Always check buffer boundaries before writing data.  Use dynamic memory allocation carefully and free memory when it's no longer needed. Employ Address Space Layout Randomization (ASLR) and Data Execution Prevention (DEP)/No-eXecute (NX) at the OS level.
    *   **M22 (T22):**  Use safe integer arithmetic functions or libraries that detect and prevent integer overflows.  Carefully check the results of arithmetic operations involving network data sizes or lengths.
    *   **M23 (T23):**  Ensure that all network resources (e.g., sockets, file descriptors) are properly closed when they are no longer needed.  Use resource limits to prevent a single application from consuming excessive resources.
    *   **M24 (T24):**  This is a complex issue that is often difficult to address completely.  However, where possible, try to design network operations to take a constant amount of time, regardless of the input data.  This is particularly important for cryptographic operations.

#### 2.6 TLS/SSL

*   **Security Implications:**  TLS/SSL is crucial for securing network communication.  Proper configuration and use of strong cryptographic algorithms are essential.
*   **Potential Threats:**
    *   **T25: Weak Ciphers/Protocols:**  Using outdated or weak TLS versions or cipher suites can allow attackers to decrypt or tamper with network traffic.
    *   **T26: Certificate Validation Failures:**  If the client doesn't properly validate server certificates, attackers can impersonate legitimate servers (MitM attacks).
    *   **T27: Key Management Issues:**  If cryptographic keys are not generated, stored, and managed securely, attackers can compromise the security of TLS.
    *   **T28: Side-Channel Attacks:**  Vulnerabilities in the TLS implementation itself (e.g., timing attacks, padding oracle attacks) could allow attackers to recover cryptographic keys.
*   **Mitigation Strategies:**
    *   **M25 (T25):**  Support only up-to-date TLS versions (TLS 1.2 and 1.3) and strong cipher suites.  Provide options for configuring TLS settings, but default to secure configurations.  Regularly update the list of supported cipher suites to remove weak or deprecated options.
    *   **M26 (T26):**  Implement strict certificate validation, including checking the certificate's validity period, revocation status (using OCSP or CRLs), and trust chain.  Reject connections with invalid or untrusted certificates.  Provide clear error messages to the user when certificate validation fails.
    *   **M27 (T27):**  Use a secure random number generator (RNG) to generate cryptographic keys.  Store keys securely, protecting them from unauthorized access.  Follow best practices for key management, including key rotation and secure key exchange. If possible, integrate with hardware security modules (HSMs) for key storage and management.
    *   **M28 (T28):**  Use a well-vetted and regularly updated TLS library (e.g., mbed TLS, OpenSSL).  Stay informed about known vulnerabilities in TLS implementations and apply patches promptly.  Consider using constant-time cryptographic implementations to mitigate timing attacks.

#### 2.7 OS Abstraction Layer

*   **Security Implications:**  This layer interacts directly with the operating system, making it a potential source of vulnerabilities if not implemented securely.
*   **Potential Threats:**
    *   **T29: Platform-Specific Vulnerabilities:**  Exploiting vulnerabilities in the underlying operating system's networking stack.
    *   **T30: Insecure System Calls:**  Using system calls insecurely can lead to various vulnerabilities, including privilege escalation and information disclosure.
    *   **T31: Improper Handling of OS Resources:**  Incorrectly managing OS resources (e.g., file descriptors, memory) can lead to resource exhaustion or other vulnerabilities.
*   **Mitigation Strategies:**
    *   **M29 (T29):**  Keep the underlying operating system and its networking stack up-to-date with the latest security patches.  Use a minimal set of OS features to reduce the attack surface.
    *   **M30 (T30):**  Use system calls carefully and securely, following best practices for each platform.  Validate all input to system calls.  Avoid using deprecated or insecure system calls.
    *   **M31 (T31):**  Properly manage OS resources, ensuring that they are allocated and released correctly.  Use resource limits to prevent a single application from consuming excessive resources.

### 3. Risk Assessment

The following table summarizes the identified threats, their likelihood, impact, and overall risk level, considering the proposed mitigation strategies.

| Threat ID | Threat Description                                      | Likelihood | Impact | Risk Level | Mitigations                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   